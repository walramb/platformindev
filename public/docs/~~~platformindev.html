<!DOCTYPE html>

<html>
<head>
  <title>~~~platformindev.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="animtest.html">
                animtest.coffee
              </a>
            
              
              <a class="source" href="collision.html">
                collision.coffee
              </a>
            
              
              <a class="source" href="geometry.html">
                geometry.coffee
              </a>
            
              
              <a class="source" href="geometry.html">
                geometry.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.coffee
              </a>
            
              
              <a class="source" href="keyboarddisplay.html">
                keyboarddisplay.coffee
              </a>
            
              
              <a class="source" href="keycodes.html">
                keycodes.js
              </a>
            
              
              <a class="source" href="pixelprocessing.html">
                pixelprocessing.coffee
              </a>
            
              
              <a class="source" href="platform.html">
                platform.coffee
              </a>
            
              
              <a class="source" href="platformindev.html">
                platformindev.coffee
              </a>
            
              
              <a class="source" href="quadtree.html">
                quadtree.coffee
              </a>
            
              
              <a class="source" href="~~~platformindev.html">
                ~~~platformindev.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>~~~platformindev.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>video gem
dependencies:
jQuery
Underscore.js
pixi.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
THISFILE = <span class="hljs-string">"src/platformindev.coffee"</span>

settings=
  drawsprites : <span class="hljs-literal">true</span>
  slowmo : <span class="hljs-literal">false</span>
  altcostume : <span class="hljs-literal">true</span>
  beanmode : <span class="hljs-literal">false</span>
  muted : <span class="hljs-literal">true</span>
  paused : <span class="hljs-literal">false</span>
  volume : <span class="hljs-number">0.2</span>
  decemberween : <span class="hljs-literal">false</span>
  hat : <span class="hljs-literal">false</span>

settings.scale=<span class="hljs-number">1</span>
screensize = <span class="hljs-keyword">new</span> V2d <span class="hljs-number">64</span>*<span class="hljs-number">16</span>*settings.scale, <span class="hljs-number">64</span>*<span class="hljs-number">9</span>*settings.scale

sourcebaseurl = <span class="hljs-string">"./sprites/"</span>
audiobaseurl=<span class="hljs-string">"./audio/"</span>

mafs.randfloat = <span class="hljs-function">-&gt;</span> -<span class="hljs-number">1</span>+Math.random()*<span class="hljs-number">2</span>
mafs.randvec = <span class="hljs-function">-&gt;</span> V mafs.randfloat(), mafs.randfloat()
mafs.randint = <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.floor Math.random()*max
mafs.randelem = <span class="hljs-function"><span class="hljs-params">(arr)</span> -&gt;</span> arr[mafs.randint(arr.length)]
mafs.degstorads = <span class="hljs-function"><span class="hljs-params">(degs)</span> -&gt;</span> degs*Math.PI/<span class="hljs-number">180</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Line2d</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@p1</span>,<span class="hljs-property">@p2</span>)</span> -&gt;</span>

<span class="hljs-attribute">Line2d</span>::lineintersect = <span class="hljs-function"><span class="hljs-params">( lineb )</span> -&gt;</span>
  linea = @
  p = linea.p1
  r = linea.p2.vsub p
  q = lineb.p1
  s = lineb.p2.vsub q
  t = q.vsub(p).cross2d(s) / r.cross2d s
  u = q.vsub(p).cross2d(r) / r.cross2d s
  <span class="hljs-keyword">if</span> t &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> t &gt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> u &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> u &gt;= <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> p.vadd r.nmul t
  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>based on an implementation by metamal on stackoverflow</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">HitboxRayIntersect</span> = <span class="hljs-params">( rect, line )</span> -&gt;</span>
  minx = line.p1.x
  maxx = line.p2.x
  <span class="hljs-keyword">if</span> line.p1.x &gt; line.p2.x
    minx=line.p2.x
    maxx=line.p1.x
  maxx = Math.min maxx, rect.bottomright.x
  minx = Math.max minx, rect.topleft.x
  <span class="hljs-keyword">if</span> minx &gt; maxx
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  miny = line.p1.y
  maxy = line.p2.y
  dx = line.p2.x-line.p1.x</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>tiny wiggle room to account for floating point errors</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> Math.abs(dx) &gt; <span class="hljs-number">0.0000001</span>
    a=(line.p2.y-line.p1.y)/dx
    b=line.p1.y-a*line.p1.x
  miny=a*minx+b
  maxy=a*maxx+b
  <span class="hljs-keyword">if</span> miny &gt; maxy
    tmp=maxy
    maxy = miny
    miny = tmp
  maxy=Math.min maxy, rect.bottomright.y
  miny=Math.max miny, rect.topleft.y
  <span class="hljs-keyword">if</span> miny&gt;maxy
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
<span class="hljs-function">
<span class="hljs-title">pointlisttoedges</span> = <span class="hljs-params">( parr )</span> -&gt;</span>
  edges=[]
  prev = parr[parr.length-<span class="hljs-number">1</span>]
  <span class="hljs-keyword">for</span> curr,i <span class="hljs-keyword">in</span> parr
    edges.push <span class="hljs-keyword">new</span> Line2d prev,curr
    prev=curr
  <span class="hljs-keyword">return</span> edges

body = $ <span class="hljs-string">"body"</span>
<span class="hljs-function">
<span class="hljs-title">V</span> = <span class="hljs-params">(x=<span class="hljs-number">0</span>,y=<span class="hljs-number">0</span>)</span> -&gt;</span> <span class="hljs-keyword">new</span> V2d x,y
<span class="hljs-function"><span class="hljs-title">PP</span> = <span class="hljs-params">(x,y)</span> -&gt;</span> <span class="hljs-keyword">new</span> PIXI.Point x,y
<span class="hljs-function"><span class="hljs-title">VTOPP</span> = <span class="hljs-params">(v)</span> -&gt;</span> PP v.x, v.y
<span class="hljs-function">
<span class="hljs-title">playsound</span> = <span class="hljs-params">( src )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> settings.muted <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  snd = <span class="hljs-keyword">new</span> Audio audiobaseurl+src
  snd.volume = settings.volume
  snd.play()

parentstage = <span class="hljs-keyword">new</span> PIXI.Stage <span class="hljs-number">0x66FF99</span>

stage = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer
parentstage.addChild stage
<span class="hljs-function">
<span class="hljs-title">resetstage</span> = -&gt;</span>
  parentstage.removeChild stage
  stage = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer
  parentstage.addChild stage


hitboxlayer = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer
stage.addChild hitboxlayer
renderer = PIXI.autoDetectRenderer screensize.x, screensize.y

pausescreen = <span class="hljs-keyword">new</span> PIXI.Graphics()
pausescreen.beginFill <span class="hljs-number">0x000000</span>
pausescreen.drawRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, screensize.x, screensize.y
pausescreen.alpha = <span class="hljs-number">0.5</span>

pausetext = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"PAUSED"</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"32px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>, <span class="hljs-attribute">strokeThickness</span>: <span class="hljs-number">8</span>, <span class="hljs-attribute">stroke</span>:<span class="hljs-string">'red'</span>}
pausetext.position = VTOPP screensize.ndiv <span class="hljs-number">2</span>
pausetext.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
pausescreen.addChild pausetext

pausetext = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"GO GET SOME SNACKS\nPERHAPS A CARBONATED SODA"</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"16px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>}
pausetext.position = VTOPP screensize.ndiv(<span class="hljs-number">2</span>).vadd(V(<span class="hljs-number">0</span>,<span class="hljs-number">64</span>))
pausetext.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>
pausescreen.addChild pausetext

bogglescreen = <span class="hljs-keyword">new</span> PIXI.Graphics()
bogglescreen.beginFill <span class="hljs-number">0xFF00FF</span>
bogglescreen.drawRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, screensize.x, screensize.y
bogglescreen.alpha = <span class="hljs-number">0.5</span>
tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-string">'smooch.png'</span>
bogsprite = <span class="hljs-keyword">new</span> PIXI.Sprite tex
bogsprite.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
bogsprite.position = VTOPP screensize.ndiv <span class="hljs-number">2</span>
bogsprite.scale = PP <span class="hljs-number">2</span>, <span class="hljs-number">2</span>
text = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"""
  wow a secret
  warning, the following sprite is EXTREMELY CANON and EXTREMELY SEXY,
  childrens avert your eyes
  """</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"16px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>}
text.position = VTOPP screensize.ndiv(<span class="hljs-number">2</span>).vadd(V(<span class="hljs-number">0</span>,-<span class="hljs-number">128</span>))
text.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>
bogglescreen.addChild text
bogglescreen.addChild bogsprite


tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-string">'titleplaceholder.png'</span>
titlescreen = <span class="hljs-keyword">new</span> PIXI.Sprite tex

body.append renderer.view


B_MASKING = <span class="hljs-literal">false</span>

OTHERCHAR_SUBSCREEN =
  <span class="hljs-attribute">init</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@size</span>= V <span class="hljs-number">300</span>, <span class="hljs-number">200</span>
    <span class="hljs-property">@screenpos</span> = V <span class="hljs-number">64</span>, <span class="hljs-number">64</span>
    <span class="hljs-property">@subscreen</span>= <span class="hljs-keyword">new</span> PIXI.RenderTexture <span class="hljs-property">@size</span>.x, <span class="hljs-property">@size</span>.y
    <span class="hljs-property">@subsprite</span>= <span class="hljs-keyword">new</span> PIXI.Sprite <span class="hljs-property">@subscreen</span>
    parentstage.addChild <span class="hljs-property">@subsprite</span>
    <span class="hljs-keyword">if</span> B_MASKING
      <span class="hljs-property">@mask</span> = <span class="hljs-keyword">new</span> PIXI.Graphics()
      parentstage.addChild <span class="hljs-property">@mask</span>
  <span class="hljs-attribute">maskupdate</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@mask</span>.clear()
    <span class="hljs-property">@mask</span>.beginFill( <span class="hljs-number">0x000000</span>, <span class="hljs-number">0.9</span> )
    <span class="hljs-property">@mask</span>.moveTo <span class="hljs-property">@screenpos</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-number">32</span>
    <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x+<span class="hljs-property">@size</span>.x, <span class="hljs-property">@screenpos</span>.y
    <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x+<span class="hljs-property">@size</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-property">@size</span>.y-<span class="hljs-number">32</span>
    <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-property">@size</span>.y
    <span class="hljs-property">@mask</span>.endFill()
OTHERCHAR_SUBSCREEN.init()
scale = <span class="hljs-number">1</span>

tmpstage = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer()
tmpinnerstage = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer()
tmpstage.addChild tmpinnerstage

OTHERCHAR_SUBSCREEN.subscreenadjust = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@subsprite</span>.position = VTOPP <span class="hljs-property">@screenpos</span>
  hero=getotherhero()
  subscreencentercam = hero.pos.nmul -scale
  subscreencentercam = subscreencentercam.vadd <span class="hljs-property">@size</span>.ndiv <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>hacky but remove the screen from the stage before rendering
so it doesnt render on top of itself as a black screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parentstage.removeChild <span class="hljs-property">@subsprite</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>tmpinnerstage.position = VTOPP subscreencentercam
tmpinnerstage.addChild stage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  oldpos=stage.position
  stage.position = VTOPP subscreencentercam
  <span class="hljs-property">@subscreen</span>.render parentstage
  stage.position=oldpos
  parentstage.addChild <span class="hljs-property">@subsprite</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>parentstage.addChild @mask</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> B_MASKING
    <span class="hljs-property">@maskupdate</span>()
    <span class="hljs-property">@subsprite</span>.mask = <span class="hljs-property">@mask</span>
<span class="hljs-function">
<span class="hljs-title">animate</span> = -&gt;</span>
  cam=cameraoffset().nmul -scale
  stage.position = VTOPP cam
  stage.scale = PP scale, scale
  renderer.render parentstage
  OTHERCHAR_SUBSCREEN.subscreenadjust()

chievs={}
<span class="hljs-function">
<span class="hljs-title">achieve</span> = <span class="hljs-params">(title)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> chievs[title].gotten? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  chievs[title].gotten = <span class="hljs-literal">true</span>
  makechievbox chievs[title].pic, mafs.randelem chievs[title].text

bogimg = xmltag <span class="hljs-string">'img'</span>, <span class="hljs-attribute">src</span>: sourcebaseurl+<span class="hljs-string">'boggle.png'</span>

chievs.fall = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"lovelyfall.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"Fractured spine"</span>, <span class="hljs-string">"Faceplant"</span>, <span class="hljs-string">"Dats gotta hoit"</span>, <span class="hljs-string">"OW FUCK"</span>,
  <span class="hljs-string">"pomf =3"</span>, <span class="hljs-string">"Broken legs"</span>, <span class="hljs-string">"Have a nice trip"</span>, <span class="hljs-string">"Ow my organs"</span>, <span class="hljs-string">"Shattered pelvis"</span>, <span class="hljs-string">"Bugsplat"</span> ]
chievs.kick = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"jelly.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"3 points field goal"</span>, <span class="hljs-string">"Into the dunklesphere"</span>,
  <span class="hljs-string">"Blasting off again"</span>, <span class="hljs-string">"pow zoom straight to the moon"</span> ]
chievs.boggle = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"boggle.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"Buggy the boggle champ"</span>, <span class="hljs-string">"Bushboggler 2013"</span>, <span class="hljs-string">"Boggle that bush"</span>,
  <span class="hljs-string">"Collosal waste of time"</span>, <span class="hljs-string">"Boggle 2: Electric boggleoo"</span>, <span class="hljs-string">"Buggy bushboggle"</span>,
  <span class="hljs-string">"excuse me wtf are you doing"</span>, <span class="hljs-string">"Bush it, bush it real good"</span>, <span class="hljs-string">"Fondly regard flora"</span>,
  <span class="hljs-string">"&amp;lt;chievo title unavailable due to trademark infringement&amp;gt;"</span>, <span class="hljs-string">"Returning a bug to its natural habitat"</span>,
  <span class="hljs-string">"Bush it to the limit"</span>, <span class="hljs-string">"Live Free or Boggle Hard"</span>, <span class="hljs-string">"Identifying bushes, accurate results with simple tools"</span>,
  <span class="hljs-string">"Bugtester"</span>, <span class="hljs-string">"A proper lady (bug)"</span>, <span class="hljs-string">"Stupid achievement title"</span>, <span class="hljs-string">"The daily boggle"</span>, bogimg+bogimg+bogimg ]
chievs.murder = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"lovelyshorter.png"</span>, <span class="hljs-attribute">text</span>: [ <span class="hljs-string">"This isn't brave, it's murder"</span>, <span class="hljs-string">"Jellycide"</span> ]
chievs.target = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"target.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"there's no achievement for this"</span>, <span class="hljs-string">"\"Pow, motherfucker, pow\" -socrates"</span>,
  <span class="hljs-string">"Expect more. Pay less."</span>, <span class="hljs-string">"You're supposed to use arrows you dingus"</span> ]
chievs.start = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"crown.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"wow u started playin the game, congrats"</span>, <span class="hljs-string">"walking to the right"</span>,
  <span class="hljs-string">"chievo modern gaming edition"</span>, <span class="hljs-string">"baby's first achievement"</span> ]
<span class="hljs-function">

<span class="hljs-title">makechievbox</span> = <span class="hljs-params">( src, text )</span> -&gt;</span>
  style=<span class="hljs-string">"style='display: inline-block; margin-left: 16px'"</span>
  body.append chievbox = $(
    <span class="hljs-string">"&lt;div class=chievbox&gt;&lt;span <span class="hljs-subst">#{style}</span>&gt;&lt;b&gt;ACHIEVEMENT UNLOCKED&lt;/b&gt;&lt;br/&gt;<span class="hljs-subst">#{text}</span>&lt;/span&gt;&lt;/div&gt;"</span>)
  chievbox.prepend pic=$ xmltag <span class="hljs-string">'img'</span>, <span class="hljs-attribute">src</span>: sourcebaseurl+src
  chievbox.animate( <span class="hljs-attribute">top</span>: <span class="hljs-string">'32px'</span> ).delay <span class="hljs-number">4000</span>
  chievbox.animate( { <span class="hljs-attribute">top</span>: <span class="hljs-string">'-100px'</span>}, { <span class="hljs-attribute">queue</span>: <span class="hljs-literal">true</span> } ).delay <span class="hljs-number">2000</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@pos</span>=V()
<span class="hljs-attribute">Renderable</span>::hassprite = <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">typeof</span> @._pixisprite <span class="hljs-keyword">isnt</span> <span class="hljs-string">"undefined"</span>
<span class="hljs-attribute">Renderable</span>::removesprite = <span class="hljs-function">-&gt;</span> removesprite @
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericSprite</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V(), <span class="hljs-property">@src</span> )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
    flip=<span class="hljs-keyword">not</span> <span class="hljs-property">@facingleft</span>
    box= <span class="hljs-property">@gethitbox</span>()
    pos=relativetobox box, anchor
    drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor
<span class="hljs-attribute">GenericSprite</span>::cleanup = <span class="hljs-function">-&gt;</span>
  removesprite @</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>LOAD PROPERTIES FROM AN OBJECT
for example to initialize from .json level data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">GenericSprite</span>::load = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> obj.pos?
    _.extend <span class="hljs-property">@pos</span>, obj.pos

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span> = <span class="hljs-string">"hat.png"</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    <span class="hljs-property">@parent</span> = ladybug
<span class="hljs-attribute">Hat</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@parent</span>.vel
  <span class="hljs-property">@pos</span> = relativetobox <span class="hljs-property">@parent</span>.gethitbox() , V(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>)
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>

_DEFAULTHITBOXSIZE = V <span class="hljs-number">32</span>, <span class="hljs-number">32</span>
<span class="hljs-attribute">GenericSprite</span>::gethitbox = <span class="hljs-function">-&gt;</span>
  size=<span class="hljs-property">@size</span> <span class="hljs-keyword">or</span> _DEFAULTHITBOXSIZE
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>@hitboxcache ?= makebox @pos, size, anchor
fuck it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@hitboxcache</span> = makebox <span class="hljs-property">@pos</span>, size, anchor
  <span class="hljs-property">@hitboxcache</span>
<span class="hljs-attribute">GenericSprite</span>::updatehitbox = <span class="hljs-function">-&gt;</span>
  size=<span class="hljs-property">@size</span> <span class="hljs-keyword">or</span> _DEFAULTHITBOXSIZE
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@hitboxcache</span>?
    [ x, y, w, h ] = fixbox <span class="hljs-property">@pos</span>, size, anchor
    <span class="hljs-property">@hitboxcache</span>.x = x
    <span class="hljs-property">@hitboxcache</span>.y = y
    <span class="hljs-property">@hitboxcache</span>.w = w
    <span class="hljs-property">@hitboxcache</span>.h = h
  <span class="hljs-keyword">return</span> <span class="hljs-property">@hitboxcache</span>
<span class="hljs-function">
<span class="hljs-title">fixbox</span> = <span class="hljs-params">(position, dimensions, anchor)</span> -&gt;</span>
  truepos = position.vsub dimensions.vmul anchor
  <span class="hljs-keyword">return</span> [ truepos.x, truepos.y, dimensions.x, dimensions.y ]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Target</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'target.png'</span>
    <span class="hljs-property">@lifetime</span>=-<span class="hljs-number">1</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
      <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
    <span class="hljs-keyword">if</span> otherent.attacktimeout? <span class="hljs-keyword">and</span> otherent.attacktimeout &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-attribute">gethitby</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@broken</span>
      <span class="hljs-property">@broken</span>=<span class="hljs-literal">true</span>
      <span class="hljs-property">@src</span> = <span class="hljs-string">'shatteredtarget.png'</span>
      <span class="hljs-property">@vel</span> = otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
      <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Jelly</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'jelly.png'</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Jelly
      <span class="hljs-property">@vel</span>.x = (<span class="hljs-property">@vel</span>.x+otherent.vel.x)/<span class="hljs-number">2</span>
      <span class="hljs-property">@pos</span>.x+=mafs.randfloat()*<span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
      <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>player bounce</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady <span class="hljs-keyword">and</span> otherent.vel.y &gt; <span class="hljs-number">0</span>
      otherent.vel.y *= -<span class="hljs-number">2</span>
    timeout=otherent.attacktimeout
    <span class="hljs-keyword">if</span> timeout? <span class="hljs-keyword">and</span> timeout &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-attribute">gethitby</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>.y += otherent.vel.y
    dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">4</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    flip = tickno%<span class="hljs-number">10</span>&lt;<span class="hljs-number">5</span>
    anchor = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    pos=relativetobox(<span class="hljs-property">@gethitbox</span>(),anchor)
    drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor


<span class="hljs-attribute">Jelly</span>::size = V(<span class="hljs-number">32</span>,<span class="hljs-number">16</span>)
<span class="hljs-attribute">Jelly</span>::anchor = V(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)
<span class="hljs-function">
<span class="hljs-title">entitycount</span> = <span class="hljs-params">( classtype )</span> -&gt;</span>
  ents = WORLD.spritelayer.filter (sprite) -&gt; sprite <span class="hljs-keyword">instanceof</span> classtype
  <span class="hljs-keyword">return</span> ents.length

<span class="hljs-attribute">GenericSprite</span>::gravitate = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y++
<span class="hljs-attribute">Jelly</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@jiggle</span>()
    <span class="hljs-property">@pos</span>.y--

<span class="hljs-attribute">Jelly</span>::jiggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.x*=<span class="hljs-number">9</span>/<span class="hljs-number">10</span>
  <span class="hljs-keyword">if</span> Math.random()*<span class="hljs-number">100</span>&lt;<span class="hljs-number">50</span>
    <span class="hljs-property">@vel</span>.y = -Math.random()*<span class="hljs-number">4</span>
    <span class="hljs-property">@vel</span>.x += mafs.randfloat()*<span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fence</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@anchor</span>=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>,<span class="hljs-number">1</span>
<span class="hljs-attribute">Fence</span>::render = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pickup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Jelly</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"energy1.png"</span>
<span class="hljs-attribute">Pickup</span>::jiggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-comment">#noop</span>
<span class="hljs-attribute">Pickup</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
    <span class="hljs-property">@pickedup</span> otherent
<span class="hljs-attribute">Pickup</span>::pickedup = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  playsound <span class="hljs-string">'boip.wav'</span>
  <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Energy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pickup</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"energy1.png"</span>
<span class="hljs-attribute">Energy</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framelist = [<span class="hljs-number">1.</span><span class="hljs-number">.6</span>].map (n) -&gt; <span class="hljs-string">"energy<span class="hljs-subst">#{n}</span>.png"</span>
  <span class="hljs-property">@src</span> = selectframe framelist, <span class="hljs-number">4</span>
<span class="hljs-attribute">Energy</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  <span class="hljs-property">@getsprite</span>()
<span class="hljs-attribute">Energy</span>::pickedup = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  otherent.energy += <span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gold</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pickup</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"crown.png"</span>
<span class="hljs-attribute">Gold</span>::getsprite = <span class="hljs-function">-&gt;</span>
<span class="hljs-attribute">Gold</span>::pickedup = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  otherent.score += <span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">relativetobox</span> = <span class="hljs-params">( box, anchor )</span> -&gt;</span>
  pos = V box.x, box.y
  size = V box.w, box.h
  pos = pos.vadd size.vmul anchor
  <span class="hljs-keyword">return</span> pos


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Thug</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@lifetime</span>=-<span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span> = V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'bugthug.png'</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-literal">true</span>
    <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
bottomcenter = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">Thug</span>::size = V <span class="hljs-number">24</span>, <span class="hljs-number">64</span>+<span class="hljs-number">16</span>
<span class="hljs-attribute">Thug</span>::anchor = bottomcenter
<span class="hljs-attribute">Thug</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-property">@getsprite</span>()

<span class="hljs-attribute">Thug</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'bugthug.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@src</span>=<span class="hljs-string">'thugded.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@lifetime</span>--
    <span class="hljs-property">@src</span>=<span class="hljs-string">"bugthugoof.png"</span>

<span class="hljs-attribute">Thug</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  <span class="hljs-keyword">if</span> otherent.attacktimeout? <span class="hljs-keyword">and</span> otherent.attacktimeout &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lifetime</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@gethitby</span> otherent
<span class="hljs-attribute">Thug</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.y += otherent.vel.y
  dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">1</span>
  <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>
  <span class="hljs-property">@health</span>-=<span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lila</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thug</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Robo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thug</span></span>

<span class="hljs-attribute">Lila</span>::scampersubroutine = <span class="hljs-attribute">Robo</span>::scampersubroutine = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">10</span>
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">10</span>
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.abs(<span class="hljs-property">@vel</span>.x)&lt;<span class="hljs-number">3</span>
    <span class="hljs-property">@vel</span>.x += <span class="hljs-keyword">if</span> <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">then</span> -<span class="hljs-property">@scamperspeed</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@scamperspeed</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">20</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-keyword">not</span> <span class="hljs-property">@facingleft</span>


<span class="hljs-attribute">Lila</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@kisstimeout</span>--
  <span class="hljs-keyword">super</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">50</span>
    <span class="hljs-keyword">return</span>
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">2</span>
  <span class="hljs-property">@scampersubroutine</span>()

<span class="hljs-attribute">Robo</span>::visioncheck = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  CENTER = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  dim = <span class="hljs-number">64</span>*<span class="hljs-number">4</span>
  visionarea = makebox @.pos, V(dim,dim), CENTER
  <span class="hljs-property">@angry</span> = visionarea.containspoint ladybug.pos

<span class="hljs-attribute">Robo</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  isdead = <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
  <span class="hljs-property">@state</span>=<span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"attacking"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"idle"</span>
  <span class="hljs-keyword">if</span> isdead
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span>
  <span class="hljs-property">@visioncheck</span>()
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">1</span>
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">3</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span>
  <span class="hljs-property">@scampersubroutine</span>()
<span class="hljs-function">
<span class="hljs-title">selectframe</span> = <span class="hljs-params">( framelist, framewait )</span> -&gt;</span>
  totalframes = framelist.length
  framechoice = Math.floor(tickno/framewait)%totalframes
  framelist[framechoice]

<span class="hljs-attribute">Lila</span>::getsprite = <span class="hljs-function">-&gt;</span>
  idlecycle = [ <span class="hljs-string">'lilaidle1.png'</span>, <span class="hljs-string">'lilaidle2.png'</span> ]
  scampercycle = (<span class="hljs-string">"lilascamper<span class="hljs-subst">#{n}</span>.png"</span> <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span><span class="hljs-number">.4</span>])
  framewait = <span class="hljs-number">4</span>
  framelist=idlecycle
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framewait = <span class="hljs-number">20</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framelist=scampercycle
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">90</span> <span class="hljs-keyword">then</span> framelist = [ <span class="hljs-string">"lilakiss.png"</span> ]
  <span class="hljs-property">@src</span> = selectframe framelist, framewait
<span class="hljs-attribute">Robo</span>::getsprite = <span class="hljs-function">-&gt;</span>
  idlecycle = [ <span class="hljs-string">'roboroll1.png'</span> ]
  scampercycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"roboroll<span class="hljs-subst">#{n}</span>.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span>
    idlecycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"roborage<span class="hljs-subst">#{n}</span>.png"</span>
    scampercycle = [<span class="hljs-number">2.</span><span class="hljs-number">.4</span>].map (n) -&gt; <span class="hljs-string">"roborage<span class="hljs-subst">#{n}</span>.png"</span>
  framelist=idlecycle
  
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framelist=scampercycle
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@lifetime</span>--
    framelist=[<span class="hljs-string">"robohurt.png"</span>]
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
    framelist=[<span class="hljs-string">"robobody.png"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>@pos.y++ #AUGH</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lifetime</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    framelist=[<span class="hljs-string">"roboded.png"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>@pos.y—</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  framewait = <span class="hljs-number">4</span>
  <span class="hljs-property">@src</span> = selectframe framelist, framewait
<span class="hljs-attribute">Robo</span>::collide = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Hero <span class="hljs-keyword">and</span> <span class="hljs-property">@state</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"attacking"</span>
    otherent.takedamage()
<span class="hljs-attribute">Lila</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>parentstage.addChild bogglescreen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (<span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">0</span>)
      ladybug.heal()
      WORLD.spritelayer.push <span class="hljs-keyword">new</span> Smoochie <span class="hljs-property">@pos</span>
    <span class="hljs-property">@kisstimeout</span> = <span class="hljs-number">100</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Fence
    <span class="hljs-property">@vel</span>.x = <span class="hljs-number">0</span>
    offs = <span class="hljs-keyword">if</span> otherent.pos.x &lt; <span class="hljs-property">@pos</span>.x <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
    <span class="hljs-property">@pos</span>.x += offs

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Burd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
    <span class="hljs-property">@src</span>=<span class="hljs-string">'burd.png'</span>
<span class="hljs-attribute">Burd</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@getsprite</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>@avoidwalls()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@pos</span>=<span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  lpos = ladybug.pos <span class="hljs-keyword">or</span> V()
  dir=lpos.vsub(<span class="hljs-property">@pos</span>).norm()
  <span class="hljs-property">@vel</span>=<span class="hljs-property">@vel</span>.vadd dir
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.mag() &gt; <span class="hljs-number">10</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.norm().nmul <span class="hljs-number">10</span>
<span class="hljs-attribute">Burd</span>::render = <span class="hljs-function">-&gt;</span>
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
  flip=<span class="hljs-literal">false</span>
  pos=relativetobox(<span class="hljs-property">@gethitbox</span>(),anchor)
  drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor
  <span class="hljs-property">@_pixisprite</span>.scale.x = <span class="hljs-number">1</span>/<span class="hljs-number">3</span>
  <span class="hljs-property">@_pixisprite</span>.scale.y = <span class="hljs-number">1</span>/<span class="hljs-number">3</span>
<span class="hljs-attribute">Burd</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framelist = [ <span class="hljs-string">'burd.png'</span>, <span class="hljs-string">'burdflap.png'</span> ]
  <span class="hljs-property">@src</span> = mafs.randelem framelist</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>@src = selectframe framelist, 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Burd</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  timeout=otherent.attacktimeout
  <span class="hljs-keyword">if</span> timeout? <span class="hljs-keyword">and</span> timeout &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@gethitby</span> otherent
<span class="hljs-attribute">Burd</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.y += otherent.vel.y
  dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">4</span>
  <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoggleParticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm()
    <span class="hljs-property">@src</span> = <span class="hljs-string">'huh.png'</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">50</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">8</span>

<span class="hljs-attribute">BoggleParticle</span>::render = <span class="hljs-function">-&gt;</span>
    drawsprite @, <span class="hljs-string">'huh.png'</span>, <span class="hljs-property">@pos</span>, <span class="hljs-literal">false</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Smoochie</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-property">@anchor</span>=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm()
    <span class="hljs-property">@src</span> = <span class="hljs-string">'kissparticle1.png'</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">50</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">8</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd V <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-property">@getsprite</span>()
    <span class="hljs-property">@_pixisprite</span>.rotation = mafs.degstorads Math.cos(<span class="hljs-property">@life</span>/<span class="hljs-number">100</span>)*<span class="hljs-number">10</span>

<span class="hljs-attribute">Smoochie</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framewait = <span class="hljs-number">16</span>
  framelist = [<span class="hljs-number">1.</span><span class="hljs-number">.3</span>].map (n) -&gt; <span class="hljs-string">"kissparticle<span class="hljs-subst">#{n}</span>.png"</span>
  <span class="hljs-keyword">return</span> selectframe framelist, framewait

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PchooParticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm().ndiv <span class="hljs-number">8</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">20</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'bughealth.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">64</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    drawsprite @, <span class="hljs-property">@src</span>, <span class="hljs-property">@pos</span>, <span class="hljs-literal">false</span>, <span class="hljs-property">@anchor</span>
    <span class="hljs-property">@_pixisprite</span>.alpha = <span class="hljs-number">0.25</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bullet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@owner</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-property">@vel</span> = V(<span class="hljs-number">8</span>,<span class="hljs-number">0</span>)
    <span class="hljs-property">@life</span> = <span class="hljs-number">20</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'particlepunch.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">64</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    flip=<span class="hljs-property">@vel</span>.x&lt;<span class="hljs-number">0</span>
    drawsprite @, <span class="hljs-property">@src</span>, <span class="hljs-property">@pos</span>, flip, <span class="hljs-property">@anchor</span>
    <span class="hljs-property">@_pixisprite</span>.alpha = <span class="hljs-number">0.8</span>

<span class="hljs-attribute">Bullet</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent.health? <span class="hljs-keyword">and</span> otherent <span class="hljs-keyword">isnt</span> <span class="hljs-property">@owner</span>
    otherent.gethitby?( <span class="hljs-property">@owner</span> )
    <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>

<span class="hljs-attribute">Target</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.nmul <span class="hljs-number">7</span>/<span class="hljs-number">10</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@lifetime</span>--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> entitycount(Target) <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> achieve <span class="hljs-string">"target"</span>
<span class="hljs-function">
<span class="hljs-title">isholdingkey</span> = <span class="hljs-params">(key)</span> -&gt;</span>
  key = key.toUpperCase().charCodeAt <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> key <span class="hljs-keyword">in</span> control.heldkeys
<span class="hljs-function">
<span class="hljs-title">isholdingbound</span> = <span class="hljs-params">(name)</span> -&gt;</span>
  keys=control.heldkeys.map (key) -&gt; control.bindingnames[key]
  <span class="hljs-keyword">return</span> name <span class="hljs-keyword">in</span> keys

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hero</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@jumping</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@attacking</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@attacktimeout</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@stuntimeout</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
    <span class="hljs-property">@energy</span>=<span class="hljs-number">0</span>
    <span class="hljs-property">@score</span>=<span class="hljs-number">0</span>
    <span class="hljs-property">@facingleft</span>=<span class="hljs-literal">false</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BugLady</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@invincibletimeout</span>=<span class="hljs-number">0</span>
    <span class="hljs-property">@controls</span>={}
<span class="hljs-attribute">BugLady</span>::heal = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
<span class="hljs-attribute">BugLady</span>::respawn = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@pos</span> = V()
  <span class="hljs-property">@vel</span> = V()
  <span class="hljs-property">@heal</span>()
<span class="hljs-attribute">BugLady</span>::flinch = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vmul V -<span class="hljs-number">1</span>, <span class="hljs-number">1</span>
  <span class="hljs-property">@invincibletimeout</span> = <span class="hljs-number">20</span>
<span class="hljs-attribute">Hero</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@takedamage</span>()
<span class="hljs-attribute">BugLady</span>::takedamage = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@invincibletimeout</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@stuntimeout</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@flinch</span>()
  <span class="hljs-property">@health</span>-=<span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@kill</span>()
<span class="hljs-function">

<span class="hljs-title">entcenter</span> = <span class="hljs-params">( ent )</span> -&gt;</span>
  hb=ent.gethitbox()
  <span class="hljs-keyword">return</span> V hb.x+hb.w/<span class="hljs-number">2</span>, hb.y+hb.h/<span class="hljs-number">2</span>

<span class="hljs-attribute">BugLady</span>::dmgvelocity = <span class="hljs-number">20</span>
<span class="hljs-attribute">BugLady</span>::falldamage = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-property">@dmgvelocity</span>
    <span class="hljs-property">@stuntimeout</span> = <span class="hljs-number">20</span>
    <span class="hljs-property">@takedamage</span>()

<span class="hljs-attribute">GenericSprite</span>::blockcollisions = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@gethitbox</span>()
  candidates = hitboxfilter box, WORLD.bglayer
  candidates.forEach (candidate) =&gt;
    <span class="hljs-keyword">if</span> @.gethitbox().bottom() &gt;= candidate.top()
      <span class="hljs-property">@falldamage</span>?()
      <span class="hljs-property">@pos</span>.y = candidate.y
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> candidates.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span>
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>

<span class="hljs-attribute">BugLady</span>::blockcollisions = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@fallbox</span>()
  candidates = hitboxfilter box, WORLD.bglayer
  candidates.forEach (candidate) =&gt;
    <span class="hljs-keyword">if</span> @.gethitbox().bottom() &lt;= candidate.top()
      <span class="hljs-property">@pos</span>.y = candidate.y
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>if candidates.length &gt; 0 and @vel.y &lt; 0
 @vel.y = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">closestpoint</span> = <span class="hljs-params">(p, pointarr)</span> -&gt;</span>
  closest = pointarr[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> pointarr
    <span class="hljs-keyword">if</span> closest.dist(p) &gt; point.dist(p)
      closest = point
  <span class="hljs-keyword">return</span> closest

<span class="hljs-attribute">BugLady</span>::polygoncollisions = <span class="hljs-function">-&gt;</span>
  allpolygons = WORLD.spritelayer.filter (sprit) -&gt; sprit <span class="hljs-keyword">instanceof</span> Poly
  allpolygons.forEach (candidate) =&gt;
    p = <span class="hljs-keyword">new</span> V2d <span class="hljs-property">@pos</span>.x, <span class="hljs-property">@pos</span>.y
    trajectory = <span class="hljs-keyword">new</span> Line2d <span class="hljs-property">@pos</span>, <span class="hljs-property">@pos</span>.vadd(<span class="hljs-property">@vel</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>if trajectory.lineintersect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    edges = pointlisttoedges candidate.points
    hits=edges.map (edg) -&gt; trajectory.lineintersect edg
    hits = _.compact hits <span class="hljs-comment">#strip nulls</span>
    <span class="hljs-keyword">if</span> hits.length &gt; <span class="hljs-number">0</span> <span class="hljs-comment">#and @vel.y &gt;= 0</span>
      closest = closestpoint p, hits
      <span class="hljs-property">@pos</span> = closest.vsub(<span class="hljs-property">@vel</span>.norm())
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span> <span class="hljs-comment">#-Math.abs(@vel.x)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>@vel.x = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> geometry.pointInsidePoly p, candidate.points
      <span class="hljs-property">@vel</span>.y--</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p> @vel.y = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      

<span class="hljs-attribute">Hero</span>::checkcontrols = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>
<span class="hljs-attribute">BugLady</span>::checkcontrols = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@holdingboggle</span> = isholdingbound <span class="hljs-string">'boggle'</span>
  <span class="hljs-property">@holdingjump</span> = isholdingbound <span class="hljs-string">'up'</span>
  <span class="hljs-property">@controls</span>.crouch = isholdingbound <span class="hljs-string">'down'</span>


<span class="hljs-attribute">BugLady</span>::cancelattack = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@attacktimeout</span> = <span class="hljs-number">0</span>
  <span class="hljs-property">@attacking</span>=<span class="hljs-literal">false</span>

<span class="hljs-attribute">Hero</span>::outofbounds = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@pos</span>.y &gt; <span class="hljs-number">6400</span>

<span class="hljs-attribute">BugLady</span>::kill = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@respawn</span>()


<span class="hljs-attribute">BugLady</span>::timeoutcheck = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@invincibletimeout</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@invincibletimeout</span>--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@poweruptimeout</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@poweruptimeout</span>--
    <span class="hljs-property">@vel</span> = V2d.zero()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@stuntimeout</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@stuntimeout</span>--
    achieve <span class="hljs-string">"fall"</span>
    <span class="hljs-property">@vel</span> = V2d.zero()

<span class="hljs-attribute">BugLady</span>::attackchecks = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@attacking</span>=<span class="hljs-property">@attacktimeout</span> &gt; <span class="hljs-number">0</span>
  heading = <span class="hljs-keyword">if</span> <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@attacktimeout</span>--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@punching</span>
    <span class="hljs-property">@vel</span>.y *= <span class="hljs-number">0.7</span>
    <span class="hljs-property">@vel</span>.x += heading*<span class="hljs-number">0.3</span>
    WORLD.spritelayer.push <span class="hljs-keyword">new</span> PchooParticle entcenter @
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span>
    <span class="hljs-keyword">if</span> entitycount(Bullet) &lt; <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@energy</span> &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@energy</span>--
      firebullet @
<span class="hljs-function">
<span class="hljs-title">firebullet</span> = <span class="hljs-params">(ent)</span> -&gt;</span>
  heading = <span class="hljs-keyword">if</span> ent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  bullet = <span class="hljs-keyword">new</span> Bullet()
  bullet.owner = ent
  bullet.vel = V heading*<span class="hljs-number">16</span>, <span class="hljs-number">0</span>
  CENTER=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  bullet.pos = relativetobox ent.gethitbox(), CENTER
  WORLD.spritelayer.push bullet
  <span class="hljs-keyword">return</span> bullet
<span class="hljs-function">
<span class="hljs-title">get_sprites_of_class</span> = <span class="hljs-params">(classtype)</span> -&gt;</span>
  ents = WORLD.spritelayer.filter (sprite) -&gt; sprite <span class="hljs-keyword">instanceof</span> classtype

<span class="hljs-attribute">BugLady</span>::submerged = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  waterblocks = get_sprites_of_class Water
  collidebox = <span class="hljs-property">@gethitbox</span>()
  blockcandidates=hitboxfilter collidebox, waterblocks
  <span class="hljs-keyword">if</span> blockcandidates.length &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

<span class="hljs-attribute">BugLady</span>::waterdrag = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span>.y = <span class="hljs-property">@vel</span>.y * <span class="hljs-number">0.8</span>
  <span class="hljs-property">@vel</span>.x = <span class="hljs-property">@vel</span>.x * <span class="hljs-number">0.95</span>
<span class="hljs-attribute">BugLady</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@submerged</span>()
    <span class="hljs-property">@waterdrag</span>()
  unpowered = settings.altcostume
  <span class="hljs-keyword">if</span> unpowered <span class="hljs-keyword">then</span> <span class="hljs-property">@cancelattack</span>()
  <span class="hljs-property">@checkcontrols</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@outofbounds</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@kill</span>()
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">0.2</span>
  boggling = <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@holdingboggle</span>
  <span class="hljs-keyword">if</span> boggling <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">0.3</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@boggle</span>()
  <span class="hljs-property">@timeoutcheck</span>()
  <span class="hljs-property">@movetick</span>()

<span class="hljs-attribute">BugLady</span>::limitvelocity = <span class="hljs-function">-&gt;</span>
  vellimit = <span class="hljs-number">10</span><span class="hljs-comment">#if @touchingground() then 4 else 5</span>
  <span class="hljs-property">@vel</span>.x = mafs.clamp <span class="hljs-property">@vel</span>.x, -vellimit, vellimit
<span class="hljs-attribute">BugLady</span>::gravitate = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@holdingjump</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.y /= <span class="hljs-number">2</span>

<span class="hljs-attribute">GenericSprite</span>::physmove = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@blockcollisions</span>()
  <span class="hljs-property">@avoidwalls</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-property">@gravitate</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@friction</span>()

<span class="hljs-attribute">BugLady</span>::physmove = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@limitvelocity</span>()
  <span class="hljs-property">@blockcollisions</span>()
  <span class="hljs-property">@polygoncollisions</span>()
  <span class="hljs-property">@avoidwalls</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-property">@gravitate</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@friction</span>()

<span class="hljs-attribute">BugLady</span>::movetick = <span class="hljs-function">-&gt;</span>
  unpowered = settings.altcostume
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-property">@attackchecks</span>()
  jumpvel = <span class="hljs-keyword">if</span> unpowered <span class="hljs-keyword">then</span> <span class="hljs-number">12</span> <span class="hljs-keyword">else</span> <span class="hljs-number">16</span>
  <span class="hljs-property">@jumpimpulse</span> jumpvel
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@controls</span>.crouch
    <span class="hljs-property">@state</span> = <span class="hljs-string">'headfirst'</span>
    <span class="hljs-property">@vel</span>.y += <span class="hljs-number">0.1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'headfirst'</span>
    <span class="hljs-property">@state</span> = <span class="hljs-string">''</span>
    <span class="hljs-property">@stuntimeout</span>=<span class="hljs-number">20</span>
  <span class="hljs-property">@jumping</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">#so we don't repeat by accident yo</span>
  <span class="hljs-property">@climbing</span> = <span class="hljs-property">@touchingwall</span>()

<span class="hljs-attribute">BugLady</span>::jumpimpulse = <span class="hljs-function"><span class="hljs-params">(jumpvel)</span> -&gt;</span>
  jumplegal = <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">or</span> <span class="hljs-property">@submerged</span>()
  <span class="hljs-keyword">if</span> jumplegal <span class="hljs-keyword">and</span> <span class="hljs-property">@jumping</span>
    <span class="hljs-property">@vel</span>.y = -jumpvel

<span class="hljs-attribute">GenericSprite</span>::friction = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.x = <span class="hljs-property">@vel</span>.x*<span class="hljs-number">0.5</span>

<span class="hljs-attribute">BugLady</span>::boggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  WORLD.spritelayer.push <span class="hljs-keyword">new</span> BoggleParticle entcenter @
  hit=ladybug.gethitbox()
  boxes = WORLD.fglayer.map (obj) -&gt; obj.gethitbox()
  cand=hitboxfilter hit, boxes
  <span class="hljs-keyword">if</span> cand.length &gt; <span class="hljs-number">0</span>
    achieve <span class="hljs-string">"boggle"</span>

<span class="hljs-attribute">BugLady</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@invincibletimeout</span> &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"bugflinch.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@invincibletimeout</span> &gt; <span class="hljs-number">15</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"bugdmg.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@invincibletimeout</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"bugdmg2.png"</span>
  <span class="hljs-keyword">if</span> settings.beanmode <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"bugbean.png"</span>
  src=<span class="hljs-string">"lovelyshorter.png"</span>
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">0.2</span>
  <span class="hljs-keyword">if</span> walking
    src = selectframe [ <span class="hljs-string">'lovelyrun1.png'</span>, <span class="hljs-string">'lovelyrun2.png'</span> ], <span class="hljs-number">3</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    src = <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'lovelyjump.png'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@controls</span>.crouch
    src = <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@holdingboggle</span>
    src = <span class="hljs-string">'boggle.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'viewtiful.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugpunch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@attacktimeout</span> &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'lovelyrun2.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@kicking</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugkick.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@stuntimeout</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@stuntimeout</span> &gt; <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'lovelyfall.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@poweruptimeout</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'viewtiful.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@poweruptimeout</span> &gt; <span class="hljs-number">16</span>
    src = <span class="hljs-string">'boggle.png'</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-property">@poweruptimeout</span> % <span class="hljs-number">10</span> &lt; <span class="hljs-number">5</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@poweruptimeout</span> &gt; <span class="hljs-number">32</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'marl/boggle.png'</span>
  <span class="hljs-keyword">if</span> settings.altcostume <span class="hljs-keyword">then</span> src = <span class="hljs-string">"marl/"</span> + src
  <span class="hljs-keyword">if</span> <span class="hljs-property">@climbing</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugclimb1.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@climbing</span> <span class="hljs-keyword">and</span> settings.altcostume <span class="hljs-keyword">then</span> src = <span class="hljs-string">'marl/boggle.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'headfirst'</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugheadfirst.png'</span>
  <span class="hljs-keyword">return</span> src

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Claire</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BugLady</span></span>
<span class="hljs-attribute">Claire</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"orcbabb.png"</span>

<span class="hljs-attribute">BugLady</span>::render = <span class="hljs-function">-&gt;</span>
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">1</span>
  src=<span class="hljs-property">@getsprite</span>()
  flip = <span class="hljs-property">@facingleft</span>
  <span class="hljs-keyword">if</span> settings.beanmode <span class="hljs-keyword">and</span> walking <span class="hljs-keyword">then</span> flip = tickno % <span class="hljs-number">8</span> &lt; <span class="hljs-number">4</span>
  pos = relativetobox <span class="hljs-property">@gethitbox</span>(), <span class="hljs-property">@anchor</span>
  sprit=drawsprite @, src, pos, flip, <span class="hljs-property">@anchor</span>
  <span class="hljs-keyword">if</span> src == <span class="hljs-string">'boggle.png'</span>
    sprit.rotation=mafs.degstorads mafs.randfloat()*<span class="hljs-number">4</span>
  <span class="hljs-keyword">else</span>
    sprit.rotation=<span class="hljs-number">0</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlayerBurd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'burd.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>

<span class="hljs-attribute">PlayerBurd</span>::takedamage = <span class="hljs-attribute">BugLady</span>::takedamage
<span class="hljs-attribute">PlayerBurd</span>::getsprite = <span class="hljs-function">-&gt;</span> <span class="hljs-string">'burd.png'</span>
<span class="hljs-attribute">PlayerBurd</span>::render = <span class="hljs-function">-&gt;</span>
  src=<span class="hljs-property">@src</span>
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
  flip=<span class="hljs-literal">false</span>
  pos=<span class="hljs-property">@pos</span>
  sprit=drawsprite @, src, pos, flip, anchor
  <span class="hljs-keyword">return</span>

<span class="hljs-attribute">PlayerBurd</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@checkcontrols</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@outofbounds</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@kill</span>()
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>BLOCK COLLISIONS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@blockcollisions</span>()
  <span class="hljs-property">@avoidwalls</span>()
  heading = <span class="hljs-keyword">if</span> <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@gravitate</span>()
<span class="hljs-function">
<span class="hljs-title">removesprite</span> = <span class="hljs-params">( ent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent._pixisprite? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  stage.removeChild ent._pixisprite
  ent._pixisprite=<span class="hljs-literal">undefined</span>
<span class="hljs-function">
<span class="hljs-title">initsprite</span> = <span class="hljs-params">(ent,tex)</span> -&gt;</span>
  sprit = <span class="hljs-keyword">new</span> PIXI.Sprite tex
  ent._pixisprite=sprit
  stage.addChild sprit
  <span class="hljs-keyword">return</span> sprit
<span class="hljs-function">
<span class="hljs-title">drawsprite</span> = <span class="hljs-params">(ent, src, pos, flip, anchor=V())</span> -&gt;</span>
  tex = PIXI.Texture.fromImage sourcebaseurl+src
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent._pixisprite
    initsprite ent,tex
  sprit = ent._pixisprite
  sprit.position = VTOPP pos
  sprit.anchor = VTOPP anchor
  sprit.setTexture tex
  sprit.scale.x = <span class="hljs-keyword">if</span> flip <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> sprit


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poly</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@points</span>=[])</span> -&gt;</span>
    <span class="hljs-property">@pos</span> = V()
<span class="hljs-attribute">Poly</span>::initsprite = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  sprit=<span class="hljs-keyword">new</span> PIXI.Graphics()
  sprit.beginFill <span class="hljs-number">0xcc0000</span>
  sprit.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x000000</span>
  firstpoint = <span class="hljs-property">@points</span>[<span class="hljs-number">0</span>]
  <span class="hljs-property">@points</span>.forEach (point) -&gt;
    sprit.lineTo point.x, point.y
  sprit.lineTo firstpoint.x, firstpoint.y
  sprit.endFill()
  <span class="hljs-property">@_pixisprite</span>=sprit
  stage.addChild sprit
<span class="hljs-attribute">Poly</span>::render = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@hassprite</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@initsprite</span>()

<span class="hljs-attribute">Poly</span>::boundingbox = <span class="hljs-function">-&gt;</span>
  xs=<span class="hljs-property">@points</span>.map (pt) -&gt; pt.x
  ys=<span class="hljs-property">@points</span>.map (pt) -&gt; pt.y
<span class="hljs-function">  <span class="hljs-title">min</span> = <span class="hljs-params">(a,b)</span> -&gt;</span> Math.min a,b
<span class="hljs-function">  <span class="hljs-title">max</span> = <span class="hljs-params">(a,b)</span> -&gt;</span> Math.max a,b
  l=Math.round xs.reduce min
  r=Math.round xs.reduce max
  t=Math.round ys.reduce min
  b=Math.round ys.reduce max
  <span class="hljs-keyword">return</span> makebox V(l,t), V(r-l,b-t), V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)

<span class="hljs-attribute">Poly</span>::gethitbox = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@boundingbox</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p> makebox V(0,0), V(32,32), V(0,0)</p>

            </div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>ok this hsould really be mmoved to some geometry library thing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>,<span class="hljs-property">@w</span>,<span class="hljs-property">@h</span>)</span> -&gt;</span> <span class="hljs-property">@pos</span> = V <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>


<span class="hljs-attribute">Block</span>::intersection = <span class="hljs-function"><span class="hljs-params">(rectb)</span> -&gt;</span>
  recta=@
  l=Math.max recta.left(), rectb.left()
  t=Math.max recta.top(), rectb.top()
  r=Math.min recta.right(), rectb.right()
  b=Math.min recta.bottom(), rectb.bottom()
  w=r-l
  h=b-t
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block l,t,w,h


<span class="hljs-attribute">Block</span>::strictoverlaps = <span class="hljs-function"><span class="hljs-params">( rectb )</span> -&gt;</span>
  recta=@
  <span class="hljs-keyword">if</span> recta.left() &gt;= rectb.right() <span class="hljs-keyword">or</span>
  recta.top() &gt;= rectb.bottom() <span class="hljs-keyword">or</span>
  recta.right() &lt;= rectb.left() <span class="hljs-keyword">or</span>
  recta.bottom() &lt;= rectb.top()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>rename Block::touching ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Block</span>::overlaps = <span class="hljs-function"><span class="hljs-params">( rectb )</span> -&gt;</span>
  recta=@
  <span class="hljs-keyword">if</span> recta.left() &gt; rectb.right() <span class="hljs-keyword">or</span>
  recta.top() &gt; rectb.bottom() <span class="hljs-keyword">or</span>
  recta.right() &lt; rectb.left() <span class="hljs-keyword">or</span>
  recta.bottom() &lt; rectb.top()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

<span class="hljs-attribute">Block</span>::tostone = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@src</span>=<span class="hljs-string">"groundstone.png"</span>
  <span class="hljs-property">@removesprite</span>()

<span class="hljs-attribute">Block</span>::fixnegative = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@w</span>&lt;<span class="hljs-number">0</span>
    <span class="hljs-property">@x</span>+=<span class="hljs-property">@w</span>
    <span class="hljs-property">@w</span>*=-<span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@h</span>&lt;<span class="hljs-number">0</span>
    <span class="hljs-property">@y</span>+=<span class="hljs-property">@h</span>
    <span class="hljs-property">@h</span>*=-<span class="hljs-number">1</span>
  <span class="hljs-property">@pos</span> = V <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>
  <span class="hljs-property">@removesprite</span>()
<span class="hljs-function">
<span class="hljs-title">hitboxfilter</span> = <span class="hljs-params">( hitbox, rectarray )</span> -&gt;</span>
  rectarray.filter (box) -&gt;
    hitbox.overlaps box
<span class="hljs-function">
<span class="hljs-title">makebox</span> = <span class="hljs-params">(position, dimensions, anchor)</span> -&gt;</span>
  truepos = position.vsub dimensions.vmul anchor
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block truepos.x, truepos.y, dimensions.x, dimensions.y

bottomcenter = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">BugLady</span>::anchor = bottomcenter
<span class="hljs-attribute">BugLady</span>::size = V <span class="hljs-number">16</span>, <span class="hljs-number">32</span>+<span class="hljs-number">16</span>

<span class="hljs-attribute">GenericSprite</span>::fallbox = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@gethitbox</span>()
  box.y+=<span class="hljs-property">@vel</span>.y
  box.x+=<span class="hljs-property">@vel</span>.x
  <span class="hljs-keyword">return</span> box
<span class="hljs-function">
<span class="hljs-title">leftof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.x
<span class="hljs-function"><span class="hljs-title">rightof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.x+box.w
<span class="hljs-function"><span class="hljs-title">bottomof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.y+box.h
<span class="hljs-function"><span class="hljs-title">topof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.y

<span class="hljs-attribute">Block</span>::left = <span class="hljs-function">-&gt;</span> leftof @
<span class="hljs-attribute">Block</span>::right = <span class="hljs-function">-&gt;</span> rightof @
<span class="hljs-attribute">Block</span>::bottom = <span class="hljs-function">-&gt;</span> bottomof @
<span class="hljs-attribute">Block</span>::top = <span class="hljs-function">-&gt;</span> topof @

<span class="hljs-attribute">Block</span>::containspoint = <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
  <span class="hljs-property">@x</span> &lt;= p.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span> &lt;= p.y <span class="hljs-keyword">and</span> <span class="hljs-property">@x</span>+<span class="hljs-property">@w</span> &gt;= p.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span>+<span class="hljs-property">@h</span> &gt;= p.y
<span class="hljs-function">
<span class="hljs-title">blocksatpoint</span> = <span class="hljs-params">(blocks, p)</span> -&gt;</span>
  blocks.filter (box) -&gt; box.containspoint p
<span class="hljs-function">
<span class="hljs-title">boxtouchingwall</span> = <span class="hljs-params">(collidebox)</span> -&gt;</span>
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    notontop = collidebox.bottom()&gt;block.top()
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.left() &lt; block.left()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.right() &gt; block.right()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

<span class="hljs-attribute">GenericSprite</span>::touchingwall = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()
  <span class="hljs-keyword">return</span> boxtouchingwall collidebox

<span class="hljs-attribute">GenericSprite</span>::avoidwalls = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  actualbox = <span class="hljs-property">@gethitbox</span>()
  collidebox = <span class="hljs-property">@fallbox</span>()
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    overlap=collidebox.intersection block
    notontop = actualbox.bottom() &gt;block.top()
    <span class="hljs-keyword">if</span> boxtouchingwall collidebox
      <span class="hljs-property">@vel</span>.x = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>if overlap.w &gt; 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-property">@pos</span>.x += <span class="hljs-number">0</span><span class="hljs-comment">#overlap.w</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ofs=<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.left() &lt;= block.left()
      <span class="hljs-property">@pos</span>.x-=ofs
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> rightof(collidebox) &gt;= rightof(block)
      <span class="hljs-property">@pos</span>.x+=ofs</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-attribute">GenericSprite</span>::touchingground = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  touch=<span class="hljs-literal">false</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    <span class="hljs-keyword">if</span> collidebox.bottom() &lt;= block.bottom()
      touch=<span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>generic poly handling woo wee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  allpolygons = WORLD.spritelayer.filter (sprit) -&gt; sprit <span class="hljs-keyword">instanceof</span> Poly
  box=<span class="hljs-property">@gethitbox</span>()
  box.y+=<span class="hljs-number">1</span>
  allpolygons.forEach (candidate) =&gt;
    p = <span class="hljs-keyword">new</span> V2d <span class="hljs-property">@pos</span>.x, <span class="hljs-property">@pos</span>.y+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> geometry.pointInsidePoly p, candidate.points
      touch = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> touch

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PowerSuit</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@pos</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'suit.png'</span>
<span class="hljs-attribute">PowerSuit</span>::anchor = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">PowerSuit</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
    <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    otherent.poweruptimeout = <span class="hljs-number">45</span>
    settings.altcostume=<span class="hljs-literal">false</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ControlObj</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@bindings</span>={}
    <span class="hljs-property">@holdbindings</span>={}
    <span class="hljs-property">@heldkeys</span>=[]
    <span class="hljs-property">@bindingnames</span>={}

control = <span class="hljs-keyword">new</span> ControlObj
<span class="hljs-property">@control</span> = control
<span class="hljs-function">
<span class="hljs-title">normalizekey</span> = <span class="hljs-params">(key)</span> -&gt;</span> key.toUpperCase().charCodeAt <span class="hljs-number">0</span>

<span class="hljs-attribute">ControlObj</span>::keytapbindraw = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[key]=func
<span class="hljs-attribute">ControlObj</span>::keytapbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[normalizekey(key)]=func
<span class="hljs-attribute">ControlObj</span>::keytapbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[normalizekey(key)]=func

<span class="hljs-attribute">ControlObj</span>::keytapbindname = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[normalizekey(key)]=name
  <span class="hljs-property">@keytapbind</span> key, func

<span class="hljs-attribute">ControlObj</span>::keyBindRawNamed = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[key]=name
  <span class="hljs-property">@keytapbindraw</span> key, func

<span class="hljs-attribute">ControlObj</span>::keyholdbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@holdbindings</span>[normalizekey(key)]=func
<span class="hljs-attribute">ControlObj</span>::keyholdbindname = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[normalizekey(key)]=name
  <span class="hljs-property">@holdbindings</span>[normalizekey(key)]=func

<span class="hljs-attribute">ControlObj</span>::keyHoldBindRawNamed = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[key]=name
  <span class="hljs-property">@holdbindings</span>[key]=func

control.keytapbindname <span class="hljs-string">'9'</span>, <span class="hljs-string">'zoom out'</span>, <span class="hljs-function">-&gt;</span> camera.zoomout()
control.keytapbindname <span class="hljs-string">'0'</span>, <span class="hljs-string">'zoom in'</span>, <span class="hljs-function">-&gt;</span> camera.zoomin()

control.keytapbindname <span class="hljs-string">'c'</span>, <span class="hljs-string">'become burd'</span>, <span class="hljs-function">-&gt;</span> jame.burdme()
<span class="hljs-function">

<span class="hljs-title">launchFullScreen</span> = <span class="hljs-params">(elm)</span> -&gt;</span>
  elm.requestFullScreen?()
  elm.mozRequestFullScreen?()
  elm.webkitRequestFullScreen?()
<span class="hljs-function"><span class="hljs-title">cancelFullScreen</span> = -&gt;</span>
  <span class="hljs-built_in">document</span>.cancelFullScreen?()
  <span class="hljs-built_in">document</span>.mozCancelFullScreen?()
  <span class="hljs-built_in">document</span>.webkitCancelFullScreen?()
<span class="hljs-function"><span class="hljs-title">toggleFullScreen</span> = <span class="hljs-params">(elm)</span> -&gt;</span>
  isfullscreen = <span class="hljs-built_in">document</span>.fullScreen || <span class="hljs-built_in">document</span>.mozFullScreen || <span class="hljs-built_in">document</span>.webkitFullScreen
  <span class="hljs-keyword">if</span> isfullscreen
    cancelFullScreen()
  <span class="hljs-keyword">else</span>
    launchFullScreen elm

control.keytapbindname <span class="hljs-string">'y'</span>, <span class="hljs-string">'toggle fullscreen'</span>, <span class="hljs-function">-&gt;</span>
  toggleFullScreen renderer.view
<span class="hljs-function"><span class="hljs-title">pausefunc</span> = -&gt;</span>
  playsound <span class="hljs-string">"pause.wav"</span>
  settings.paused = <span class="hljs-keyword">not</span> settings.paused
  <span class="hljs-keyword">if</span> settings.paused <span class="hljs-keyword">then</span> parentstage.addChild pausescreen
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.paused <span class="hljs-keyword">then</span> parentstage.removeChild pausescreen
control.keytapbindname <span class="hljs-string">'p'</span>, <span class="hljs-string">'pause'</span>, pausefunc
control.keyBindRawNamed keyCharToCode[<span class="hljs-string">'Pause/Break'</span>], <span class="hljs-string">'pause'</span>, pausefunc


control.keytapbindname <span class="hljs-string">'t'</span>, <span class="hljs-string">'underclock/slowmo'</span>, <span class="hljs-function">-&gt;</span>
  settings.slowmo = <span class="hljs-keyword">not</span> settings.slowmo

control.keytapbindname <span class="hljs-string">'g'</span>, <span class="hljs-string">'toggle grid'</span>, <span class="hljs-function">-&gt;</span>
  settings.grid = <span class="hljs-keyword">not</span> settings.grid


control.keytapbindname <span class="hljs-string">'l'</span>, <span class="hljs-string">'WHAM!'</span>, <span class="hljs-function">-&gt;</span>
  ladybug.jumping=<span class="hljs-literal">true</span>
  ladybug.kicking=<span class="hljs-literal">false</span>
  ladybug.punching=<span class="hljs-literal">false</span>
control.keyholdbind <span class="hljs-string">'l'</span>, <span class="hljs-function">-&gt;</span> ladybug.attacktimeout=<span class="hljs-number">10</span>
<span class="hljs-function">
<span class="hljs-title">punch</span> = -&gt;</span>
  ladybug.punching=<span class="hljs-literal">true</span>
  ladybug.kicking=<span class="hljs-literal">false</span>
  ladybug.attacktimeout=<span class="hljs-number">10</span>
  playsound <span class="hljs-string">"hit.wav"</span>
<span class="hljs-function"><span class="hljs-title">kick</span> = -&gt;</span>
  ladybug.kicking=<span class="hljs-literal">true</span>
  ladybug.jumping=<span class="hljs-literal">true</span>
  ladybug.punching=<span class="hljs-literal">false</span>
  ladybug.attacktimeout=<span class="hljs-number">10</span>
  playsound <span class="hljs-string">"hit.wav"</span>

control.keytapbindname <span class="hljs-string">'j'</span>, <span class="hljs-string">'POW!'</span>, punch
control.keytapbindname <span class="hljs-string">'k'</span>, <span class="hljs-string">'BAM!'</span>, kick
control.keytapbindname <span class="hljs-string">'m'</span>, <span class="hljs-string">'mute'</span>, <span class="hljs-function">-&gt;</span>
  settings.muted = <span class="hljs-keyword">not</span> settings.muted
<span class="hljs-function">
<span class="hljs-title">up</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> ladybug.touchingground()
    playsound <span class="hljs-string">"jump.wav"</span>
  ladybug.jumping=<span class="hljs-literal">true</span>
<span class="hljs-function"><span class="hljs-title">down</span> = -&gt;</span>
<span class="hljs-function">
<span class="hljs-title">bugspeed</span> = -&gt;</span>
  amt = <span class="hljs-keyword">if</span> ladybug.touchingground() <span class="hljs-keyword">then</span> <span class="hljs-number">6</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">left</span> = -&gt;</span>
  ladybug.facingleft = <span class="hljs-literal">true</span>
  ladybug.vel.x-=bugspeed()
<span class="hljs-function"><span class="hljs-title">right</span> = -&gt;</span>
  achieve <span class="hljs-string">"start"</span>
  ladybug.facingleft = <span class="hljs-literal">false</span>
  ladybug.vel.x+=bugspeed()

availableactions = [ up, down, left, right ]

control.keyholdbindname <span class="hljs-string">'w'</span>, <span class="hljs-string">'up'</span>, up
control.keyholdbindname <span class="hljs-string">'s'</span>, <span class="hljs-string">'down'</span>, down
control.keyholdbindname <span class="hljs-string">'a'</span>, <span class="hljs-string">'left'</span>, left
control.keyholdbindname <span class="hljs-string">'d'</span>, <span class="hljs-string">'right'</span>, right
control.keyholdbindname <span class="hljs-string">'x'</span>, <span class="hljs-string">'boggle'</span>, <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>

control.keyHoldBindRawNamed keyCharToCode[<span class="hljs-string">'Up'</span>], <span class="hljs-string">'up'</span>, up
control.keyHoldBindRawNamed keyCharToCode[<span class="hljs-string">'Down'</span>], <span class="hljs-string">'down'</span>, down
control.keyHoldBindRawNamed keyCharToCode[<span class="hljs-string">'Left'</span>], <span class="hljs-string">'left'</span>, left
control.keyHoldBindRawNamed keyCharToCode[<span class="hljs-string">'Right'</span>], <span class="hljs-string">'right'</span>, right
<span class="hljs-function">
<span class="hljs-title">save</span> = -&gt;</span>
  <span class="hljs-built_in">console</span>.log ladybug
  tmpladybug = $.extend {}, ladybug
  tmpladybug._pixisprite = <span class="hljs-literal">undefined</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"saving"</span>
  localStorage[<span class="hljs-string">"bug"</span>] = JSON.stringify tmpladybug
  <span class="hljs-built_in">console</span>.log localStorage[<span class="hljs-string">"bug"</span>]
  localStorage[<span class="hljs-string">"settings"</span>] = JSON.stringify settings
<span class="hljs-function">
<span class="hljs-title">load</span> = -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"loading"</span>
  $.extend ladybug, JSON.parse localStorage[<span class="hljs-string">"bug"</span>]
  ladybug.pos = $.extend V(), ladybug.pos
  ladybug.vel = V ladybug.vel.x, ladybug.vel.y
  $.extend settings, JSON.parse localStorage[<span class="hljs-string">"settings"</span>]

control.keytapbindname <span class="hljs-string">'6'</span>, <span class="hljs-string">'save'</span>, save
control.keytapbindname <span class="hljs-string">'7'</span>, <span class="hljs-string">'load'</span>, load
<span class="hljs-function">


<span class="hljs-title">nextlevel</span> = -&gt;</span>
  WORLD.clear()</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>ROBOWORLD_INIT()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  COLLTEST_INIT()
  WORLDINIT()
  ladybug.respawn()
<span class="hljs-function">
<span class="hljs-title">restartlevel</span> = -&gt;</span>
  WORLD.clear()
  loadlevelfile <span class="hljs-string">"levels/1.json"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>WORLD_ONE_INIT()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  WORLDINIT()
  ladybug.respawn()

control.keytapbindname <span class="hljs-string">'r'</span>, <span class="hljs-string">'restart level'</span>, restartlevel
control.keytapbindname <span class="hljs-string">'n'</span>, <span class="hljs-string">'change level'</span>, nextlevel

<span class="hljs-property">@CONTROL</span> = control

eventelement = $ <span class="hljs-built_in">document</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>renderer.view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
keypushcache = []
cheatcodecheck = -&gt;
  code=["Up","Up","Down","Down","Left","Right","Left","Right","B","A","Enter"]
  input=_.last keypushcache, code.length
  if _.isEqual input, code
    alert "conglaturation"
    keypushcache=[]
  code=["Right","Up","Right","A","Down","Down","Enter"]
  input=_.last keypushcache, code.length
  if _.isEqual input, code
    alert "you'r a radical kid!! you have prooved the justice of our culture. god bless a merica. bean mode unlock!"
    settings.beanmode = not settings.beanmode
    keypushcache=[]

eventelement.bind 'keydown', (e) -&gt;
  key = e.which
  control.bindings[key]?()
  if not (key in control.heldkeys)
    control.heldkeys.push key
    keypushcache.push keyCodeToChar[key]
    cheatcodecheck()
  return false
eventelement.bind 'keyup', (e) -&gt;
  key = e.which
  control.heldkeys = _.without control.heldkeys, key
  return false

tmpcanvasjq = $ "&lt;canvas&gt;"
tmpcanvas = tmpcanvasjq[0]

tickno = 0

Block::gethitbox = () -&gt; @

Block::initsprite = () -&gt;
  src = @src or "groundtile.png"
  tex = PIXI.Texture.fromImage sourcebaseurl+src
  sprit = new PIXI.TilingSprite tex, @w, @h
  @_pixisprite=sprit
  stage.addChild sprit

Block::render = -&gt;
  if not @hassprite() then @initsprite()
  sprit = @_pixisprite
  sprit.tilePosition.x = -@x
  sprit.tilePosition.y = -@y
  sprit.position.x = @x
  sprit.position.y = @y

class Water extends Block
  constructor: (@x,@y,@w,@h) -&gt;
    super @x, @y, @w, @h
    @src = "snow.png"
Water::render = -&gt;
  super()
  @_pixisprite.alpha=0.5

ladybug = new BugLady

class Cloud extends Renderable
  constructor: () -&gt;
    super()
    @src='cloud.png'
    if settings.decemberween then @src='snow.png'

Cloud::spriteinit = () -&gt;
  tex = PIXI.Texture.fromImage sourcebaseurl+@src
  sprit = new PIXI.TilingSprite tex, screensize.x, screensize.y
  @_pixisprite=sprit
  stage.addChildAt sprit, 0
  return sprit

class Grid extends Renderable
  constructor: () -&gt;
    super()
    @src='square.png'

adjustedscreensize = -&gt;
  return x: screensize.x*10, y: screensize.y*10

Grid::PIXINIT = Cloud::PIXINIT = -&gt;
  if not @_pixisprite
    tex = PIXI.Texture.fromImage sourcebaseurl+@src
    {x,y}=adjustedscreensize()
    sprit = new PIXI.TilingSprite tex, x,y
    @_pixisprite=sprit
    stage.addChildAt sprit, 0

Grid::PIXREMOVE = -&gt;
  if not settings.grid and @_pixisprite
    stage.removeChild @_pixisprite
    @_pixisprite=undefined

Cloud::render = () -&gt;
  pos = cameraoffset()
  flip = false
  @PIXINIT()
  sprit = @_pixisprite
  offset=V tickno*-0.2, Math.sin(tickno/200)*64
  sprit.position = VTOPP pos
  sprit.tilePosition = VTOPP offset
  if settings.grid and @_pixisprite
    stage.removeChild @_pixisprite
    @_pixisprite=undefined

Grid::render = () -&gt;
  pos = cameraoffset()
  flip = false
  @PIXINIT()
  sprit = @_pixisprite
  sprit.position = VTOPP pos
  offset = camera.pos.nmul -1
  sprit.tilePosition = new PIXI.Point offset.x, offset.y
  @PIXREMOVE()

class World
  constructor: () -&gt;
    @entities=[]
    @bglayer=[]
    @fglayer=[]
    @spritelayer=[]

WORLD=new World

randpos = -&gt; V(640*1.5,64*2).vadd mafs.randvec().vmul V 640, 100

class Shrub extends GenericSprite
  constructor: (@pos) -&gt;
    super @pos, 'shrub.png'
    @anchor=V 1/2,1

placeshrub = (pos) -&gt;
  WORLD.fglayer.push new Shrub pos

class PlaceholderSprite extends GenericSprite
  constructor: (@pos) -&gt;
    super @pos
    @label='a thing'
PlaceholderSprite::render = -&gt;
  if @_pixisprite?
    sprit=@_pixisprite
    sprit.position = VTOPP @pos
    sprit.anchor = VTOPP V 0, 0
    return
  txt = new PIXI.Text @label,
    { font: "12px Arial", fill:"black" }
  txt.anchor = PP @anchor
  console.log @anchor
  sprit = new PIXI.Graphics()
  sprit.beginFill 0xFF00FF
  box=@gethitbox()
  sprit.position = VTOPP @pos
  sprit.drawRect 0, 0, box.w, box.h
  sprit.alpha = 0.9
  sprit.addChild txt
  stage.addChild sprit
  @_pixisprite=sprit

class BugMeter extends GenericSprite
  constructor: () -&gt;
    super()
    @src='bughealth.png'
    @value=3
    @abspos = V 0, 0
    @spritesize = V 32, 32

BugMeter::spriteinit = () -&gt;
  tex = PIXI.Texture.fromImage sourcebaseurl+@src
  sprit = new PIXI.TilingSprite tex, @spritesize.x*@value, @spritesize.y
  @_pixisprite=sprit
  stage.addChild sprit
  return sprit

BugMeter::render = () -&gt;
  pos = cameraoffset()
  pos = pos.vadd @abspos
  flip = false
  if not @_pixisprite then @spriteinit()
  sprit = @_pixisprite
  sprit.width = @spritesize.x*@value
  sprit.position = VTOPP pos
BugMeter::tick = () -&gt;
  @update ladybug.health
BugMeter::update = (value) -&gt;
  @removesprite()
  @value = value

class EnergyMeter extends BugMeter
  constructor: () -&gt;
    super()
    @src='energy1.png'
    @abspos = V 0, 16
EnergyMeter::tick = () -&gt; @update ladybug.energy
class MoneyMeter extends BugMeter
  constructor: () -&gt;
    super()
    @src='crown.png'
    @spritesize = V 16,16
    @abspos = V 8, 64-16
  tick: () -&gt; @update ladybug.score


blockdata=[]
blockdata.push [ -64, 64*5-4, 64*12, 100 ]
blockdata.push [ 64*4, 64*2, 32, 32 ]
blockdata.push [ 64*5, 64*4, 32, 32 ]
blockdata.push [ 64*6, 64*3, 32, 32 ]
blockdata.push [ 0, 64*4, 32, 32 ]
blockdata.push [ 32, 64*4, 64*2, 64*2 ]
blockdata.push [ 64*12, 64*4, 64*12, 200 ]
blockdata.push [ 128+8, 64+20, 64, 32 ]
blockdata.push [ 128+8+64, 64+20+32, 32, 32 ]

Block::toJSON = -&gt;
  [ @x, @y, @w, @h ]

loadblocks = (blockdata) -&gt;
  blockdata.forEach (blockdatum) -&gt;
    [x,y,w,h]=blockdatum
    WORLD.bglayer.push new Block x, y, w, h
loadspawners = (entdata) -&gt;
  entdata.forEach (entdatum) -&gt;
    WORLD.spritelayer.push spawner=new Spawner entdatum.pos
    spawner.entdata = entdatum

scatterents = ( classproto, num ) -&gt;
  WORLD.spritelayer=WORLD.spritelayer.concat [0...num].map -&gt;
    new classproto randpos()

class Goal extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @label="GOAL"
Goal::collide = ( otherent ) -&gt;
  if otherent instanceof Hero
    nextlevel()

class Platform extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @label="platform"
Platform::collide = ( otherent ) -&gt;
  if otherent instanceof Hero
    otherent.vel.y = 0


class HurtWire extends GenericSprite
HurtWire::size = V 8, 32
HurtWire::anchor = V 1/2, 0
HurtWire::getsprite = -&gt;
  framewait = 1
  framelist = [ "wire.png" ]
  if @state=="sparking"
    framelist = [1..4].map (n) -&gt; "wirespark#{n}.png"
  return selectframe framelist, framewait
HurtWire::tick = -&gt;
  @age = @age or 0
  @age = (@age+1)%100
  if @age &lt; 30
    @state="sparking"
  else
    @state="inert"
HurtWire::collide = ( otherent ) -&gt;
  if @state=="sparking" and otherent instanceof Hero
    otherent.takedamage()
HurtWire::render = -&gt;
  @src=@getsprite()
  super()


spawnables = burd: Burd, target: Target, jelly: Jelly, powersuit: PowerSuit, gold: Gold, energy:Energy, lila: Lila, claire: Claire, platform: Platform
class Spawner extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @label="Entity spawner"
    @entdata=class: Jelly, pos: @pos
Spawner::tick = -&gt;
  @entdata.pos = @pos
  console.log @entdata.pos
  @label = @entdata.class
Spawner::spawn = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>ent=jame.spawn @classname
ent.load @entdata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  loadents [@entdata]
Spawner::toJSON = -&gt;
  @entdata


entdata = [ class: "lila", pos: {x: 64*4, y: 64*4 }
class: "claire", pos: {x: 64*2, y: 64*4}
]


jame={}
jame.spawn = (classname) -&gt;
  if not spawnables[classname]
    return
  ent=new spawnables[classname]?()
  WORLD.spritelayer.push ent
  return ent

loadent = (entdatum) -&gt;
  ent=jame.spawn entdatum.class
  ent.load entdatum

loadents = (entdata) -&gt;
  entdata.forEach (entdatum) -&gt; loadent entdatum


WORLD_ONE_INIT = -&gt;
  scatterents HurtWire, 4
  scatterents Target, 10
  scatterents Jelly, 10
  scatterents Energy, 10
  scatterents Gold, 10
  scatterents Thug, 3
  WORLD.spritelayer.push new PowerSuit V(128,32)
  loadents entdata

  placeshrub V 64*8, 64*5-4
  placeshrub V 64*7-48, 64*5-4
  placeshrub V 64*9, 64*5-4
  WORLD.spritelayer.push new Goal V 64*24, 64*4
  WORLD.spritelayer.push royaljel = new Jelly randpos()
  WORLD.spritelayer.push hat= new Hat()
  hat.src = 'crown.png'
  hat.parent=royaljel

WORLDINIT = () -&gt;
  WORLD.entities.push new Cloud()
  WORLD.entities.push new Grid()
  bugmeter= new BugMeter
  WORLD.entities.push bugmeter
  energymeter= new EnergyMeter
  WORLD.entities.push energymeter
  WORLD.entities.push new MoneyMeter
  @bugmeter = bugmeter
  if settings.hat
    WORLD.entities.push new Hat()
  WORLD.bglayer.forEach (block) -&gt;
    fence=new Fence
    fence.pos = relativetobox block, V(0,0)
    WORLD.spritelayer.push fence
    fence=new Fence
    fence.pos = relativetobox block, V(1,0)
    WORLD.spritelayer.push fence
  WORLD.spritelayer.push ladybug

randtri = -&gt;
  new Poly [ randpos(), randpos(), randpos() ]

WORLD.getallents = -&gt;
  return [].concat WORLD.entities, WORLD.spritelayer, WORLD.bglayer, WORLD.fglayer

WORLD.clear = -&gt;
  ALLENTS = WORLD.getallents()
  ALLENTS.forEach (ent) -&gt; removesprite ent
  WORLD.entities=[]
  WORLD.spritelayer=[]
  WORLD.bglayer=[]
  WORLD.fglayer=[]</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>resetstage()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
roboblockdata=[]
roboblockdata.push [ -<span class="hljs-number">64</span>, <span class="hljs-number">64</span>*<span class="hljs-number">4</span>, <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">100</span> ]
roboblockdata.push [ <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">64</span>*<span class="hljs-number">5</span>, <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">100</span> ]
<span class="hljs-function">
<span class="hljs-title">ROBOWORLD_INIT</span> = -&gt;</span>
  scatterents Burd, <span class="hljs-number">8</span>
  loadblocks roboblockdata
  WORLD.spritelayer=WORLD.spritelayer.concat [<span class="hljs-number">0.</span><span class="hljs-number">.3</span>].map -&gt;
    <span class="hljs-keyword">new</span> Robo randpos()
  WORLD.spritelayer.push randtri()
<span class="hljs-function">
<span class="hljs-title">COLLTEST_INIT</span> = -&gt;</span>
  scatterents Jelly, <span class="hljs-number">8</span>
  loadblocks roboblockdata
  WORLD.spritelayer.push randtri()</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>levelfilename = <span class="hljs-string">"levels/1.json"</span>
$.ajax levelfilename, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,status,xhr)</span> -&gt;</span>
  jsondata=JSON.parse data
  loadlevel jsondata
  WORLD_ONE_INIT()</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">loadlevelfile</span> = <span class="hljs-params">(levelfilename)</span> -&gt;</span>
  $.ajax levelfilename, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,status,xhr)</span> -&gt;</span>
    jsondata=JSON.parse data
    loadlevel jsondata
    WORLD_ONE_INIT()
loadlevelfile <span class="hljs-string">"levels/1.json"</span>


WORLDINIT()

camera={}
jame.camera=camera
camera.offset=V()
camera.pos=V()
camera.trackingent = ladybug
camera.zoomout = <span class="hljs-function">-&gt;</span>
  scale-=<span class="hljs-number">0.1</span>
  scale = mafs.clamp scale, <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>
camera.zoomin = <span class="hljs-function">-&gt;</span>
  scale+=<span class="hljs-number">0.1</span>
  scale = mafs.clamp scale, <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">cameraoffset</span> = -&gt;</span>
  tmppos = camera.trackingent.pos.nadd <span class="hljs-number">0</span>
  tmppos.y -= <span class="hljs-number">64</span>
  tmppos = tmppos.vsub camera.offset.ndiv scale
  tmppos = tmppos.vsub screensize.ndiv <span class="hljs-number">2</span>*scale</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>return tmppos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> camera.pos.vadd(tmppos).ndiv <span class="hljs-number">2</span>

camera.tick = <span class="hljs-function">-&gt;</span>
  camera.pos = cameraoffset()
<span class="hljs-function">
<span class="hljs-title">render</span> = -&gt;</span>
  camera.tick()
  renderables = [].concat WORLD.bglayer, WORLD.spritelayer, [ladybug], WORLD.fglayer, WORLD.entities
  renderables.forEach (ent) -&gt; ent.render?()
  highlighted = renderables.filter (ent) -&gt; ent.HIGHLIGHT?
  <span class="hljs-keyword">if</span> settings.grid <span class="hljs-keyword">then</span> highlighted = renderables
  drawhitboxes highlighted
<span class="hljs-function">
<span class="hljs-title">drawhitboxes</span> = <span class="hljs-params">( ents )</span> -&gt;</span>
  stage.removeChild hitboxlayer
  hitboxlayer = <span class="hljs-keyword">new</span> PIXI.DisplayObjectContainer
  stage.addChild hitboxlayer
  graf = <span class="hljs-keyword">new</span> PIXI.Graphics()
  graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x00ff00</span>, <span class="hljs-number">1</span>
  graf.beginFill <span class="hljs-number">0xff0000</span>, <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  ents.forEach (ent) -&gt;
    graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x00ff00</span>, <span class="hljs-number">1</span>
    graf.drawCircle ent.pos.x, ent.pos.y, <span class="hljs-number">4</span>
    box = ent.gethitbox?()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> box <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    graf.drawRect box.x, box.y, box.w, box.h
    velbox = ent.fallbox?()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> velbox <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x0000ff</span>, <span class="hljs-number">1</span>
    graf.drawRect velbox.x, velbox.y, velbox.w, velbox.h
  hitboxlayer.addChild graf</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>returns elapsed time in ms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">timecall</span> = <span class="hljs-params">(func)</span> -&gt;</span>
  starttime = Date.now()
  func()
  Date.now()-starttime

tickwaitms = <span class="hljs-number">20</span>
skipframes = <span class="hljs-number">0</span>
ticktimes = []

WORLD.resethitboxcache = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p> WORLD.gethitbox = _.memoize (sprite) -&gt; sprite.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
WORLD.gethitbox = <span class="hljs-function"><span class="hljs-params">(sprite)</span> -&gt;</span> sprite.gethitbox()
<span class="hljs-function">
<span class="hljs-title">checkcolls</span> = <span class="hljs-params">( ent, otherents )</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>bawks = ent.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bawks = WORLD.gethitbox ent
  otherents.forEach (target) -&gt;
    <span class="hljs-keyword">if</span> target <span class="hljs-keyword">is</span> ent <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>targethitbox = target.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    targethitbox = WORLD.gethitbox target
    <span class="hljs-keyword">if</span> bawks.overlaps targethitbox
      target.collide?(ent)</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>remove entities that requested death</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>WORLD.euthanasia = <span class="hljs-function">-&gt;</span>
  doomedsprites = WORLD.spritelayer.filter (sprite) -&gt; sprite.KILLME?
  doomedsprites.forEach (sprite) -&gt; sprite.cleanup?()
  WORLD.spritelayer = _.difference WORLD.spritelayer, doomedsprites

WORLD.tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  WORLD.resethitboxcache()
  <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> control.heldkeys
    control.holdbindings[key]?()
  checkcolls ladybug, WORLD.spritelayer
  WORLD.spritelayer.forEach (sprite) -&gt;
    checkcolls sprite, _.without WORLD.spritelayer, sprite
  WORLD.euthanasia()
  ACTIVEENTS = [].concat WORLD.spritelayer, [ladybug], WORLD.entities
  ACTIVEENTS.forEach (ent) -&gt; ent.updatehitbox?()
  ACTIVEENTS.forEach (ent) -&gt; ent.tick?()
  render()
  tickno++

fpscounter=$ xmltag()
tt=<span class="hljs-number">0</span>
<span class="hljs-function">
<span class="hljs-title">updateinfobox</span> = -&gt;</span>
  text= control.heldkeys.map (key) -&gt; <span class="hljs-string">"&lt;span&gt;<span class="hljs-subst">#{keyCodeToChar[key]}</span>&lt;/span&gt;"</span>
  $(infobox).html text.join <span class="hljs-string">" "</span>
<span class="hljs-function">
<span class="hljs-title">mainloop</span> = -&gt;</span>
  updatesettingstable()
  updateinfobox()
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.paused
    ticktime = timecall WORLD.tick
    tt=ticktime
    fps=Math.round <span class="hljs-number">1000</span>/Math.max(tickwaitms,ticktime)
    idealfps=Math.round <span class="hljs-number">1000</span>/tickwaitms
    fpscounter.html <span class="hljs-string">"tick time: <span class="hljs-subst">#{tt}</span>ms, running at approx <span class="hljs-subst">#{fps}</span> fps (aiming for <span class="hljs-subst">#{idealfps}</span> fps)"</span>
  fpsgoal = <span class="hljs-keyword">if</span> settings.slowmo <span class="hljs-keyword">then</span> <span class="hljs-number">4</span> <span class="hljs-keyword">else</span> <span class="hljs-number">30</span>
  tickwaitms = <span class="hljs-number">1000</span>/fpsgoal
  setTimeout mainloop, Math.max tickwaitms-ticktime, <span class="hljs-number">1</span>
  requestAnimFrame animate
<span class="hljs-function">
<span class="hljs-title">xmlwrap</span> = <span class="hljs-params">(tagname,body)</span> -&gt;</span>
  xmltag tagname, <span class="hljs-literal">undefined</span>, body
<span class="hljs-function">
<span class="hljs-title">maketablerow</span> = <span class="hljs-params">( values )</span> -&gt;</span>
  tds = values.map (v) -&gt; xmlwrap <span class="hljs-string">"td"</span>, v
  <span class="hljs-keyword">return</span> xmlwrap <span class="hljs-string">"tr"</span>, tds
jame.maketable = <span class="hljs-function"><span class="hljs-params">(arrofarr)</span> -&gt;</span>
  domelm = $ <span class="hljs-string">'&lt;table&gt;'</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> arrofarr
    domelm.append maketablerow v
  <span class="hljs-keyword">return</span> domelm
<span class="hljs-function">
<span class="hljs-title">selectall</span> = <span class="hljs-params">(classname)</span> -&gt;</span>
  jame.WORLD.spritelayer.filter (obj) -&gt; obj.constructor.name == classname

jame.listents = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  ents=_.pairs _.countBy jame.WORLD.spritelayer, <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> obj.constructor.name
  body.append jame.maketable ents

infobox = $ <span class="hljs-string">"&lt;div&gt;"</span>
infobox.css <span class="hljs-attribute">float</span>: <span class="hljs-string">"right"</span>, <span class="hljs-attribute">border</span>: <span class="hljs-string">"1px solid black"</span>

body.append infobox



bindingsDOM = $ <span class="hljs-string">"&lt;table&gt;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>for k,v of control.bindings
 bindingsDOM.append maketablerow [keyCodeToChar[k],control.bindingnames[k] or “??”]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> control.bindingnames
  bindingsDOM.append maketablerow [keyCodeToChar[k],v <span class="hljs-keyword">or</span> <span class="hljs-string">"??"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>tmp, fix this shit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_CHARbindingnames = {}
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> control.bindingnames
  _CHARbindingnames[keyCodeToChar[k]]=v

settingsDOM = $ <span class="hljs-string">"&lt;table&gt;"</span>
<span class="hljs-function"><span class="hljs-title">updatesettingstable</span> = <span class="hljs-params">()</span> -&gt;</span>
  settingsDOM.html <span class="hljs-string">""</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> settings
    settingsDOM.append maketablerow [k,v]
<span class="hljs-function">
<span class="hljs-title">INIT</span> = -&gt;</span>
  body.append fpscounter
  body.append <span class="hljs-string">"&lt;b&gt;bindings:&lt;/b&gt;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>DEPENDS ON  keyboarddisplay.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  body.append keyboardlayout.visualize _CHARbindingnames
  body.append bindingsDOM
  body.append <span class="hljs-string">"&lt;b&gt;settings:&lt;/b&gt;"</span>
  body.append settingsDOM
  mainloop()
  requestAnimFrame animate

INIT()
<span class="hljs-function">
<span class="hljs-title">adjustmouseevent</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  coffs=$(renderer.view).offset()
  adjusted = V e.pageX-coffs.left, e.pageY-coffs.top
  adjusted = adjusted.ndiv scale
  adjusted = adjusted.vadd camera.pos
  adjusted = adjusted.op Math.round
  <span class="hljs-keyword">return</span> adjusted

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tool</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>

NOOPTOOL = <span class="hljs-attribute">name</span>: <span class="hljs-string">'noop'</span>, <span class="hljs-attribute">mousedown</span>: (<span class="hljs-function">-&gt;</span>), <span class="hljs-attribute">mouseup</span>: (<span class="hljs-function">-&gt;</span>), <span class="hljs-attribute">mousemove</span>: (<span class="hljs-function">-&gt;</span>)

BLOCKCREATIONTOOL = _.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'create block'</span>
  <span class="hljs-attribute">creatingblock</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>ADD BLOCK, LEFT MBUTTON
HOLD Z TO SNAP TO GRID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    BLOCKCREATIONTOOL.creatingblock=<span class="hljs-keyword">new</span> Block adjusted.x, adjusted.y, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>
    WORLD.bglayer.push BLOCKCREATIONTOOL.creatingblock
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    BLOCKCREATIONTOOL.creatingblock.fixnegative()
    BLOCKCREATIONTOOL.creatingblock = <span class="hljs-literal">false</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    mpos = snapmouseadjust adjustmouseevent e
    creatingblock = BLOCKCREATIONTOOL.creatingblock
    <span class="hljs-keyword">if</span> creatingblock
      creatingblock.w = mpos.x-creatingblock.x
      creatingblock.h = mpos.y-creatingblock.y
      creatingblock.removesprite()
      creatingblock.tostone()
    <span class="hljs-keyword">if</span> ORIGCLICKPOS
      currclickpos=V e.pageX, e.pageY
      offset=currclickpos.vsub ORIGCLICKPOS
      camera.offset = offset
<span class="hljs-function">
<span class="hljs-title">snapmouseadjust</span> = <span class="hljs-params">(mpos)</span> -&gt;</span>
  snaptogrid = isholdingkey <span class="hljs-string">'z'</span>
  <span class="hljs-keyword">if</span> snaptogrid
    gridsize = <span class="hljs-number">32</span>
    mpos = mpos.ndiv(gridsize).op(Math.round).nmul(gridsize)
  <span class="hljs-keyword">return</span> mpos

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoveTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span></span>
<span class="hljs-attribute">MoveTool</span>::name = <span class="hljs-string">'move entities'</span>
<span class="hljs-attribute">MoveTool</span>::constructor = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@selected</span> = []

<span class="hljs-attribute">MoveTool</span>::mouseup = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>p = adjustmouseevent e
@selected.forEach (ent) -&gt;
 ent.pos = p</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@selected</span> = []
  setcursor <span class="hljs-string">'auto'</span>
<span class="hljs-attribute">MoveTool</span>::mousemove = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-property">@selected</span> = <span class="hljs-property">@selected</span> <span class="hljs-keyword">or</span> [] <span class="hljs-comment">#jesus christ how horrifying</span>
  isSelecting = <span class="hljs-property">@selected</span>.length &gt; <span class="hljs-number">0</span>
  p = adjustmouseevent e
  entsundercursor = getentsunderpoint p
  <span class="hljs-keyword">if</span> isSelecting
    setcursor <span class="hljs-string">'-moz-grabbing'</span>
  <span class="hljs-keyword">else</span>
    setcursor <span class="hljs-string">'auto'</span>
  <span class="hljs-keyword">if</span> entsundercursor.length &gt; <span class="hljs-number">0</span>
    setcursor <span class="hljs-string">'-moz-grab'</span>
  p = snapmouseadjust p
  <span class="hljs-property">@selected</span>.forEach (ent) -&gt;
    ent.pos = p
    ent.vel = V()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoveBlockTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span></span>
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'move blocks'</span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@selected</span> = []
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-property">@selected</span> = []
    setcursor <span class="hljs-string">'auto'</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-property">@selected</span> = <span class="hljs-property">@selected</span> <span class="hljs-keyword">or</span> [] <span class="hljs-comment">#jesus christ how horrifying</span>
    isSelecting = <span class="hljs-property">@selected</span>.length &gt; <span class="hljs-number">0</span>
    p = adjustmouseevent e
    p = snapmouseadjust p
    <span class="hljs-property">@selected</span>.forEach (ent) -&gt;
      ent.pos = p
      ent.x = p.x
      ent.y = p.y
      ent.removesprite()
<span class="hljs-attribute">MoveBlockTool</span>::mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  blocksundercursor = blocksatpoint WORLD.bglayer, p
  <span class="hljs-property">@selected</span>=blocksundercursor
<span class="hljs-function">
<span class="hljs-title">getentsunderpoint</span> = <span class="hljs-params">(p)</span> -&gt;</span>
  WORLD.spritelayer.filter (ent) -&gt;
    box = ent.gethitbox?()
    <span class="hljs-keyword">return</span> box <span class="hljs-keyword">and</span> box.containspoint p

<span class="hljs-attribute">MoveTool</span>::mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  entsundercursor = getentsunderpoint p
  <span class="hljs-property">@selected</span>=entsundercursor
<span class="hljs-function">
<span class="hljs-title">setcursor</span> = <span class="hljs-params">(cursorname)</span> -&gt;</span>
  $(renderer.view).css <span class="hljs-string">'cursor'</span>, cursorname

MOVETOOL=<span class="hljs-keyword">new</span> MoveTool()
MOVETOOL.selected = []
MOVEBLOCKTOOL=<span class="hljs-keyword">new</span> MoveBlockTool()
  
tool = MOVETOOL

$(renderer.view).mousedown (e) -&gt; tool.mousedown? e
$(renderer.view).mouseup (e) -&gt; tool.mouseup? e
$(renderer.view).mousemove (e) -&gt; tool.mousemove? e
<span class="hljs-function">
<span class="hljs-title">randposrel</span> = <span class="hljs-params">(p=V())</span> -&gt;</span> p.vadd mafs.randvec().vmul V <span class="hljs-number">32</span>,<span class="hljs-number">32</span>
TRIANGLETOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"add triangle"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    triangle=<span class="hljs-keyword">new</span> Poly [ randposrel(p), randposrel(p), randposrel(p) ]
    WORLD.spritelayer.push triangle
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>

SPAWNTOOL= <span class="hljs-attribute">name</span>: <span class="hljs-string">'Spawn entity'</span>
SPAWNTOOL.classname = <span class="hljs-string">'burd'</span>
SPAWNTOOL.mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  ent=jame.spawn SPAWNTOOL.classname
  ent.pos = p

SPAWNTOOL.mouseup = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
SPAWNTOOL.mousemove = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>

SPAWNERTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'Spawn entity'</span>
  <span class="hljs-attribute">classname</span>: <span class="hljs-string">'burd'</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    WORLD.spritelayer.push ent=<span class="hljs-keyword">new</span> Spawner p
    ent.pos = p
    ent.entdata.class = SPAWNTOOL.classname
    ent.spawn()

TELEPORTTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"teleport"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    ladybug.pos = p
    ladybug.vel = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>take a list of Block objects
return a bounding block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">boxesbounding</span> = <span class="hljs-params">(boxlist)</span> -&gt;</span>
  ls=boxlist.map (b) -&gt; b.left()
  rs=boxlist.map (b) -&gt; b.right()
  ts=boxlist.map (b) -&gt; b.top()
  bs=boxlist.map (b) -&gt; b.bottom()
  l=ls.reduce (n,m) -&gt; Math.min n,m
  r=rs.reduce (n,m) -&gt; Math.max n,m
  t=ts.reduce (n,m) -&gt; Math.min n,m
  b=bs.reduce (n,m) -&gt; Math.max n,m
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block l,t,r-l,b-t</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>ughhhh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">blockcarve</span> = <span class="hljs-params">( aa, bb )</span> -&gt;</span>
  b = boxesbounding [ aa, bb ]
  a = aa.intersection(bb)
  x1= b.left()
  x2= a.left()
  x3= a.right()
  x4= b.right()
  y1= b.top()
  y2= a.top()
  y3= a.bottom()
  y4= b.bottom()
  blokx=[ [ x1, y1, x2-x1, y2-y1 ]
  [ x2, y1, x3-x2, y2-y1 ]
  [ x3, y1, x4-x3, y2-y1 ]
  [ x1, y2, x2-x1, y3-y2 ]
  [ x2, y2, x3-x2, y3-y2 ]
  [ x3, y2, x4-x3, y3-y2 ]
  [ x1, y3, x2-x1, y4-y3 ]
  [ x2, y3, x3-x2, y4-y3 ]
  [ x3, y3, x4-x3, y4-y3 ]
  ]
  blokx=blokx.map (blok) -&gt;
    newthing=<span class="hljs-keyword">new</span> Block blok[<span class="hljs-number">0</span>], blok[<span class="hljs-number">1</span>], blok[<span class="hljs-number">2</span>], blok[<span class="hljs-number">3</span>]
    newthing.fixnegative()
    <span class="hljs-keyword">return</span> newthing
  blokx=blokx.filter (blok) -&gt;
    blok.strictoverlaps(aa) <span class="hljs-keyword">or</span> blok.strictoverlaps(bb)</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>_.extend WORLD.bglayer, blokx</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> blok <span class="hljs-keyword">in</span> blokx
    WORLD.bglayer.push blok

UNIONTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"unfuck block overlaps"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    blocks = blocksatpoint WORLD.bglayer, p
    <span class="hljs-keyword">if</span> blocks.length == <span class="hljs-number">2</span>
      a=blocks[<span class="hljs-number">0</span>]
      b=blocks[<span class="hljs-number">1</span>]
      blockcarve a,b
      WORLD.bglayer = _.without WORLD.bglayer, a
      WORLD.bglayer = _.without WORLD.bglayer, b
      stage.removeChild a._pixisprite
      stage.removeChild b._pixisprite
<span class="hljs-function">
<span class="hljs-title">carveoutblock</span> = <span class="hljs-params">(b)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>copy because reasons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  block = <span class="hljs-keyword">new</span> Block b.x, b.y, b.w, b.h
  tocarve=block.allstrictoverlaps()
  <span class="hljs-keyword">for</span> bloke <span class="hljs-keyword">in</span> tocarve
    blockcarve bloke,block
  todelete=block.allstrictoverlaps()
  <span class="hljs-keyword">for</span> bloke <span class="hljs-keyword">in</span> todelete
    WORLD.bglayer = _.without WORLD.bglayer, bloke
    <span class="hljs-keyword">if</span> bloke._pixisprite?
      stage.removeChild bloke._pixisprite


CARVER=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"block carver"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>ADD BLOCK, LEFT MBUTTON
HOLD Z TO SNAP TO GRID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    CARVER.creatingblock=new Block adjusted.x, adjusted.y, 32, 32
    WORLD.bglayer.push CARVER.creatingblock
  mouseup: (e) -&gt;
    if e.button != 0 then return
    CARVER.creatingblock.fixnegative()
    carveoutblock CARVER.creatingblock
    CARVER.creatingblock = false
  mousemove: (e) -&gt;
    mpos = snapmouseadjust adjustmouseevent e
    creatingblock = CARVER.creatingblock
    if creatingblock
      creatingblock.w = mpos.x-creatingblock.x
      creatingblock.h = mpos.y-creatingblock.y
      creatingblock.src="lila.png"
      creatingblock.removesprite()
    if ORIGCLICKPOS
      currclickpos=V e.pageX, e.pageY
      offset=currclickpos.vsub ORIGCLICKPOS
      camera.offset = offset

WATERTOOL=_.extend {}, NOOPTOOL,
  name: "turn block into water"
  mousedown: (e) -&gt;
    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    blocksundercursor = blocksatpoint WORLD.bglayer, adjusted
    for bl in blocksundercursor
      WORLD.spritelayer.unshift new Water bl.x, bl.y, bl.w, bl.h
      bglayer_remove_block bl

alltools = [ BLOCKCREATIONTOOL, MOVEBLOCKTOOL, MOVETOOL, TRIANGLETOOL, SPAWNERTOOL, TELEPORTTOOL, UNIONTOOL, CARVER, WATERTOOL ]
toolbar = $ xmltag 'div', class: 'toolbar'
toolbar.append $ xmltag 'em', undefined, 'tools:'
toolbar.insertAfter $(renderer.view)

alltools.forEach (t) -&gt;
  but=$ xmltag 'button', undefined, t.name
  but.click -&gt; tool = t
  toolbar.append but

allactions={}
@allactions = allactions

bindaction = ( key, actionname ) -&gt;
  control.keytapbindname key, actionname, allactions[actionname]
@bindaction = bindaction

readablebindings = -&gt;
  ks=_.keys control.bindingnames
  vs=_.values control.bindingnames
  ks=ks.map (k) -&gt; keyCodeToChar[Number(k)]
  return _.zip ks,vs

allactions['spawn block under hero'] = -&gt;
  p = ladybug.pos.vadd V -32, 0
  creatingblock=new Block p.x, p.y, 64, 64
  WORLD.bglayer.push creatingblock

getotherhero = -&gt;
  heroes = jame.WORLD.spritelayer.filter (ent) -&gt; ent instanceof Hero
  i = heroes.indexOf ladybug
  i = (i+1)%heroes.length
  return heroes[i]

allactions['swap character'] = -&gt;
  ladybug = getotherhero()
  camera.trackingent = ladybug

bindaction("u","swap character")

unzip = (data) -&gt;
  _.zip.apply _, data

allactions['export keybindings'] = -&gt;
  data=JSON.stringify readablebindings()
  window.open().document.write data
allactions['import keybindings'] = -&gt;
  rawdata=prompt 'paste data here'
  newbinds=[]
  newholdbinds=[]
  if rawdata?
    data=JSON.parse rawdata
    for k,v of data
      k = keyCharToCode[v[0]]
      v = v[1]
      console.log k,v
      func=control.bindings[k]
      if func?
        newbinds.push k: k, name: v, f:func
      func=control.holdbindings[k]
      if func?
        newholdbinds.push k: k, name: v, f:func
    
    console.log newbinds
    console.log newholdbinds
    control.bindings={}
    control.holdbindings={}
    control.bindingnames={}
    newbinds.forEach (binding) -&gt;
      control.bindings[binding.k]=binding.f
    newholdbinds.forEach (binding) -&gt;
      control.holdbindings[binding.k]=binding.f


allactions['export level'] = -&gt;
  ents=WORLD.getallents()
  spawners = ents.filter (ent) -&gt; ent instanceof Spawner
  data=ents: spawners, blockdata: WORLD.bglayer
  window.open().document.write JSON.stringify data

loadlevel = (data) -&gt;
  loadblocks data.blockdata
  loadents data.ents
  
allactions['import level'] = -&gt;
  rawdata=prompt 'paste data here'
  if rawdata?
    data=JSON.parse rawdata
    WORLD.clear()
    loadlevel data
    WORLDINIT()
    ladybug.respawn()

allactions['load .json test level'] = -&gt;
  levelfilename = "levels/2.json"
  $.ajax levelfilename, success: (data,status,xhr) -&gt;
    jsondata=JSON.parse data
    WORLD.clear()
    loadlevel jsondata
    WORLDINIT()
    ladybug.respawn()

allactions['become queen of the slimes'] = -&gt;
  WORLD.spritelayer.push hat= new Hat()
  hat.src = 'crown.png'
  hat.parent=royaljel

highlightoverlaps = -&gt;
  blox=WORLD.bglayer</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>alloverlaps = blox.map (b) -&gt; blox.filter (b2) -&gt; b2.overlaps b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  alloverlaps = blox.map (b) -&gt; b.alloverlaps()
  alloverlaps = alloverlaps.filter (i) -&gt; i.length &gt; <span class="hljs-number">1</span>
  flatlaps = _.flatten alloverlaps
  blox.forEach (b) -&gt; b.HIGHLIGHT = <span class="hljs-literal">undefined</span>
  flatlaps.forEach (b) -&gt; b.HIGHLIGHT = <span class="hljs-literal">true</span>

allactions[<span class="hljs-string">'highlight overlapping blocks'</span>] = highlightoverlaps
<span class="hljs-function">
<span class="hljs-title">objnames</span> = <span class="hljs-params">(objs)</span> -&gt;</span>
  objs.map (obj) -&gt; obj.constructor.name
allactions[<span class="hljs-string">'generate entity list'</span>] = <span class="hljs-function">-&gt;</span>
  entlist = $ <span class="hljs-string">"&lt;div&gt;"</span>
  body.append entlist
  entlist.html objnames(WORLD.spritelayer).join()


toolbar.append $ xmltag <span class="hljs-string">'em'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">'actions: '</span>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> allactions
  but=$ xmltag <span class="hljs-string">'button'</span>, <span class="hljs-literal">undefined</span>, k
  but.click v
  toolbar.append but


ORIGCLICKPOS = <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">mousemiddledownhandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  ORIGCLICKPOS = V e.pageX, e.pageY
<span class="hljs-function"><span class="hljs-title">mousemiddleuphandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  ORIGCLICKPOS = <span class="hljs-literal">false</span>
  camera.offset = V()


$(renderer.view).mousedown mousemiddledownhandler
$(renderer.view).mouseup mousemiddleuphandler
<span class="hljs-function">
<span class="hljs-title">bglayer_remove_block</span> = <span class="hljs-params">(ent)</span> -&gt;</span>
  WORLD.bglayer = _.without WORLD.bglayer, ent</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>stage.removeChild ent._pixisprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removesprite ent
<span class="hljs-function">
<span class="hljs-title">mouserightdownhandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  adjusted = adjustmouseevent e
  blox=blocksatpoint WORLD.bglayer, adjusted
  <span class="hljs-keyword">if</span> blox.length &gt; <span class="hljs-number">0</span>
    ent=blox[<span class="hljs-number">0</span>]
    bglayer_remove_block ent

$(renderer.view).mousedown mouserightdownhandler

$(renderer.view).contextmenu -&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#NOOP</span>

$(renderer.view).bind <span class="hljs-string">'wheel'</span>, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  e.preventDefault()
  delta=e.originalEvent.deltaY
  up=delta&gt;<span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> up <span class="hljs-keyword">then</span> camera.zoomout()
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> up <span class="hljs-keyword">then</span> camera.zoomin()
<span class="hljs-function">
<span class="hljs-title">lastmodified</span> = <span class="hljs-params">(date)</span> -&gt;</span>
  body.prepend <span class="hljs-string">"&lt;p&gt;last modified <span class="hljs-subst">#{jQuery.timeago(<span class="hljs-keyword">new</span> Date(date))}</span>, <span class="hljs-subst">#{date}</span>&lt;/p&gt;"</span>

$.ajax THISFILE, <span class="hljs-attribute">type</span>: <span class="hljs-string">"HEAD"</span>, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,satus,xhr)</span> -&gt;</span>
  lastmodified xhr.getResponseHeader <span class="hljs-string">"Last-Modified"</span>

root = exports ? <span class="hljs-keyword">this</span>


spawnselection = $ xmltag <span class="hljs-string">'select'</span>
<span class="hljs-keyword">for</span> classname <span class="hljs-keyword">of</span> spawnables
  spawnselection.append $ xmltag <span class="hljs-string">'option'</span>, <span class="hljs-attribute">value</span>: classname, classname
toolbar.append $ xmltag <span class="hljs-string">'em'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"entity class:"</span>
toolbar.append spawnselection
spawnselection.change (e) -&gt;
  SPAWNTOOL.classname = $(@).val()
  
jame.burdme = <span class="hljs-function">-&gt;</span>
  ladybug = <span class="hljs-keyword">new</span> PlayerBurd()
  WORLD.entities.push ladybug

jame.WORLD = WORLD

jame.control = control


root.jame = jame
root.stage = stage



<span class="hljs-attribute">Block</span>::allstrictoverlaps = <span class="hljs-function">-&gt;</span>
  blox=WORLD.bglayer
  <span class="hljs-keyword">return</span> blox.filter (otherblock) =&gt; <span class="hljs-property">@strictoverlaps</span> otherblock
<span class="hljs-attribute">Block</span>::alloverlaps = <span class="hljs-function">-&gt;</span>
  blox=WORLD.bglayer
  <span class="hljs-keyword">return</span> blox.filter (otherblock) =&gt; <span class="hljs-property">@overlaps</span> otherblock
<span class="hljs-attribute">Block</span>::equals = <span class="hljs-function"><span class="hljs-params">(b)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-property">@x</span>=b.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span>=b.y <span class="hljs-keyword">and</span> <span class="hljs-property">@w</span>=b.w <span class="hljs-keyword">and</span> <span class="hljs-property">@h</span>=b.h

jame.cleanobj = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  arr= ( [key,val] <span class="hljs-keyword">for</span> own key,val <span class="hljs-keyword">of</span> obj)
  <span class="hljs-keyword">return</span> _.object arr</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
