<!DOCTYPE html>

<html>
<head>
  <title>platformindev.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="animtest.html">
                animtest.coffee
              </a>
            
              
              <a class="source" href="collision.html">
                collision.coffee
              </a>
            
              
              <a class="source" href="geometry.html">
                geometry.coffee
              </a>
            
              
              <a class="source" href="geometry.html">
                geometry.js
              </a>
            
              
              <a class="source" href="helpers.html">
                helpers.coffee
              </a>
            
              
              <a class="source" href="keyboarddisplay.html">
                keyboarddisplay.coffee
              </a>
            
              
              <a class="source" href="keycodes.html">
                keycodes.js
              </a>
            
              
              <a class="source" href="pixelprocessing.html">
                pixelprocessing.coffee
              </a>
            
              
              <a class="source" href="platform.html">
                platform.coffee
              </a>
            
              
              <a class="source" href="platformindev.html">
                platformindev.coffee
              </a>
            
              
              <a class="source" href="quadtree.html">
                quadtree.coffee
              </a>
            
              
              <a class="source" href="~~~platformindev.html">
                ~~~platformindev.coffee
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>platformindev.coffee</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>video gem
dependencies:
jQuery
Underscore.js
pixi.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
THISFILE = <span class="hljs-string">"src/platformindev.coffee"</span>

settings=
  <span class="hljs-attribute">gridsize</span>: <span class="hljs-number">16</span>
  <span class="hljs-attribute">fps</span>: <span class="hljs-number">30</span>
  drawsprites : <span class="hljs-literal">true</span>
  slowmo : <span class="hljs-literal">false</span>
  altcostume : <span class="hljs-literal">true</span>
  beanmode : <span class="hljs-literal">false</span>
  muted : <span class="hljs-literal">true</span>
  paused : <span class="hljs-literal">false</span>
  volume : <span class="hljs-number">0.2</span>
  decemberween : <span class="hljs-literal">false</span>
  hat : <span class="hljs-literal">false</span>
  variablejump : <span class="hljs-literal">false</span>
  moonjump : <span class="hljs-literal">false</span>
  threedee : <span class="hljs-literal">false</span>
  whoaoa : <span class="hljs-literal">false</span>
  NOSUBSCREENS : <span class="hljs-literal">true</span>
  NOCOLLS : <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>need this for some CSS</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>browserprefix = <span class="hljs-string">'-webkit-'</span>

is_firefox = navigator.userAgent.toLowerCase().indexOf(<span class="hljs-string">'firefox'</span>) &gt; -<span class="hljs-number">1</span>;
<span class="hljs-keyword">if</span> is_firefox <span class="hljs-keyword">then</span> browserprefix = <span class="hljs-string">'-moz-'</span>

stats=
  <span class="hljs-attribute">collisionchecks</span>: <span class="hljs-number">0</span>

settings.scale=<span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>screensize = new V2d 64<em>16</em>settings.scale, 64<em>9</em>settings.scale</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>screensize = <span class="hljs-keyword">new</span> V2d <span class="hljs-number">960</span>, <span class="hljs-number">540</span> <span class="hljs-comment"># halved 1080p</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>screensize = new V2d 320, 240 # GCW Zero</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

sourcebaseurl = <span class="hljs-string">"./sprites/"</span>
audiobaseurl=<span class="hljs-string">"./audio/"</span>

mafs.randfloat = <span class="hljs-function">-&gt;</span> -<span class="hljs-number">1</span>+Math.random()*<span class="hljs-number">2</span>
mafs.randvec = <span class="hljs-function">-&gt;</span> V mafs.randfloat(), mafs.randfloat()
mafs.randint = <span class="hljs-function"><span class="hljs-params">(max)</span> -&gt;</span> Math.floor Math.random()*max
mafs.randelem = <span class="hljs-function"><span class="hljs-params">(arr)</span> -&gt;</span> arr[mafs.randint(arr.length)]
mafs.degstorads = <span class="hljs-function"><span class="hljs-params">(degs)</span> -&gt;</span> degs*Math.PI/<span class="hljs-number">180</span>

Line2d = mafs.Line2d
HitboxRayIntersect = mafs.HitboxRayIntersect
pointlisttoedges = mafs.pointlisttoedges

body = $ <span class="hljs-string">"body"</span>
<span class="hljs-function">
<span class="hljs-title">V</span> = <span class="hljs-params">(x=<span class="hljs-number">0</span>,y=<span class="hljs-number">0</span>)</span> -&gt;</span> <span class="hljs-keyword">new</span> V2d x,y
<span class="hljs-function"><span class="hljs-title">PP</span> = <span class="hljs-params">(x,y)</span> -&gt;</span> <span class="hljs-keyword">new</span> PIXI.Point x,y
<span class="hljs-function"><span class="hljs-title">VTOPP</span> = <span class="hljs-params">(v)</span> -&gt;</span> PP v.x, v.y

audiocache = []
audiocachelength = <span class="hljs-number">10</span>
<span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..audiocachelength]
  audiocache[n] = <span class="hljs-keyword">new</span> Audio()

curraudiotrack=<span class="hljs-number">0</span>
<span class="hljs-function">
<span class="hljs-title">playsound</span> = <span class="hljs-params">( src )</span> -&gt;</span>
  curraudiotrack++
  curraudiotrack=curraudiotrack%audiocachelength
  <span class="hljs-keyword">if</span> settings.muted <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  snd = audiocache[curraudiotrack]
  snd.src = audiobaseurl+src
  snd.volume = settings.volume
  snd.play()

parentstage = <span class="hljs-keyword">new</span> PIXI.Stage <span class="hljs-number">0x66FF99</span>

dotfilt = <span class="hljs-keyword">new</span> PIXI.filters.DotScreenFilter()
dotfilt.scale = <span class="hljs-number">6</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>parentstage.filters = [dotfilt]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

stage = <span class="hljs-keyword">new</span> PIXI.Container
parentstage.addChild stage

hitboxlayer = <span class="hljs-keyword">new</span> PIXI.Container
stage.addChild hitboxlayer
<span class="hljs-function"><span class="hljs-title">resetstage</span> = -&gt;</span>
  parentstage.removeChild stage
  stage = <span class="hljs-keyword">new</span> PIXI.Container
  parentstage.addChild stage
  hitboxlayer = <span class="hljs-keyword">new</span> PIXI.Container
  stage.addChild hitboxlayer


HUDLAYER = <span class="hljs-keyword">new</span> PIXI.Container
parentstage.addChild HUDLAYER

renderer = PIXI.autoDetectRenderer screensize.x, screensize.y

pausescreen = <span class="hljs-keyword">new</span> PIXI.Graphics()
pausescreen.beginFill <span class="hljs-number">0x000000</span>
pausescreen.drawRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, screensize.x, screensize.y
pausescreen.alpha = <span class="hljs-number">0.5</span>

pausetext = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"PAUSED"</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"32px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>, <span class="hljs-attribute">strokeThickness</span>: <span class="hljs-number">8</span>, <span class="hljs-attribute">stroke</span>:<span class="hljs-string">'red'</span>}
pausetext.position = VTOPP screensize.ndiv <span class="hljs-number">2</span>
pausetext.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
pausescreen.addChild pausetext

pausetext = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"GO GET SOME SNACKS\nPERHAPS A CARBONATED SODA"</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"16px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>}
pausetext.position = VTOPP screensize.ndiv(<span class="hljs-number">2</span>).vadd(V(<span class="hljs-number">0</span>,<span class="hljs-number">64</span>))
pausetext.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>
pausescreen.addChild pausetext

bogglescreen = <span class="hljs-keyword">new</span> PIXI.Graphics()
bogglescreen.beginFill <span class="hljs-number">0xFF00FF</span>
bogglescreen.drawRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, screensize.x, screensize.y
bogglescreen.alpha = <span class="hljs-number">0.5</span>
tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-string">'smooch.png'</span>
bogsprite = <span class="hljs-keyword">new</span> PIXI.Sprite tex
bogsprite.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
bogsprite.position = VTOPP screensize.ndiv <span class="hljs-number">2</span>
bogsprite.scale = PP <span class="hljs-number">2</span>, <span class="hljs-number">2</span>
text = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-string">"""
  wow a secret
  warning, the following sprite is EXTREMELY CANON and EXTREMELY SEXY,
  childrens avert your eyes
  """</span>,
  { <span class="hljs-attribute">font</span>: <span class="hljs-string">"16px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"white"</span>}
text.position = VTOPP screensize.ndiv(<span class="hljs-number">2</span>).vadd(V(<span class="hljs-number">0</span>,-<span class="hljs-number">128</span>))
text.anchor = PP <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>
bogglescreen.addChild text
bogglescreen.addChild bogsprite


tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-string">'titleplaceholder.png'</span>
titlescreen = <span class="hljs-keyword">new</span> PIXI.Sprite tex

body.append renderer.view


B_MASKING = <span class="hljs-literal">false</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Subscreen</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>@size= #V 300, 200</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-property">@size</span> = screensize.ndiv <span class="hljs-number">4</span>
    <span class="hljs-property">@screenpos</span> = V <span class="hljs-number">640</span>*Math.random(), <span class="hljs-number">640</span>*Math.random()
    <span class="hljs-property">@subscreen</span>= <span class="hljs-keyword">new</span> PIXI.RenderTexture renderer, <span class="hljs-property">@size</span>.x, <span class="hljs-property">@size</span>.y
    <span class="hljs-property">@subsprite</span>= <span class="hljs-keyword">new</span> PIXI.Sprite <span class="hljs-property">@subscreen</span>
    parentstage.addChild <span class="hljs-property">@subsprite</span>
    <span class="hljs-keyword">if</span> B_MASKING
      <span class="hljs-property">@mask</span> = <span class="hljs-keyword">new</span> PIXI.Graphics()
      parentstage.addChild <span class="hljs-property">@mask</span>
<span class="hljs-attribute">Subscreen</span>::subscreenadjust = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> settings.NOSUBSCREENS <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  maxpos=screensize.vsub <span class="hljs-property">@size</span>
  hero=getotherhero()
  p1=ladybug.pos
  p2=hero.pos
  tmpdirection = p2.vsub(p1).norm()
  tmpv = tmpdirection.nadd <span class="hljs-number">1</span>
  tmpv = tmpv.ndiv <span class="hljs-number">2</span>
  newpos = maxpos.vmul tmpv
  <span class="hljs-property">@screenpos</span> = newpos
  <span class="hljs-property">@subsprite</span>.position = VTOPP <span class="hljs-property">@screenpos</span>
  subscreencentercam = hero.pos.nmul -scale
  subscreencentercam = subscreencentercam.vadd <span class="hljs-property">@size</span>.ndiv <span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>hacky but remove the screen from the stage before rendering
so it doesnt render on top of itself as a black screen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  parentstage.removeChild <span class="hljs-property">@subsprite</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>tmpinnerstage.position = VTOPP subscreencentercam
tmpinnerstage.addChild stage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  oldpos=stage.position
  stage.position = VTOPP subscreencentercam
  <span class="hljs-property">@subscreen</span>.render parentstage
  stage.position=oldpos
  parentstage.addChild <span class="hljs-property">@subsprite</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>parentstage.addChild @mask</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> B_MASKING
    <span class="hljs-property">@maskupdate</span>()
    <span class="hljs-property">@subsprite</span>.mask = <span class="hljs-property">@mask</span>
<span class="hljs-attribute">Subscreen</span>::maskupdate = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@mask</span>.clear()
  <span class="hljs-property">@mask</span>.beginFill( <span class="hljs-number">0x000000</span>, <span class="hljs-number">0.9</span> )
  <span class="hljs-property">@mask</span>.moveTo <span class="hljs-property">@screenpos</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-number">32</span>
  <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x+<span class="hljs-property">@size</span>.x, <span class="hljs-property">@screenpos</span>.y
  <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x+<span class="hljs-property">@size</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-property">@size</span>.y-<span class="hljs-number">32</span>
  <span class="hljs-property">@mask</span>.lineTo <span class="hljs-property">@screenpos</span>.x, <span class="hljs-property">@screenpos</span>.y+<span class="hljs-property">@size</span>.y
  <span class="hljs-property">@mask</span>.endFill()

SCREENS = <span class="hljs-attribute">list</span>: []
SCREENS.add = <span class="hljs-function">-&gt;</span>
   SCREENS.list.push <span class="hljs-keyword">new</span> Subscreen()
SCREENS.adjust = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@list</span>.forEach (screen) -&gt;
    screen.subscreenadjust()</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>adding subscreens   duh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>SCREENS.add()

scale = <span class="hljs-number">1</span>

tmpstage = <span class="hljs-keyword">new</span> PIXI.Container()
tmpinnerstage = <span class="hljs-keyword">new</span> PIXI.Container()
tmpstage.addChild tmpinnerstage
<span class="hljs-function">

<span class="hljs-title">animate</span> = -&gt;</span>
  cam=cameraoffset().nmul -scale
  stage.position = VTOPP cam
  stage.scale = PP scale, scale
  renderer.render parentstage
  SCREENS.adjust()

chievs={}
<span class="hljs-function">
<span class="hljs-title">achieve</span> = <span class="hljs-params">(title)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> chievs[title].gotten? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  chievs[title].gotten = <span class="hljs-literal">true</span>
  makechievbox chievs[title].pic, mafs.randelem chievs[title].text

bogimg = xmltag <span class="hljs-string">'img'</span>, <span class="hljs-attribute">src</span>: sourcebaseurl+<span class="hljs-string">'boggle.png'</span>
chievs.win = <span class="hljs-attribute">pic</span>: <span class="hljs-string">'crown.png'</span>, <span class="hljs-attribute">text</span>: [ <span class="hljs-string">"wow"</span> ]
chievs.fall = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"lovelyfall.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"Fractured spine"</span>, <span class="hljs-string">"Faceplant"</span>, <span class="hljs-string">"Dats gotta hoit"</span>, <span class="hljs-string">"OW FUCK"</span>,
  <span class="hljs-string">"pomf =3"</span>, <span class="hljs-string">"Broken legs"</span>, <span class="hljs-string">"Have a nice trip"</span>, <span class="hljs-string">"Ow my organs"</span>, <span class="hljs-string">"Shattered pelvis"</span>, <span class="hljs-string">"Bugsplat"</span> ]
chievs.kick = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"jelly.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"3 points field goal"</span>, <span class="hljs-string">"Into the dunklesphere"</span>,
  <span class="hljs-string">"Blasting off again"</span>, <span class="hljs-string">"pow zoom straight to the moon"</span> ]
chievs.boggle = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"boggle.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"Buggy the boggle champ"</span>, <span class="hljs-string">"Bushboggler 2013"</span>, <span class="hljs-string">"Boggle that bush"</span>,
  <span class="hljs-string">"Collosal waste of time"</span>, <span class="hljs-string">"Boggle 2: Electric boggleoo"</span>, <span class="hljs-string">"Buggy bushboggle"</span>,
  <span class="hljs-string">"excuse me wtf are you doing"</span>, <span class="hljs-string">"Bush it, bush it real good"</span>, <span class="hljs-string">"Fondly regard flora"</span>,
  <span class="hljs-string">"&amp;lt;chievo title unavailable due to trademark infringement&amp;gt;"</span>, <span class="hljs-string">"Returning a bug to its natural habitat"</span>,
  <span class="hljs-string">"Bush it to the limit"</span>, <span class="hljs-string">"Live Free or Boggle Hard"</span>, <span class="hljs-string">"Identifying bushes, accurate results with simple tools"</span>,
  <span class="hljs-string">"Bugtester"</span>, <span class="hljs-string">"A proper lady (bug)"</span>, <span class="hljs-string">"Stupid achievement title"</span>, <span class="hljs-string">"The daily boggle"</span>, bogimg+bogimg+bogimg ]
chievs.murder = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"lovelyshorter.png"</span>, <span class="hljs-attribute">text</span>: [ <span class="hljs-string">"This isn't brave, it's murder"</span>, <span class="hljs-string">"Jellycide"</span> ]
chievs.target = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"target.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"there's no achievement for this"</span>, <span class="hljs-string">"\"Pow, motherfucker, pow\" -socrates"</span>,
  <span class="hljs-string">"Expect more. Pay less."</span>, <span class="hljs-string">"You're supposed to use arrows you dingus"</span> ]
chievs.start = <span class="hljs-attribute">pic</span>: <span class="hljs-string">"crown.png"</span>, <span class="hljs-attribute">text</span>: [
  <span class="hljs-string">"wow u started playin the game, congrats"</span>, <span class="hljs-string">"walking to the right"</span>,
  <span class="hljs-string">"chievo modern gaming edition"</span>, <span class="hljs-string">"baby's first achievement"</span> ]
<span class="hljs-function">

<span class="hljs-title">makechievbox</span> = <span class="hljs-params">( src, text )</span> -&gt;</span>
  style=<span class="hljs-string">"style='display: inline-block; margin-left: 16px'"</span>
  body.append chievbox = $(
    <span class="hljs-string">"&lt;div class=chievbox&gt;&lt;span <span class="hljs-subst">#{style}</span>&gt;&lt;b&gt;ACHIEVEMENT UNLOCKED&lt;/b&gt;&lt;br/&gt;<span class="hljs-subst">#{text}</span>&lt;/span&gt;&lt;/div&gt;"</span>)
  chievbox.prepend pic=$ xmltag <span class="hljs-string">'img'</span>, <span class="hljs-attribute">src</span>: sourcebaseurl+src
  chievbox.animate( <span class="hljs-attribute">top</span>: <span class="hljs-string">'32px'</span> ).delay <span class="hljs-number">4000</span>
  chievbox.animate( { <span class="hljs-attribute">top</span>: <span class="hljs-string">'-100px'</span>}, { <span class="hljs-attribute">queue</span>: <span class="hljs-literal">true</span> } ).delay <span class="hljs-number">2000</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@pos</span>=V()
<span class="hljs-attribute">Renderable</span>::hassprite = <span class="hljs-function">-&gt;</span> <span class="hljs-keyword">typeof</span> @._pixisprite <span class="hljs-keyword">isnt</span> <span class="hljs-string">"undefined"</span>
<span class="hljs-attribute">Renderable</span>::removesprite = <span class="hljs-function">-&gt;</span> removesprite @
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericSprite</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V(), <span class="hljs-property">@src</span> )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
    flip=<span class="hljs-keyword">not</span> <span class="hljs-property">@facingleft</span>
    box= <span class="hljs-property">@gethitbox</span>()
    pos=relativetobox box, anchor
    drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor
<span class="hljs-attribute">GenericSprite</span>::cleanup = <span class="hljs-function">-&gt;</span>
  removesprite @

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Noisemaker</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@age</span>=<span class="hljs-number">0</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@age</span>++
    <span class="hljs-keyword">if</span> <span class="hljs-property">@age</span> &gt; <span class="hljs-number">4</span> <span class="hljs-keyword">and</span> Math.random() &gt; <span class="hljs-number">2</span>/<span class="hljs-number">3</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@age</span> &gt; <span class="hljs-number">4</span>
      playsound mafs.randelem [ <span class="hljs-string">'horse.wav'</span>, <span class="hljs-string">'pone.wav'</span>, <span class="hljs-string">'but.wav'</span> ]
      <span class="hljs-property">@age</span>=<span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>LOAD PROPERTIES FROM AN OBJECT
for example to initialize from .json level data</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">GenericSprite</span>::load = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> obj.pos?
    _.extend <span class="hljs-property">@pos</span>, obj.pos

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlaceholderSprite</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@pos</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>
    <span class="hljs-property">@label</span>=<span class="hljs-string">'a thing'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span>
<span class="hljs-attribute">PlaceholderSprite</span>::render = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@_pixisprite</span>?
    sprit=<span class="hljs-property">@_pixisprite</span>
    sprit.position = VTOPP <span class="hljs-property">@pos</span>
    <span class="hljs-keyword">return</span>
  txt = <span class="hljs-keyword">new</span> PIXI.Text <span class="hljs-property">@label</span>,
    { <span class="hljs-attribute">font</span>: <span class="hljs-string">"12px Arial"</span>, <span class="hljs-attribute">fill</span>:<span class="hljs-string">"black"</span> }
  txt.anchor = VTOPP <span class="hljs-property">@anchor</span>
  sprit = <span class="hljs-keyword">new</span> PIXI.Graphics()
  sprit.beginFill <span class="hljs-number">0xFF00FF</span>
  sprit.pivot = VTOPP V <span class="hljs-number">0</span>, <span class="hljs-number">32</span>
  box=<span class="hljs-property">@gethitbox</span>()
  sprit.position = VTOPP <span class="hljs-property">@pos</span>
  sprit.drawRect <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, box.w, box.h
  sprit.alpha = <span class="hljs-number">0.9</span>
  sprit.addChild txt
  stage.addChild sprit
  <span class="hljs-property">@_pixisprite</span>=sprit

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span> = <span class="hljs-string">"hat.png"</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    <span class="hljs-property">@parent</span> = ladybug
<span class="hljs-attribute">Hat</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@parent</span>.vel
  <span class="hljs-property">@pos</span> = relativetobox <span class="hljs-property">@parent</span>.gethitbox() , V(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">0</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>@pos = @pos.vadd @vel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
_DEFAULTHITBOXSIZE = V <span class="hljs-number">32</span>, <span class="hljs-number">32</span>
<span class="hljs-attribute">GenericSprite</span>::gethitbox = <span class="hljs-function">-&gt;</span>
  size=<span class="hljs-property">@size</span> <span class="hljs-keyword">or</span> _DEFAULTHITBOXSIZE
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span></pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>@hitboxcache ?= makebox @pos, size, anchor
fuck it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@hitboxcache</span> = makebox <span class="hljs-property">@pos</span>, size, anchor
  <span class="hljs-property">@hitboxcache</span>
<span class="hljs-attribute">GenericSprite</span>::updatehitbox = <span class="hljs-function">-&gt;</span>
  size=<span class="hljs-property">@size</span> <span class="hljs-keyword">or</span> _DEFAULTHITBOXSIZE
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@hitboxcache</span>?
    [ x, y, w, h ] = fixbox <span class="hljs-property">@pos</span>, size, anchor
    <span class="hljs-property">@hitboxcache</span>.x = x
    <span class="hljs-property">@hitboxcache</span>.y = y
    <span class="hljs-property">@hitboxcache</span>.w = w
    <span class="hljs-property">@hitboxcache</span>.h = h
  <span class="hljs-keyword">return</span> <span class="hljs-property">@hitboxcache</span>
<span class="hljs-function">
<span class="hljs-title">fixbox</span> = <span class="hljs-params">(position, dimensions, anchor)</span> -&gt;</span>
  truepos = position.vsub dimensions.vmul anchor
  <span class="hljs-keyword">return</span> [ truepos.x, truepos.y, dimensions.x, dimensions.y ]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Target</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'target.png'</span>
    <span class="hljs-property">@lifetime</span>=-<span class="hljs-number">1</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
      <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
    <span class="hljs-keyword">if</span> otherent.timers?.attack? <span class="hljs-keyword">and</span> otherent.timers?.attack &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-attribute">gethitby</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@broken</span>
      <span class="hljs-property">@broken</span>=<span class="hljs-literal">true</span>
      <span class="hljs-property">@src</span> = <span class="hljs-string">'shatteredtarget.png'</span>
      <span class="hljs-property">@vel</span> = otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
      <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Jelly</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'jelly.png'</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Jelly
      <span class="hljs-property">@vel</span>.x = (<span class="hljs-property">@vel</span>.x+otherent.vel.x)/<span class="hljs-number">2</span>
      <span class="hljs-property">@pos</span>.x+=mafs.randfloat()*<span class="hljs-number">2</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
      <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span></pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>player bounce</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady <span class="hljs-keyword">and</span> otherent.vel.y &gt; <span class="hljs-number">0</span>
      otherent.vel.y *= -<span class="hljs-number">2</span>
    timeout=otherent.timers?.attack
    <span class="hljs-keyword">if</span> timeout? <span class="hljs-keyword">and</span> timeout &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-attribute">gethitby</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>.y += otherent.vel.y
    dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">4</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    flip = tickno%<span class="hljs-number">10</span>&lt;<span class="hljs-number">5</span>
    anchor = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    pos=relativetobox(<span class="hljs-property">@gethitbox</span>(),anchor)
    drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor


<span class="hljs-attribute">Jelly</span>::size = V(<span class="hljs-number">32</span>,<span class="hljs-number">16</span>)
<span class="hljs-attribute">Jelly</span>::anchor = V(<span class="hljs-number">1</span>/<span class="hljs-number">2</span>,<span class="hljs-number">1</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bee</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'bee.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
      otherent.vel.y *= -<span class="hljs-number">2</span>
    timeout=otherent.timers?.attack
    <span class="hljs-keyword">if</span> timeout? <span class="hljs-keyword">and</span> timeout &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-attribute">gethitby</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>.y += otherent.vel.y
    dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">4</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@avoidwalls</span>()
    <span class="hljs-property">@physmove</span>()
    <span class="hljs-property">@wiggle</span>()
  <span class="hljs-attribute">wiggle</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.nmul <span class="hljs-number">9</span>/<span class="hljs-number">10</span> <span class="hljs-comment">#friction</span>
    <span class="hljs-keyword">if</span> Math.random()*<span class="hljs-number">100</span>&lt;<span class="hljs-number">50</span>
      <span class="hljs-property">@vel</span>.y += mafs.randfloat()*<span class="hljs-number">4</span>
      <span class="hljs-property">@vel</span>.x += mafs.randfloat()*<span class="hljs-number">4</span>
<span class="hljs-function">
<span class="hljs-title">entitycount</span> = <span class="hljs-params">( classtype )</span> -&gt;</span>
  ents = WORLD.spritelayer.filter (sprite) -&gt; sprite <span class="hljs-keyword">instanceof</span> classtype
  <span class="hljs-keyword">return</span> ents.length

<span class="hljs-attribute">GenericSprite</span>::gravitate = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y++
<span class="hljs-attribute">Jelly</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@jiggle</span>()
    <span class="hljs-property">@pos</span>.y--

<span class="hljs-attribute">Jelly</span>::jiggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.x*=<span class="hljs-number">9</span>/<span class="hljs-number">10</span>
  <span class="hljs-keyword">if</span> Math.random()*<span class="hljs-number">100</span>&lt;<span class="hljs-number">50</span>
    <span class="hljs-property">@vel</span>.y = -Math.random()*<span class="hljs-number">4</span>
    <span class="hljs-property">@vel</span>.x += mafs.randfloat()*<span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Fence</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@anchor</span>=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>,<span class="hljs-number">1</span>
<span class="hljs-attribute">Fence</span>::render = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Pickup</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Jelly</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"energy1.png"</span>
<span class="hljs-attribute">Pickup</span>::jiggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> <span class="hljs-comment">#noop</span>
<span class="hljs-attribute">Pickup</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
    <span class="hljs-property">@pickedup</span> otherent
<span class="hljs-attribute">Pickup</span>::pickedup = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  playsound <span class="hljs-string">'boip.wav'</span>
  <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Energy</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pickup</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"energy1.png"</span>
<span class="hljs-attribute">Energy</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framelist = [<span class="hljs-number">1.</span><span class="hljs-number">.6</span>].map (n) -&gt; <span class="hljs-string">"energy<span class="hljs-subst">#{n}</span>.png"</span>
  <span class="hljs-property">@src</span> = selectframe framelist, <span class="hljs-number">4</span>
<span class="hljs-attribute">Energy</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  <span class="hljs-property">@getsprite</span>()
<span class="hljs-attribute">Energy</span>::pickedup = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  otherent.energy += <span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Gold</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Pickup</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span>=V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">"crown.png"</span>
<span class="hljs-attribute">Gold</span>::getsprite = <span class="hljs-function">-&gt;</span>
<span class="hljs-attribute">Gold</span>::pickedup = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  otherent.score += <span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">relativetobox</span> = <span class="hljs-params">( box, anchor )</span> -&gt;</span>
  pos = V box.x, box.y
  size = V box.w, box.h
  pos = pos.vadd size.vmul anchor
  <span class="hljs-keyword">return</span> pos


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Thug</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@lifetime</span>=-<span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span> = V()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'bugthug.png'</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-literal">true</span>
    <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
bottomcenter = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">Thug</span>::size = V <span class="hljs-number">24</span>, <span class="hljs-number">64</span>+<span class="hljs-number">16</span>
<span class="hljs-attribute">Thug</span>::anchor = bottomcenter
<span class="hljs-attribute">Thug</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-property">@getsprite</span>()

<span class="hljs-attribute">Thug</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'bugthug.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@src</span>=<span class="hljs-string">'thugded.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@lifetime</span>--
    <span class="hljs-property">@src</span>=<span class="hljs-string">"bugthugoof.png"</span>

<span class="hljs-attribute">Thug</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  <span class="hljs-keyword">if</span> otherent.timers?.attack? <span class="hljs-keyword">and</span> otherent.timers?.attack &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lifetime</span> &lt;= <span class="hljs-number">0</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
    <span class="hljs-property">@gethitby</span> otherent
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Hero <span class="hljs-keyword">and</span> otherent.timers?.invincible == <span class="hljs-number">0</span>
    playsound <span class="hljs-string">'excardon.wav'</span>
    otherent.flinch()
<span class="hljs-attribute">Thug</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.y += otherent.vel.y
  dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">1</span>
  <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>
  <span class="hljs-property">@health</span>-=<span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lila</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thug</span></span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Robo</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thug</span></span>

<span class="hljs-attribute">Lila</span>::scampersubroutine = <span class="hljs-attribute">Robo</span>::scampersubroutine = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">10</span>
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">10</span>
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.abs(<span class="hljs-property">@vel</span>.x)&lt;<span class="hljs-number">3</span>
    <span class="hljs-property">@vel</span>.x += <span class="hljs-keyword">if</span> <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">then</span> -<span class="hljs-property">@scamperspeed</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@scamperspeed</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">1</span>/<span class="hljs-number">20</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-keyword">not</span> <span class="hljs-property">@facingleft</span>


<span class="hljs-attribute">Lila</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@kisstimeout</span>--
  <span class="hljs-keyword">super</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">50</span>
    <span class="hljs-keyword">return</span>
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">2</span>
  <span class="hljs-property">@scampersubroutine</span>()

<span class="hljs-attribute">Robo</span>::visioncheck = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  CENTER = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  dim = <span class="hljs-number">64</span>*<span class="hljs-number">4</span>
  visionarea = makebox @.pos, V(dim,dim), CENTER</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>@angry = visionarea.containspoint ladybug.pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@angerlevel</span> ?= <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> visionarea.containspoint ladybug.pos
    <span class="hljs-property">@angerlevel</span>++
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@angerlevel</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@angerlevel</span>--
  <span class="hljs-property">@angry</span> = <span class="hljs-property">@angerlevel</span> &gt; <span class="hljs-number">40</span>

<span class="hljs-attribute">Robo</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">super</span>()
  isdead = <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
  <span class="hljs-property">@state</span>=<span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@angry</span> <span class="hljs-keyword">then</span> <span class="hljs-string">"attacking"</span> <span class="hljs-keyword">else</span> <span class="hljs-string">"idle"</span>
  <span class="hljs-keyword">if</span> isdead
    <span class="hljs-property">@scampering</span>=<span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span>
  <span class="hljs-property">@visioncheck</span>()
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">1</span>
  <span class="hljs-property">@scamperspeed</span> = <span class="hljs-number">4</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>charge towards ladybug</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@facingleft</span> = ladybug.pos.x &lt; <span class="hljs-property">@pos</span>.x
  <span class="hljs-property">@scampersubroutine</span>()

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Turret</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Thug</span></span>
<span class="hljs-attribute">Turret</span>::visioncheck = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  CENTER = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  dim = <span class="hljs-number">64</span>*<span class="hljs-number">4</span>
  visionarea = makebox @.pos, V(dim,dim), CENTER
  <span class="hljs-property">@angry</span> = visionarea.containspoint ladybug.pos
<span class="hljs-attribute">Turret</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@visioncheck</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span> <span class="hljs-keyword">and</span> tickno % <span class="hljs-number">10</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
    firebullet @
<span class="hljs-function">
<span class="hljs-title">selectframe</span> = <span class="hljs-params">( framelist, framewait )</span> -&gt;</span>
  totalframes = framelist.length
  framechoice = Math.floor(tickno/framewait)%totalframes
  framelist[framechoice]

<span class="hljs-attribute">Lila</span>::getsprite = <span class="hljs-function">-&gt;</span>
  idlecycle = [ <span class="hljs-string">'lilaidle1.png'</span>, <span class="hljs-string">'lilaidle2.png'</span> ]
  scampercycle = (<span class="hljs-string">"lilascamper<span class="hljs-subst">#{n}</span>.png"</span> <span class="hljs-keyword">for</span> n <span class="hljs-keyword">in</span> [<span class="hljs-number">1.</span><span class="hljs-number">.4</span>])
  framewait = <span class="hljs-number">4</span>
  framelist=idlecycle
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framewait = <span class="hljs-number">20</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framelist=scampercycle
  <span class="hljs-keyword">if</span> <span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">90</span> <span class="hljs-keyword">then</span> framelist = [ <span class="hljs-string">"lilakiss.png"</span> ]
  <span class="hljs-property">@src</span> = selectframe framelist, framewait
<span class="hljs-attribute">Robo</span>::getsprite = <span class="hljs-function">-&gt;</span>
  idlecycle = [ <span class="hljs-string">'robocalm1.png'</span> ]
  scampercycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"robocalm<span class="hljs-subst">#{n}</span>.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@angerlevel</span> &gt; <span class="hljs-number">10</span>
    idlecycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"roboroll<span class="hljs-subst">#{n}</span>.png"</span>
    scampercycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"roboroll<span class="hljs-subst">#{n}</span>.png"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>scampercycle = [2..4].map (n) -&gt; “roborage#:{n}.png”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-property">@angry</span>
    idlecycle = [<span class="hljs-number">1.</span><span class="hljs-number">.2</span>].map (n) -&gt; <span class="hljs-string">"roborage<span class="hljs-subst">#{n}</span>.png"</span>
    scampercycle = [<span class="hljs-number">2.</span><span class="hljs-number">.4</span>].map (n) -&gt; <span class="hljs-string">"roborage<span class="hljs-subst">#{n}</span>.png"</span>
  framelist=idlecycle
  
  <span class="hljs-keyword">if</span> <span class="hljs-property">@scampering</span> <span class="hljs-keyword">then</span> framelist=scampercycle
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@lifetime</span>--
    framelist=[<span class="hljs-string">"robohurt.png"</span>]
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span>
    framelist=[<span class="hljs-string">"robobody.png"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>@pos.y++ #AUGH</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@lifetime</span> == <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    framelist=[<span class="hljs-string">"roboded.png"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>@pos.y—</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  framewait = <span class="hljs-number">4</span>
  <span class="hljs-property">@src</span> = selectframe framelist, framewait
<span class="hljs-attribute">Robo</span>::collide = <span class="hljs-function"><span class="hljs-params">(otherent)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Hero <span class="hljs-keyword">and</span> <span class="hljs-property">@state</span> <span class="hljs-keyword">is</span> <span class="hljs-string">"attacking"</span>
    otherent.takedamage()
<span class="hljs-attribute">Lila</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>parentstage.addChild bogglescreen</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (<span class="hljs-property">@kisstimeout</span> &gt; <span class="hljs-number">0</span>)
      ladybug.heal()
      WORLD.spritelayer.push <span class="hljs-keyword">new</span> Smoochie <span class="hljs-property">@pos</span>
    <span class="hljs-property">@kisstimeout</span> = <span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> Fence
    <span class="hljs-property">@vel</span>.x = <span class="hljs-number">0</span>
    offs = <span class="hljs-keyword">if</span> otherent.pos.x &lt; <span class="hljs-property">@pos</span>.x <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> -<span class="hljs-number">1</span>
    <span class="hljs-property">@pos</span>.x += offs

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Burd</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
    <span class="hljs-property">@src</span>=<span class="hljs-string">'burd.png'</span>
<span class="hljs-attribute">Burd</span>::tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@getsprite</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>@avoidwalls()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@pos</span>=<span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  lpos = ladybug.pos <span class="hljs-keyword">or</span> V()
  dir=lpos.vsub(<span class="hljs-property">@pos</span>).norm()
  <span class="hljs-property">@vel</span>=<span class="hljs-property">@vel</span>.vadd dir
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.mag() &gt; <span class="hljs-number">10</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.norm().nmul <span class="hljs-number">10</span>
<span class="hljs-attribute">Burd</span>::render = <span class="hljs-function">-&gt;</span>
  anchor = <span class="hljs-property">@anchor</span> <span class="hljs-keyword">or</span> V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
  flip=<span class="hljs-literal">false</span>
  pos=relativetobox(<span class="hljs-property">@gethitbox</span>(),anchor)
  drawsprite @, <span class="hljs-property">@src</span>, pos, flip, anchor
  <span class="hljs-property">@_pixisprite</span>.scale.x = <span class="hljs-number">1</span>/<span class="hljs-number">3</span>
  <span class="hljs-property">@_pixisprite</span>.scale.y = <span class="hljs-number">1</span>/<span class="hljs-number">3</span>
<span class="hljs-attribute">Burd</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framelist = [ <span class="hljs-string">'burd.png'</span>, <span class="hljs-string">'burdflap.png'</span> ]
  <span class="hljs-property">@src</span> = mafs.randelem framelist</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>@src = selectframe framelist, 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Burd</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BoggleParticle
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd otherent.vel.nmul <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  timeout=otherent.timers?.attack
  <span class="hljs-keyword">if</span> timeout? <span class="hljs-keyword">and</span> timeout &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@gethitby</span> otherent
<span class="hljs-attribute">Burd</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.y += otherent.vel.y
  dir=<span class="hljs-keyword">if</span> otherent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-property">@vel</span>.x += dir*<span class="hljs-number">4</span>
  <span class="hljs-property">@lifetime</span> = <span class="hljs-number">10</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BoggleParticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm()
    <span class="hljs-property">@src</span> = <span class="hljs-string">'huh.png'</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">50</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">8</span>

<span class="hljs-attribute">BoggleParticle</span>::render = <span class="hljs-function">-&gt;</span>
    drawsprite @, <span class="hljs-string">'emily.png'</span>, <span class="hljs-property">@pos</span>, <span class="hljs-literal">false</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Smoochie</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span> )</span> -&gt;</span>
    <span class="hljs-property">@anchor</span>=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm()
    <span class="hljs-property">@src</span> = <span class="hljs-string">'kissparticle1.png'</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">50</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    guipos = cameraoffset().nadd <span class="hljs-number">32</span>
    dif = guipos.vsub <span class="hljs-property">@pos</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;<span class="hljs-number">10</span>
      <span class="hljs-property">@vel</span>=<span class="hljs-property">@vel</span>.vadd dif.ndiv <span class="hljs-number">64</span> <span class="hljs-comment">#hacky</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">8</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd V <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-property">@getsprite</span>()
    <span class="hljs-property">@_pixisprite</span>.rotation = mafs.degstorads Math.cos(<span class="hljs-property">@life</span>/<span class="hljs-number">100</span>)*<span class="hljs-number">10</span>

<span class="hljs-attribute">Smoochie</span>::getsprite = <span class="hljs-function">-&gt;</span>
  framewait = <span class="hljs-number">16</span>
  framelist = [<span class="hljs-number">3</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>].map (n) -&gt; <span class="hljs-string">"kissparticle<span class="hljs-subst">#{n}</span>.png"</span>
  framechoice = Math.floor <span class="hljs-keyword">this</span>.life/framewait
  <span class="hljs-keyword">return</span> framelist[framechoice]

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PchooParticle</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@vel</span> = mafs.randvec().norm().ndiv <span class="hljs-number">8</span>
    <span class="hljs-property">@life</span> = <span class="hljs-number">20</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'energy4.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">64</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    drawsprite @, <span class="hljs-property">@src</span>, <span class="hljs-property">@pos</span>, <span class="hljs-literal">false</span>, <span class="hljs-property">@anchor</span>
    <span class="hljs-property">@_pixisprite</span>.alpha = <span class="hljs-number">0.25</span> + <span class="hljs-property">@life</span>/<span class="hljs-number">40</span> <span class="hljs-comment">#fading</span>
    <span class="hljs-property">@_pixisprite</span>.rotation = Math.atan2 <span class="hljs-property">@vel</span>.y, <span class="hljs-property">@vel</span>.x

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Bullet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@owner</span> = <span class="hljs-literal">undefined</span>
    <span class="hljs-property">@vel</span> = V(<span class="hljs-number">8</span>,<span class="hljs-number">0</span>)
    <span class="hljs-property">@life</span> = <span class="hljs-number">10</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">'particlepunch.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@life</span>--
    <span class="hljs-keyword">if</span> <span class="hljs-property">@life</span>&lt;=<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
    <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.vadd mafs.randvec().norm().ndiv <span class="hljs-number">64</span>
  <span class="hljs-attribute">render</span>: <span class="hljs-function">-&gt;</span>
    flip=<span class="hljs-property">@vel</span>.x&lt;<span class="hljs-number">0</span>
    drawsprite @, <span class="hljs-property">@src</span>, <span class="hljs-property">@pos</span>, flip, <span class="hljs-property">@anchor</span>
    <span class="hljs-property">@_pixisprite</span>.alpha = <span class="hljs-number">0.8</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shieldbubble</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">( <span class="hljs-property">@pos</span>=V() )</span> -&gt;</span>
    <span class="hljs-property">@owner</span> = ladybug
    <span class="hljs-property">@src</span> = <span class="hljs-string">'bubble.png'</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
  <span class="hljs-attribute">tick</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@pos</span> = <span class="hljs-property">@owner</span>.pos
    <span class="hljs-keyword">if</span> <span class="hljs-property">@_pixisprite</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@_pixisprite</span>.alpha = <span class="hljs-number">1</span>/<span class="hljs-number">2</span>

<span class="hljs-attribute">Bullet</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent.health? <span class="hljs-keyword">and</span> otherent <span class="hljs-keyword">isnt</span> <span class="hljs-property">@owner</span>
    otherent.gethitby?( <span class="hljs-property">@owner</span> )
    <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>

<span class="hljs-attribute">Target</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.nmul <span class="hljs-number">7</span>/<span class="hljs-number">10</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@lifetime</span>--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lifetime</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> entitycount(Target) <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> achieve <span class="hljs-string">"target"</span>
<span class="hljs-function">
<span class="hljs-title">isholdingkey</span> = <span class="hljs-params">(key)</span> -&gt;</span>
  key = key.toUpperCase().charCodeAt <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> key <span class="hljs-keyword">in</span> control.heldkeys
<span class="hljs-function">
<span class="hljs-title">isholdingbound</span> = <span class="hljs-params">(name)</span> -&gt;</span>
  keys=control.heldkeys.map (key) -&gt; control.bindingnames[key]
  <span class="hljs-keyword">return</span> name <span class="hljs-keyword">in</span> keys

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Hero</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@jumping</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@attacking</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@timers</span>=
      <span class="hljs-attribute">attack</span>: <span class="hljs-number">0</span>
    <span class="hljs-property">@timers</span>.attack = <span class="hljs-number">0</span>
    <span class="hljs-property">@timers</span>.stun = <span class="hljs-number">0</span>
    <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
    <span class="hljs-property">@energy</span>=<span class="hljs-number">0</span>
    <span class="hljs-property">@score</span>=<span class="hljs-number">0</span>
    <span class="hljs-property">@facingleft</span>=<span class="hljs-literal">false</span>
    <span class="hljs-property">@anchor</span> = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BugLady</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Hero</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@timers</span>.invincible=<span class="hljs-number">0</span>
    <span class="hljs-property">@controls</span>={}
    <span class="hljs-property">@controls</span>.tapstatus={}
<span class="hljs-attribute">BugLady</span>::heal = <span class="hljs-function">-&gt;</span> <span class="hljs-property">@health</span>=<span class="hljs-number">3</span>
<span class="hljs-attribute">BugLady</span>::respawn = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@pos</span> = V()
  <span class="hljs-property">@vel</span> = V()
  <span class="hljs-property">@heal</span>()
<span class="hljs-attribute">BugLady</span>::flinch = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  knockbackDir = <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">or</span> -<span class="hljs-number">1</span>
  <span class="hljs-property">@vel</span>.x *= <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  <span class="hljs-property">@vel</span>.x += knockbackDir * <span class="hljs-number">8</span></pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>@vel = @vel.vmul V -1, 1</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@timers</span>.invincible = <span class="hljs-number">20</span>
<span class="hljs-attribute">Hero</span>::gethitby = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-property">@takedamage</span>()
<span class="hljs-attribute">BugLady</span>::takedamage = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.invincible &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.stun &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@flinch</span>()
  <span class="hljs-property">@health</span>-=<span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@health</span> &lt;= <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@kill</span>()
<span class="hljs-function">

<span class="hljs-title">entcenter</span> = <span class="hljs-params">( ent )</span> -&gt;</span>
  hb=ent.gethitbox()
  <span class="hljs-keyword">return</span> V hb.x+hb.w/<span class="hljs-number">2</span>, hb.y+hb.h/<span class="hljs-number">2</span>

<span class="hljs-attribute">BugLady</span>::dmgvelocity = <span class="hljs-number">20</span>
<span class="hljs-attribute">BugLady</span>::falldamage = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-property">@dmgvelocity</span>
    <span class="hljs-property">@timers</span>.stun = <span class="hljs-number">20</span>
    <span class="hljs-property">@takedamage</span>()

<span class="hljs-attribute">GenericSprite</span>::blockcollisions = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@gethitbox</span>()
  candidates = hitboxfilter box, WORLD.bglayer
  candidates.forEach (candidate) =&gt;
    <span class="hljs-keyword">if</span> @.gethitbox().bottom() &gt;= candidate.top()
      <span class="hljs-property">@falldamage</span>?()
      <span class="hljs-property">@pos</span>.y = candidate.y
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> candidates.length &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span>
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>

  

<span class="hljs-attribute">BugLady</span>::blockcollisions = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@fallbox</span>()
  platforms = hitboxfilter box, WORLD.BOXCACHE <span class="hljs-comment">#nonstatic platforms/jellies</span>
  <span class="hljs-keyword">if</span> platforms.length &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@pos</span>.y-=<span class="hljs-number">2</span>
  candidates = hitboxfilter box, WORLD.bglayer
  candidates.forEach (candidate) =&gt;
    <span class="hljs-keyword">if</span> @.gethitbox().bottom() &lt;= candidate.top()
      <span class="hljs-property">@pos</span>.y = candidate.y
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>following lines handle ceiling collisions</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    jumpthroughable = candidate <span class="hljs-keyword">instanceof</span> OnewayBlock
    <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> jumpthroughable <span class="hljs-keyword">and</span> box.top()&gt;candidate.top()
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
<span class="hljs-function">
<span class="hljs-title">closestpoint</span> = <span class="hljs-params">(p, pointarr)</span> -&gt;</span>
  closest = pointarr[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">for</span> point <span class="hljs-keyword">in</span> pointarr
    <span class="hljs-keyword">if</span> closest.dist(p) &gt; point.dist(p)
      closest = point
  <span class="hljs-keyword">return</span> closest

<span class="hljs-attribute">BugLady</span>::polygoncollisions = <span class="hljs-function">-&gt;</span>
  allpolygons = WORLD.spritelayer.filter (sprit) -&gt; sprit <span class="hljs-keyword">instanceof</span> Poly
  allpolygons.forEach (candidate) =&gt;
    p = <span class="hljs-keyword">new</span> V2d <span class="hljs-property">@pos</span>.x, <span class="hljs-property">@pos</span>.y
    trajectory = <span class="hljs-keyword">new</span> Line2d <span class="hljs-property">@pos</span>, <span class="hljs-property">@pos</span>.vadd(<span class="hljs-property">@vel</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>if trajectory.lineintersect</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    edges = pointlisttoedges candidate.points
    hits=edges.map (edg) -&gt; trajectory.lineintersect edg
    hits = _.compact hits <span class="hljs-comment">#strip nulls</span>
    <span class="hljs-keyword">if</span> hits.length &gt; <span class="hljs-number">0</span> <span class="hljs-comment">#and @vel.y &gt;= 0</span>
      closest = closestpoint p, hits
      <span class="hljs-property">@pos</span> = closest.vsub(<span class="hljs-property">@vel</span>.norm())
      <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span> <span class="hljs-comment">#-Math.abs(@vel.x)</span></pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>@vel.x = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> geometry.pointInsidePoly p, candidate.points
      <span class="hljs-property">@vel</span>.y--</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p> @vel.y = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      

<span class="hljs-attribute">Hero</span>::checkcontrols = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>
<span class="hljs-attribute">BugLady</span>::checkcontrols = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span> <span class="hljs-keyword">isnt</span> ladybug <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  <span class="hljs-property">@holdingboggle</span> = isholdingbound <span class="hljs-string">'boggle'</span>
  <span class="hljs-property">@holdingjump</span> = isholdingbound <span class="hljs-string">'jump'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@holdingjump</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@controls</span>.tapstatus.jump = <span class="hljs-literal">true</span>
  <span class="hljs-property">@controls</span>.crouch = isholdingbound <span class="hljs-string">'down'</span>


<span class="hljs-attribute">BugLady</span>::cancelattack = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@timers</span>.attack = <span class="hljs-number">0</span>
  <span class="hljs-property">@attacking</span>=<span class="hljs-literal">false</span>

<span class="hljs-attribute">Hero</span>::outofbounds = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@pos</span>.y &gt; <span class="hljs-number">6400</span>

<span class="hljs-attribute">BugLady</span>::kill = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@respawn</span>()


<span class="hljs-attribute">BugLady</span>::timeoutcheck = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#rename to timerhandler or something?</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> <span class="hljs-property">@timers</span>
    <span class="hljs-keyword">if</span> v&gt;<span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@timers</span>[k]--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.powerup &gt; <span class="hljs-number">0</span>
    <span class="hljs-property">@vel</span> = V2d.zero()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.stun &gt; <span class="hljs-number">0</span>
    achieve <span class="hljs-string">"fall"</span>
    <span class="hljs-property">@vel</span> = V2d.zero()

<span class="hljs-attribute">BugLady</span>::attackchecks = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@attacking</span>=<span class="hljs-property">@timers</span>.attack &gt; <span class="hljs-number">0</span>
  heading = <span class="hljs-keyword">if</span> <span class="hljs-property">@facingleft</span> <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>if @attacking then @timers.attack—</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  dashing = Math.abs(<span class="hljs-property">@vel</span>.x)&gt;<span class="hljs-number">11</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> dashing
    <span class="hljs-property">@vel</span>.x *= <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
    <span class="hljs-property">@timers</span>.uppercut = <span class="hljs-number">10</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@punching</span>
    <span class="hljs-property">@vel</span>.y *= <span class="hljs-number">0.7</span></pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>@vel.x += heading*0.3</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    WORLD.spritelayer.push <span class="hljs-keyword">new</span> PchooParticle entcenter @
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span>
    <span class="hljs-keyword">if</span> entitycount(Bullet) &lt; <span class="hljs-number">3</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@energy</span> &gt; <span class="hljs-number">0</span>
      <span class="hljs-property">@energy</span>-=<span class="hljs-number">0.1</span>
      firebullet @
<span class="hljs-function">
<span class="hljs-title">firebullet</span> = <span class="hljs-params">(ent)</span> -&gt;</span>
  heading = <span class="hljs-keyword">if</span> ent.facingleft <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  bullet = <span class="hljs-keyword">new</span> Bullet()
  bullet.owner = ent
  bullet.vel = V heading*<span class="hljs-number">32</span>, <span class="hljs-number">0</span>
  bullet.life = <span class="hljs-number">2</span>
  CENTER=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>/<span class="hljs-number">2</span>
  bullet.pos = relativetobox ent.gethitbox(), CENTER
  WORLD.spritelayer.push bullet
  <span class="hljs-keyword">return</span> bullet
<span class="hljs-function">
<span class="hljs-title">get_sprites_of_class</span> = <span class="hljs-params">(classtype)</span> -&gt;</span>
  ents = WORLD.spritelayer.filter (sprite) -&gt; sprite <span class="hljs-keyword">instanceof</span> classtype

<span class="hljs-attribute">BugLady</span>::submerged = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  waterblocks = get_sprites_of_class Water
  collidebox = <span class="hljs-property">@gethitbox</span>()
  blockcandidates=hitboxfilter collidebox, waterblocks
  <span class="hljs-keyword">if</span> blockcandidates.length &gt; <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

<span class="hljs-attribute">BugLady</span>::waterdrag = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@vel</span>.y = <span class="hljs-property">@vel</span>.y * <span class="hljs-number">0.8</span>
  <span class="hljs-property">@vel</span>.x = <span class="hljs-property">@vel</span>.x * <span class="hljs-number">0.95</span>

<span class="hljs-attribute">BugLady</span>::tick = <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>slow energy recharge</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@energy</span>+=<span class="hljs-number">0.001</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@getsprite</span>() <span class="hljs-keyword">is</span> <span class="hljs-string">"bugdash.png"</span> <span class="hljs-comment">#no, bad. fix this</span>
    WORLD.spritelayer.push <span class="hljs-keyword">new</span> PchooParticle entcenter @
  <span class="hljs-keyword">if</span> <span class="hljs-property">@submerged</span>()
    <span class="hljs-property">@waterdrag</span>()
  unpowered = settings.altcostume
  <span class="hljs-keyword">if</span> unpowered <span class="hljs-keyword">then</span> <span class="hljs-property">@cancelattack</span>()
  <span class="hljs-property">@checkcontrols</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@outofbounds</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@kill</span>()
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">0.2</span>
  boggling = <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@holdingboggle</span>
  <span class="hljs-keyword">if</span> boggling <span class="hljs-keyword">and</span> Math.random()&lt;<span class="hljs-number">0.3</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@boggle</span>()
  <span class="hljs-property">@timeoutcheck</span>()
  <span class="hljs-property">@movetick</span>()

<span class="hljs-attribute">BugLady</span>::limitvelocity = <span class="hljs-function">-&gt;</span>
  vellimit = <span class="hljs-number">800</span>
  <span class="hljs-property">@vel</span>.x = mafs.clamp <span class="hljs-property">@vel</span>.x, -vellimit, vellimit
<span class="hljs-attribute">BugLady</span>::gravitate = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingwall</span>()
    <span class="hljs-property">@vel</span>.y += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> settings.variablejump
      <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@holdingjump</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.y /= <span class="hljs-number">2</span>

<span class="hljs-attribute">BugLady</span>::canhurdle = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> isholdingbound <span class="hljs-string">'cling'</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>automagically do a hop skip and a jump over waist high obstacles</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  box=<span class="hljs-property">@fallbox</span>()
  candidates = hitboxfilter box, WORLD.bglayer
  b_hitsomething = candidates.length &gt; <span class="hljs-number">0</span>
  box.y -= <span class="hljs-number">4</span>
  candidates = hitboxfilter box, WORLD.bglayer
  b_cansqueezein = candidates.length &gt; <span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> b_hitsomething <span class="hljs-keyword">and</span> b_cansqueezein <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

<span class="hljs-attribute">BugLady</span>::hurdlecheck = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@canhurdle</span>()
    <span class="hljs-property">@vel</span>.y-=<span class="hljs-number">2</span>

<span class="hljs-attribute">GenericSprite</span>::physmove = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@blockcollisions</span>()
  <span class="hljs-property">@avoidwalls</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-property">@gravitate</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingice</span>()
    <span class="hljs-property">@friction</span>()

<span class="hljs-attribute">BugLady</span>::physmove = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@hurdlecheck</span>()
  <span class="hljs-property">@limitvelocity</span>()
  <span class="hljs-property">@blockcollisions</span>()
  <span class="hljs-property">@polygoncollisions</span>()
  <span class="hljs-property">@avoidwalls</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@vel</span>.y = <span class="hljs-number">0</span>
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  <span class="hljs-keyword">if</span> !<span class="hljs-property">@timers</span>.hover <span class="hljs-keyword">then</span> <span class="hljs-property">@gravitate</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingice</span>()
    <span class="hljs-property">@friction</span>()
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingspritename</span> <span class="hljs-string">"redtile.png"</span>
    <span class="hljs-property">@vel</span>.y -= <span class="hljs-number">8</span>
<span class="hljs-attribute">BugLady</span>::smashblock = <span class="hljs-function">-&gt;</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    <span class="hljs-keyword">if</span> block.src <span class="hljs-keyword">isnt</span> <span class="hljs-string">"genblackrocks.png"</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">continue</span>
    WORLD.bglayer = _.without WORLD.bglayer, block
    block.removesprite()

<span class="hljs-attribute">BugLady</span>::movetick = <span class="hljs-function">-&gt;</span>
  unpowered = settings.altcostume
  <span class="hljs-property">@physmove</span>()
  <span class="hljs-property">@attackchecks</span>()
  jumpvel = <span class="hljs-keyword">if</span> unpowered <span class="hljs-keyword">then</span> <span class="hljs-number">12</span> <span class="hljs-keyword">else</span> <span class="hljs-number">16</span>
  <span class="hljs-property">@jumpimpulse</span> jumpvel
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y&gt;<span class="hljs-number">1</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@controls</span>.crouch <span class="hljs-keyword">and</span> <span class="hljs-property">@shield</span>
    ladybug.shield.KILLME=<span class="hljs-literal">true</span>
    ladybug.shield=<span class="hljs-literal">null</span>
    <span class="hljs-property">@state</span> = <span class="hljs-string">'headfirst'</span>
    <span class="hljs-property">@vel</span>.y += <span class="hljs-number">0.1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'headfirst'</span>
    <span class="hljs-property">@smashblock</span>()
    <span class="hljs-property">@state</span> = <span class="hljs-string">''</span>
    <span class="hljs-property">@timers</span>.stun=<span class="hljs-number">20</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'headfirst'</span>
    <span class="hljs-property">@vel</span>.y+=<span class="hljs-number">2</span>
    <span class="hljs-property">@vel</span>.x*=<span class="hljs-number">0.9</span>
  <span class="hljs-property">@jumping</span> = <span class="hljs-literal">false</span> <span class="hljs-comment">#so we don't repeat by accident yo</span></pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>@climbing = @touchingwall()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@climbing</span> = <span class="hljs-property">@canhurdle</span>()

<span class="hljs-attribute">BugLady</span>::jumpimpulse = <span class="hljs-function"><span class="hljs-params">(jumpvel)</span> -&gt;</span>
  unpowered = settings.altcostume
  <span class="hljs-keyword">if</span> <span class="hljs-property">@touchingground</span>()
    <span class="hljs-property">@spentdoublejump</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@timers</span>.jumpgraceperiod = <span class="hljs-number">4</span>
    <span class="hljs-keyword">if</span> settings.moonjump <span class="hljs-keyword">then</span> <span class="hljs-property">@timers</span>.jumpgraceperiod = <span class="hljs-number">100</span>
  jumplegal = <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">or</span> <span class="hljs-property">@submerged</span>() <span class="hljs-keyword">or</span> <span class="hljs-property">@timers</span>.jumpgraceperiod &gt; <span class="hljs-number">0</span>
  jumplegal = jumplegal <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.controls.tapstatus.jump
  doublejumplegal = <span class="hljs-keyword">not</span> unpowered <span class="hljs-keyword">and</span> settings.airjump <span class="hljs-keyword">and</span> <span class="hljs-property">@energy</span> &gt; <span class="hljs-number">0</span>
  doublejumplegal = doublejumplegal <span class="hljs-keyword">and</span> <span class="hljs-keyword">this</span>.controls.tapstatus.jump
  <span class="hljs-keyword">if</span> <span class="hljs-property">@spentdoublejump</span> <span class="hljs-keyword">then</span> doublejumplegal = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@jumping</span> <span class="hljs-keyword">and</span> doublejumplegal <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> jumplegal
    <span class="hljs-property">@spentdoublejump</span> = <span class="hljs-literal">true</span>
    <span class="hljs-property">@energy</span>--
  <span class="hljs-keyword">if</span> <span class="hljs-property">@jumping</span> <span class="hljs-keyword">and</span> (jumplegal <span class="hljs-keyword">or</span> doublejumplegal)
    <span class="hljs-property">@controls</span>.tapstatus.jump = <span class="hljs-literal">false</span>
    <span class="hljs-property">@vel</span>.y = -jumpvel
  <span class="hljs-keyword">if</span> <span class="hljs-property">@spentdoublejump</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span>
    WORLD.spritelayer.push <span class="hljs-keyword">new</span> PchooParticle entcenter @

<span class="hljs-attribute">GenericSprite</span>::OLD_friction = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@vel</span>.x = <span class="hljs-property">@vel</span>.x*<span class="hljs-number">0.9</span>
<span class="hljs-attribute">GenericSprite</span>::friction = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  x = <span class="hljs-property">@vel</span>.x
  sign = Math.sign x
  x -= sign / <span class="hljs-number">2</span>
  <span class="hljs-keyword">if</span> Math.abs(x) &lt; <span class="hljs-number">1</span>/<span class="hljs-number">2</span> <span class="hljs-keyword">then</span> x = <span class="hljs-number">0</span>
  <span class="hljs-property">@vel</span>.x = x

<span class="hljs-attribute">BugLady</span>::boggle = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  WORLD.spritelayer.push <span class="hljs-keyword">new</span> BoggleParticle entcenter @
  hit=ladybug.gethitbox()</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>boxes = WORLD.fglayer.map (obj) -&gt; obj.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bushes = get_sprites_of_class Shrub
  boxes = bushes.map (obj) -&gt; obj.gethitbox()
  cand=hitboxfilter hit, boxes
  <span class="hljs-keyword">if</span> cand.length &gt; <span class="hljs-number">0</span>
    achieve <span class="hljs-string">"boggle"</span>
  <span class="hljs-property">@energy</span>++

<span class="hljs-attribute">BugLady</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> settings.beanmode <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"bugbean.png"</span>
  src=<span class="hljs-string">"lovelyshorter.png"</span>
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">0.2</span>
  running = vel &gt; <span class="hljs-number">3</span>
  <span class="hljs-keyword">if</span> walking
    src = selectframe [ <span class="hljs-string">'lovelyrun1.png'</span>, <span class="hljs-string">'lovelyrun2.png'</span> ], <span class="hljs-number">6</span>
  <span class="hljs-keyword">if</span> running
    src = selectframe [ <span class="hljs-string">'lovelyrun1.png'</span>, <span class="hljs-string">'lovelyrun2.png'</span> ], <span class="hljs-number">3</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>()
    src = <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'lovelyjump.png'</span> <span class="hljs-keyword">else</span> <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@controls</span>.crouch
    src = <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> isholdingbound <span class="hljs-string">'up'</span>
    src = <span class="hljs-string">'lovelyjump.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> walking <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">and</span> <span class="hljs-property">@holdingboggle</span>
    src = <span class="hljs-string">'boggle.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'viewtiful.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span>
    src = <span class="hljs-string">'bugpunch.png'</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.uppercut <span class="hljs-keyword">then</span> src = <span class="hljs-string">'buguppercut.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@timers</span>.attack &lt; <span class="hljs-number">2</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@punching</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'lovelyrun2.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@attacking</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@kicking</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugkick.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.stun &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.stun &gt; <span class="hljs-number">4</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugbonk.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.powerup &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'viewtiful.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.powerup &gt; <span class="hljs-number">16</span>
    src = <span class="hljs-string">'boggle.png'</span>
    <span class="hljs-property">@facingleft</span> = <span class="hljs-property">@timers</span>.powerup % <span class="hljs-number">10</span> &lt; <span class="hljs-number">5</span>
  <span class="hljs-keyword">if</span> vel &gt; <span class="hljs-number">11</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">"bugdash.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.powerup &gt; <span class="hljs-number">32</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'marl/boggle.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@lastfacing</span> <span class="hljs-keyword">isnt</span> <span class="hljs-property">@facingleft</span>
    <span class="hljs-property">@timers</span>.turn=<span class="hljs-number">4</span>
    <span class="hljs-property">@lastfacing</span> = <span class="hljs-property">@facingleft</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.turn&gt;<span class="hljs-number">0</span>
    src = <span class="hljs-string">'lovelycrouch.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.pone <span class="hljs-keyword">and</span> settings.altcostume <span class="hljs-keyword">then</span> src = <span class="hljs-string">"marl/"</span> + src
  <span class="hljs-keyword">if</span> <span class="hljs-property">@climbing</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugclimb1.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@climbing</span> <span class="hljs-keyword">and</span> settings.altcostume <span class="hljs-keyword">then</span> src = <span class="hljs-string">'marl/boggle.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@state</span> == <span class="hljs-string">'headfirst'</span> <span class="hljs-keyword">then</span> src = <span class="hljs-string">'bugdrop.png'</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.invincible &gt; <span class="hljs-number">10</span> <span class="hljs-keyword">and</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">then</span> src= <span class="hljs-string">"bugflinch.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.invincible &gt; <span class="hljs-number">15</span> <span class="hljs-keyword">then</span> src= <span class="hljs-string">"bugdmg.png"</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.invincible &gt; <span class="hljs-number">0</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@touchingground</span>() <span class="hljs-keyword">then</span> src= <span class="hljs-string">"bugdmg2.png"</span>
  <span class="hljs-keyword">if</span> settings.pone <span class="hljs-keyword">then</span> src = <span class="hljs-string">"pone/"</span> + src
  <span class="hljs-keyword">return</span> src

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Claire</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BugLady</span></span>
<span class="hljs-attribute">Claire</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> settings.skathi <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-string">"skathi.png"</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"orcbabb.png"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Wisp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">BugLady</span></span>
<span class="hljs-attribute">Wisp</span>::getsprite = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-string">"wisp.png"</span>
<span class="hljs-attribute">Wisp</span>::gravitate = <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>
<span class="hljs-attribute">Wisp</span>::tick = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> isholdingbound <span class="hljs-string">'up'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.y--
  <span class="hljs-keyword">if</span> isholdingbound <span class="hljs-string">'down'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.y++
  <span class="hljs-keyword">if</span> isholdingbound <span class="hljs-string">'left'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.x--
  <span class="hljs-keyword">if</span> isholdingbound <span class="hljs-string">'right'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@vel</span>.x++
  <span class="hljs-property">@pos</span> = <span class="hljs-property">@pos</span>.vadd <span class="hljs-property">@vel</span>
  damping = <span class="hljs-number">0.95</span>
  <span class="hljs-property">@vel</span> = <span class="hljs-property">@vel</span>.nmul damping

<span class="hljs-attribute">BugLady</span>::render = <span class="hljs-function">-&gt;</span>
  vel = Math.abs( <span class="hljs-property">@vel</span>.x )
  walking = vel &gt; <span class="hljs-number">1</span>
  src=<span class="hljs-property">@getsprite</span>()
  flip = <span class="hljs-property">@facingleft</span>
  <span class="hljs-keyword">if</span> settings.beanmode <span class="hljs-keyword">and</span> walking <span class="hljs-keyword">then</span> flip = tickno % <span class="hljs-number">8</span> &lt; <span class="hljs-number">4</span>
  pos = relativetobox <span class="hljs-property">@gethitbox</span>(), <span class="hljs-property">@anchor</span>
  sprit=drawsprite @, src, pos, flip, <span class="hljs-property">@anchor</span>
  <span class="hljs-keyword">if</span> src == <span class="hljs-string">'boggle.png'</span>
    sprit.rotation=mafs.degstorads mafs.randfloat()*<span class="hljs-number">4</span>
  <span class="hljs-keyword">else</span>
    sprit.rotation=<span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@timers</span>.stun <span class="hljs-comment">#blinking</span>
    sprit.alpha = tickno % <span class="hljs-number">2</span> 
  <span class="hljs-keyword">else</span>
    sprit.alpha = <span class="hljs-number">1</span>
<span class="hljs-function">

<span class="hljs-title">removesprite</span> = <span class="hljs-params">( ent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent._pixisprite? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  stage.removeChild ent._pixisprite
  ent._pixisprite=<span class="hljs-literal">undefined</span>
<span class="hljs-function">
<span class="hljs-title">stageremovesprite</span> = <span class="hljs-params">( stage, ent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent._pixisprite? <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  stage.removeChild ent._pixisprite
  ent._pixisprite=<span class="hljs-literal">undefined</span>
<span class="hljs-function">
<span class="hljs-title">initsprite</span> = <span class="hljs-params">(ent,tex)</span> -&gt;</span>
  sprit = <span class="hljs-keyword">new</span> PIXI.Sprite tex
  ent._pixisprite=sprit
  stage.addChild sprit
  <span class="hljs-keyword">return</span> sprit
<span class="hljs-function">
<span class="hljs-title">drawsprite</span> = <span class="hljs-params">(ent, src, pos, flip, anchor=V())</span> -&gt;</span>
  tex = PIXI.Texture.fromImage sourcebaseurl+src
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> ent._pixisprite
    initsprite ent,tex
  sprit = ent._pixisprite
  sprit.position = VTOPP pos
  sprit.anchor = VTOPP anchor
  sprit.texture = tex
  sprit.scale.x = <span class="hljs-keyword">if</span> flip <span class="hljs-keyword">then</span> -<span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> sprit


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Poly</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@points</span>=[])</span> -&gt;</span>
    <span class="hljs-property">@pos</span> = V()
<span class="hljs-attribute">Poly</span>::initsprite = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  sprit=<span class="hljs-keyword">new</span> PIXI.Graphics()
  sprit.beginFill <span class="hljs-number">0xcc0000</span>
  sprit.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x000000</span>
  firstpoint = <span class="hljs-property">@points</span>[<span class="hljs-number">0</span>]
  <span class="hljs-property">@points</span>.forEach (point) -&gt;
    sprit.lineTo point.x, point.y
  sprit.lineTo firstpoint.x, firstpoint.y
  sprit.endFill()
  <span class="hljs-property">@_pixisprite</span>=sprit
  stage.addChild sprit
<span class="hljs-attribute">Poly</span>::render = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@hassprite</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@initsprite</span>()

<span class="hljs-attribute">Poly</span>::boundingbox = <span class="hljs-function">-&gt;</span>
  xs=<span class="hljs-property">@points</span>.map (pt) -&gt; pt.x
  ys=<span class="hljs-property">@points</span>.map (pt) -&gt; pt.y
<span class="hljs-function">  <span class="hljs-title">min</span> = <span class="hljs-params">(a,b)</span> -&gt;</span> Math.min a,b
<span class="hljs-function">  <span class="hljs-title">max</span> = <span class="hljs-params">(a,b)</span> -&gt;</span> Math.max a,b
  l=Math.round xs.reduce min
  r=Math.round xs.reduce max
  t=Math.round ys.reduce min
  b=Math.round ys.reduce max
  <span class="hljs-keyword">return</span> makebox V(l,t), V(r-l,b-t), V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)

<span class="hljs-attribute">Poly</span>::gethitbox = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@boundingbox</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p> makebox V(0,0), V(32,32), V(0,0)</p>

            </div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>ok this hsould really be mmoved to some geometry library thing</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Block</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>,<span class="hljs-property">@w</span>,<span class="hljs-property">@h</span>)</span> -&gt;</span> <span class="hljs-property">@pos</span> = V <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>


<span class="hljs-attribute">Block</span>::intersection = <span class="hljs-function"><span class="hljs-params">(rectb)</span> -&gt;</span>
  recta=@
  l=Math.max recta.left(), rectb.left()
  t=Math.max recta.top(), rectb.top()
  r=Math.min recta.right(), rectb.right()
  b=Math.min recta.bottom(), rectb.bottom()
  w=r-l
  h=b-t
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block l,t,w,h


<span class="hljs-attribute">Block</span>::strictoverlaps = <span class="hljs-function"><span class="hljs-params">( rectb )</span> -&gt;</span>
  recta=@
  <span class="hljs-keyword">if</span> recta.left() &gt;= rectb.right() <span class="hljs-keyword">or</span>
  recta.top() &gt;= rectb.bottom() <span class="hljs-keyword">or</span>
  recta.right() &lt;= rectb.left() <span class="hljs-keyword">or</span>
  recta.bottom() &lt;= rectb.top()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>rename Block::touching ?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">Block</span>::overlaps = <span class="hljs-function"><span class="hljs-params">( rectb )</span> -&gt;</span>
  recta=@
  <span class="hljs-keyword">if</span> recta.left() &gt; rectb.right() <span class="hljs-keyword">or</span>
  recta.top() &gt; rectb.bottom() <span class="hljs-keyword">or</span>
  recta.right() &lt; rectb.left() <span class="hljs-keyword">or</span>
  recta.bottom() &lt; rectb.top()
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>

<span class="hljs-attribute">Block</span>::tostone = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@src</span>=<span class="hljs-string">"groundstone.png"</span>
  <span class="hljs-property">@removesprite</span>()

<span class="hljs-attribute">Block</span>::fixnegative = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@w</span>&lt;<span class="hljs-number">0</span>
    <span class="hljs-property">@x</span>+=<span class="hljs-property">@w</span>
    <span class="hljs-property">@w</span>*=-<span class="hljs-number">1</span>
  <span class="hljs-keyword">if</span> <span class="hljs-property">@h</span>&lt;<span class="hljs-number">0</span>
    <span class="hljs-property">@y</span>+=<span class="hljs-property">@h</span>
    <span class="hljs-property">@h</span>*=-<span class="hljs-number">1</span>
  <span class="hljs-property">@pos</span> = V <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>
  <span class="hljs-property">@removesprite</span>()
<span class="hljs-function">
<span class="hljs-title">hitboxfilter_OLD</span> = <span class="hljs-params">( hitbox, rectarray )</span> -&gt;</span>
  rectarray.filter (box) -&gt;
    hitbox.overlaps box
<span class="hljs-function">
<span class="hljs-title">hitboxfilter</span> = <span class="hljs-params">( hitbox, rectarray )</span> -&gt;</span>
  res = hitboxfilter_OLD hitbox, rectarray
  stats.collisionchecks+= res.length
  <span class="hljs-keyword">return</span> res
<span class="hljs-function">
<span class="hljs-title">makebox</span> = <span class="hljs-params">(position, dimensions, anchor)</span> -&gt;</span>
  truepos = position.vsub dimensions.vmul anchor
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block truepos.x, truepos.y, dimensions.x, dimensions.y

bottomcenter = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">BugLady</span>::anchor = bottomcenter
<span class="hljs-attribute">BugLady</span>::size = V <span class="hljs-number">16</span>, <span class="hljs-number">32</span>+<span class="hljs-number">16</span>

<span class="hljs-attribute">GenericSprite</span>::fallbox = <span class="hljs-function">-&gt;</span>
  box=<span class="hljs-property">@gethitbox</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>box.y+=@vel.y
box.x+=@vel.x</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  box.w+=Math.abs <span class="hljs-property">@vel</span>.x
  box.h+=Math.abs <span class="hljs-property">@vel</span>.y
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.x &lt; <span class="hljs-number">0</span>
    box.x += <span class="hljs-property">@vel</span>.x
  <span class="hljs-keyword">if</span> <span class="hljs-property">@vel</span>.y &lt; <span class="hljs-number">0</span>
    box.y += <span class="hljs-property">@vel</span>.y</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>shrink it a bit so jumping works again, this is not ideal</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  box.h-=<span class="hljs-number">2</span>
  <span class="hljs-keyword">return</span> box
<span class="hljs-function">
<span class="hljs-title">leftof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.x
<span class="hljs-function"><span class="hljs-title">rightof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.x+box.w
<span class="hljs-function"><span class="hljs-title">bottomof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.y+box.h
<span class="hljs-function"><span class="hljs-title">topof</span> = <span class="hljs-params">(box)</span> -&gt;</span> box.y

<span class="hljs-attribute">Block</span>::left = <span class="hljs-function">-&gt;</span> leftof @
<span class="hljs-attribute">Block</span>::right = <span class="hljs-function">-&gt;</span> rightof @
<span class="hljs-attribute">Block</span>::bottom = <span class="hljs-function">-&gt;</span> bottomof @
<span class="hljs-attribute">Block</span>::top = <span class="hljs-function">-&gt;</span> topof @

<span class="hljs-attribute">Block</span>::containspoint = <span class="hljs-function"><span class="hljs-params">(p)</span> -&gt;</span>
  <span class="hljs-property">@x</span> &lt;= p.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span> &lt;= p.y <span class="hljs-keyword">and</span> <span class="hljs-property">@x</span>+<span class="hljs-property">@w</span> &gt;= p.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span>+<span class="hljs-property">@h</span> &gt;= p.y

<span class="hljs-attribute">Block</span>::issamebox = <span class="hljs-function"><span class="hljs-params">(b)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-property">@x</span> <span class="hljs-keyword">is</span> b.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span> <span class="hljs-keyword">is</span> b.y <span class="hljs-keyword">and</span> <span class="hljs-property">@w</span> <span class="hljs-keyword">is</span> b.w <span class="hljs-keyword">and</span> <span class="hljs-property">@h</span> <span class="hljs-keyword">is</span> b.h
<span class="hljs-function">
<span class="hljs-title">blocksatpoint</span> = <span class="hljs-params">(blocks, p)</span> -&gt;</span>
  blocks.filter (box) -&gt; box.containspoint p
<span class="hljs-function">


<span class="hljs-title">boxtouchingwall</span> = <span class="hljs-params">(collidebox)</span> -&gt;</span>
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    notontop = collidebox.bottom()&gt;block.top()
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.left() &lt; block.left()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.right() &gt; block.right()
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

<span class="hljs-attribute">GenericSprite</span>::touchingwall = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()
  <span class="hljs-keyword">return</span> boxtouchingwall collidebox

<span class="hljs-attribute">GenericSprite</span>::avoidwalls = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  actualbox = <span class="hljs-property">@gethitbox</span>()
  collidebox = <span class="hljs-property">@fallbox</span>()
  blockcandidates=hitboxfilter collidebox, WORLD.bglayer
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    jumpthroughable = block <span class="hljs-keyword">instanceof</span> OnewayBlock
    <span class="hljs-keyword">if</span> jumpthroughable <span class="hljs-keyword">then</span> <span class="hljs-keyword">continue</span>
    notontop = actualbox.bottom() &gt;block.top()
    <span class="hljs-keyword">if</span> boxtouchingwall collidebox
      <span class="hljs-property">@hitwall</span>?()
      <span class="hljs-property">@vel</span>.x = <span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>    ofs=<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> collidebox.left() &lt;= block.left()
      <span class="hljs-property">@pos</span>.x-=ofs
    <span class="hljs-keyword">if</span> notontop <span class="hljs-keyword">and</span> rightof(collidebox) &gt;= rightof(block)
      <span class="hljs-property">@pos</span>.x+=ofs</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-attribute">BugLady</span>::hitwall = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-keyword">if</span> Math.abs(<span class="hljs-property">@vel</span>.x) &gt; <span class="hljs-number">11</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@timers</span>.invincible = <span class="hljs-number">10</span>

<span class="hljs-attribute">GenericSprite</span>::touchingground = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  touch=<span class="hljs-literal">false</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()
  WORLD.updateboxes()
  otherboxes = _.union WORLD.BOXCACHE, WORLD.bglayer
  otherboxes = otherboxes.filter (b) -&gt; <span class="hljs-keyword">not</span> b.issamebox collidebox

  blockcandidates=hitboxfilter collidebox, otherboxes
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    <span class="hljs-keyword">if</span> collidebox.bottom() &lt;= block.bottom()
      touch=<span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>generic poly handling woo wee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  allpolygons = WORLD.spritelayer.filter (sprit) -&gt; sprit <span class="hljs-keyword">instanceof</span> Poly
  box=<span class="hljs-property">@gethitbox</span>()
  box.y+=<span class="hljs-number">1</span>
  allpolygons.forEach (candidate) =&gt;
    p = <span class="hljs-keyword">new</span> V2d <span class="hljs-property">@pos</span>.x, <span class="hljs-property">@pos</span>.y+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> geometry.pointInsidePoly p, candidate.points
      touch = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> touch

<span class="hljs-attribute">GenericSprite</span>::touchingspritename = <span class="hljs-function"><span class="hljs-params">(spritename)</span> -&gt;</span>
  touch=<span class="hljs-literal">false</span>
  collidebox = <span class="hljs-property">@gethitbox</span>()</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>wee woo TODO fix horrible code</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  cands = WORLD.bglayer.filter (cand) -&gt; cand.src <span class="hljs-keyword">is</span> spritename
  blockcandidates=hitboxfilter collidebox, cands
  <span class="hljs-keyword">for</span> block <span class="hljs-keyword">in</span> blockcandidates
    <span class="hljs-keyword">if</span> collidebox.bottom() &lt;= block.bottom()
      touch=<span class="hljs-literal">true</span></pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>generic poly handling woo wee</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  allpolygons = WORLD.spritelayer.filter (sprit) -&gt; sprit <span class="hljs-keyword">instanceof</span> Poly
  box=<span class="hljs-property">@gethitbox</span>()
  box.y+=<span class="hljs-number">1</span>
  allpolygons.forEach (candidate) =&gt;
    p = <span class="hljs-keyword">new</span> V2d <span class="hljs-property">@pos</span>.x, <span class="hljs-property">@pos</span>.y+<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> geometry.pointInsidePoly p, candidate.points
      touch = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">return</span> touch
<span class="hljs-attribute">GenericSprite</span>::touchingice = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  <span class="hljs-property">@touchingspritename</span> <span class="hljs-string">"genice.png"</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PowerSuit</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@pos</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'suit.png'</span>
<span class="hljs-attribute">PowerSuit</span>::anchor = V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
<span class="hljs-attribute">PowerSuit</span>::collide = <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
    <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
    otherent.timers.powerup = <span class="hljs-number">45</span>
    settings.altcostume=<span class="hljs-literal">false</span>


<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ControlObj</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@bindings</span>={}
    <span class="hljs-property">@holdbindings</span>={}
    <span class="hljs-property">@heldkeys</span>=[]
    <span class="hljs-property">@bindingnames</span>={}

control = <span class="hljs-keyword">new</span> ControlObj
<span class="hljs-property">@control</span> = control
<span class="hljs-function">
<span class="hljs-title">normalizekey</span> = <span class="hljs-params">(key)</span> -&gt;</span> key.toUpperCase().charCodeAt <span class="hljs-number">0</span>

<span class="hljs-attribute">ControlObj</span>::keytapbindraw = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[key]=func
<span class="hljs-attribute">ControlObj</span>::keytapbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[normalizekey(key)]=func
<span class="hljs-attribute">ControlObj</span>::keytapbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@bindings</span>[normalizekey(key)]=func

<span class="hljs-attribute">ControlObj</span>::keytapbindname = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[normalizekey(key)]=name
  <span class="hljs-property">@keytapbind</span> key, func

<span class="hljs-attribute">ControlObj</span>::keyBindRawNamed = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[key]=name
  <span class="hljs-property">@keytapbindraw</span> key, func

<span class="hljs-attribute">ControlObj</span>::keyholdbind = <span class="hljs-function"><span class="hljs-params">( key, func )</span> -&gt;</span>
  <span class="hljs-property">@holdbindings</span>[normalizekey(key)]=func
<span class="hljs-attribute">ControlObj</span>::keyholdbindname = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[normalizekey(key)]=name
  <span class="hljs-property">@holdbindings</span>[normalizekey(key)]=func

<span class="hljs-attribute">ControlObj</span>::keyHoldBindRawNamed = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@bindingnames</span>[key]=name
  <span class="hljs-property">@holdbindings</span>[key]=func

control.keytapbindname <span class="hljs-string">'9'</span>, <span class="hljs-string">'zoom out'</span>, <span class="hljs-function">-&gt;</span> camera.zoomout()
control.keytapbindname <span class="hljs-string">'0'</span>, <span class="hljs-string">'zoom in'</span>, <span class="hljs-function">-&gt;</span> camera.zoomin()
<span class="hljs-function">


<span class="hljs-title">launchFullScreen</span> = <span class="hljs-params">(elm)</span> -&gt;</span>
  elm.requestFullScreen?()
  elm.mozRequestFullScreen?()
  elm.webkitRequestFullScreen?()
<span class="hljs-function"><span class="hljs-title">cancelFullScreen</span> = -&gt;</span>
  <span class="hljs-built_in">document</span>.cancelFullScreen?()
  <span class="hljs-built_in">document</span>.mozCancelFullScreen?()
  <span class="hljs-built_in">document</span>.webkitCancelFullScreen?()
<span class="hljs-function"><span class="hljs-title">toggleFullScreen</span> = <span class="hljs-params">(elm)</span> -&gt;</span>
  isfullscreen = <span class="hljs-built_in">document</span>.fullScreen || <span class="hljs-built_in">document</span>.mozFullScreen || <span class="hljs-built_in">document</span>.webkitFullScreen
  <span class="hljs-keyword">if</span> isfullscreen
    cancelFullScreen()
  <span class="hljs-keyword">else</span>
    launchFullScreen elm

control.keytapbindname <span class="hljs-string">'y'</span>, <span class="hljs-string">'toggle fullscreen'</span>, <span class="hljs-function">-&gt;</span>
  toggleFullScreen renderer.view
<span class="hljs-function"><span class="hljs-title">pausefunc</span> = -&gt;</span>
  playsound <span class="hljs-string">"pause.wav"</span>
  settings.paused = <span class="hljs-keyword">not</span> settings.paused
  <span class="hljs-keyword">if</span> settings.paused <span class="hljs-keyword">then</span> parentstage.addChild pausescreen
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.paused <span class="hljs-keyword">then</span> parentstage.removeChild pausescreen
control.keytapbindname <span class="hljs-string">'p'</span>, <span class="hljs-string">'pause'</span>, pausefunc
control.keyBindRawNamed keyCharToCode[<span class="hljs-string">'Pause/Break'</span>], <span class="hljs-string">'pause'</span>, pausefunc


control.keytapbindname <span class="hljs-string">'t'</span>, <span class="hljs-string">'underclock/slowmo'</span>, <span class="hljs-function">-&gt;</span>
  settings.slowmo = <span class="hljs-keyword">not</span> settings.slowmo

control.keytapbindname <span class="hljs-string">'g'</span>, <span class="hljs-string">'toggle grid'</span>, <span class="hljs-function">-&gt;</span>
  settings.grid = <span class="hljs-keyword">not</span> settings.grid
<span class="hljs-function">
<span class="hljs-title">exorcism</span> = <span class="hljs-params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>fix this oh god</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  spooky_ghosts = get_sprites_of_class Wisp
  spooky_ghosts.forEach (spoop) -&gt; spoop.KILLME = <span class="hljs-literal">true</span>

control.keytapbindname <span class="hljs-string">'h'</span>, <span class="hljs-string">'ghost mode'</span>, <span class="hljs-function">-&gt;</span>
  ghosts_are_real = entitycount(Wisp)&gt;<span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> ghosts_are_real
    exorcism()
  <span class="hljs-keyword">else</span>
    ghost = <span class="hljs-keyword">new</span> Wisp()
    WORLD.spritelayer.push ghost
    ghost.pos = ladybug.pos

control.keytapbindname <span class="hljs-string">'l'</span>, <span class="hljs-string">'WHAM!'</span>, <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>ladybug.jumping=true</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  ladybug.kicking=<span class="hljs-literal">false</span>
  ladybug.punching=<span class="hljs-literal">false</span>
control.keyholdbind <span class="hljs-string">'l'</span>, <span class="hljs-function">-&gt;</span> ladybug.timers.attack=<span class="hljs-number">10</span>
<span class="hljs-function">
<span class="hljs-title">punch</span> = -&gt;</span>
  ladybug.punching=<span class="hljs-literal">true</span>
  ladybug.kicking=<span class="hljs-literal">false</span>
  ladybug.timers.attack=<span class="hljs-number">10</span>
  playsound <span class="hljs-string">"hit.wav"</span>
<span class="hljs-function"><span class="hljs-title">kick</span> = -&gt;</span>
  ladybug.kicking=<span class="hljs-literal">true</span>
  ladybug.jumping=<span class="hljs-literal">true</span>
  ladybug.punching=<span class="hljs-literal">false</span>
  ladybug.timers.attack=<span class="hljs-number">10</span>
  playsound <span class="hljs-string">"hit.wav"</span>

control.keytapbindname <span class="hljs-string">'e'</span>, <span class="hljs-string">'shield'</span>, <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> settings.altcostume <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> ladybug.shield <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> ladybug.energy &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  ladybug.energy--</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>ladybug.timers.powerup = 2</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sb = <span class="hljs-keyword">new</span> Shieldbubble()
  sb.pos = ladybug.pos
  WORLD.spritelayer.push sb
  ladybug.shield = sb

control.keytapbindname <span class="hljs-string">'j'</span>, <span class="hljs-string">'POW!'</span>, punch
control.keytapbindname <span class="hljs-string">'k'</span>, <span class="hljs-string">'BAM!'</span>, kick
control.keytapbindname <span class="hljs-string">'m'</span>, <span class="hljs-string">'mute'</span>, <span class="hljs-function">-&gt;</span>
  settings.muted = <span class="hljs-keyword">not</span> settings.muted
<span class="hljs-function">
<span class="hljs-title">up</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> ladybug.shield
    ladybug.shield.KILLME=<span class="hljs-literal">true</span>
    ladybug.shield=<span class="hljs-literal">null</span>
    ladybug.jumping = <span class="hljs-literal">true</span>
    ladybug.vel.y -= <span class="hljs-number">20</span>
<span class="hljs-function"><span class="hljs-title">jump</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> ladybug.touchingground()
    playsound <span class="hljs-string">"jump.wav"</span>
  ladybug.jumping=<span class="hljs-literal">true</span>
<span class="hljs-function"><span class="hljs-title">down</span> = -&gt;</span>
<span class="hljs-function">
<span class="hljs-title">bugspeed</span> = -&gt;</span>
  <span class="hljs-number">1</span></pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>dont allow “regular” acceleration beyond this value</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>MAXBUGSPEED = <span class="hljs-number">10</span>
<span class="hljs-function">
<span class="hljs-title">bugthrust</span> = <span class="hljs-params">(vel)</span> -&gt;</span>
  ladybug.vel.x=vel
  ladybug.vel.y=<span class="hljs-number">0</span>
  ladybug.timers.hover=<span class="hljs-number">20</span>
<span class="hljs-function">
<span class="hljs-title">left</span> = -&gt;</span>
  ladybug.facingleft = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> ladybug.shield
    ladybug.shield.KILLME=<span class="hljs-literal">true</span>
    ladybug.shield=<span class="hljs-literal">null</span>
    bugthrust -<span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">if</span> ladybug.vel.x &lt; -MAXBUGSPEED <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  ladybug.vel.x-=bugspeed()
<span class="hljs-function"><span class="hljs-title">right</span> = -&gt;</span>
  ladybug.facingleft = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">if</span> ladybug.shield
    ladybug.shield.KILLME=<span class="hljs-literal">true</span>
    ladybug.shield=<span class="hljs-literal">null</span>
    bugthrust <span class="hljs-number">20</span>
    <span class="hljs-keyword">return</span>
  achieve <span class="hljs-string">"start"</span>
  <span class="hljs-keyword">if</span> ladybug.vel.x &gt; MAXBUGSPEED <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  ladybug.vel.x+=bugspeed()

availableactions = [ up, down, left, right ]

control.keyholdbindname <span class="hljs-string">'w'</span>, <span class="hljs-string">'up'</span>, up
control.keyholdbindname <span class="hljs-string">'s'</span>, <span class="hljs-string">'down'</span>, down
control.keyholdbindname <span class="hljs-string">'a'</span>, <span class="hljs-string">'left'</span>, left
control.keyholdbindname <span class="hljs-string">'d'</span>, <span class="hljs-string">'right'</span>, right
control.keyholdbindname <span class="hljs-string">'x'</span>, <span class="hljs-string">'boggle'</span>, <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>
control.keyholdbindname <span class="hljs-string">'q'</span>, <span class="hljs-string">'cling'</span>, <span class="hljs-function">-&gt;</span> <span class="hljs-comment">#noop</span>

<span class="hljs-attribute">ControlObj</span>::keyHoldBindCharNamed = <span class="hljs-function"><span class="hljs-params">( key, name, func )</span> -&gt;</span>
  <span class="hljs-property">@keyHoldBindRawNamed</span> keyCharToCode[key], name, func

control.keyHoldBindCharNamed <span class="hljs-string">'Up'</span>, <span class="hljs-string">'up'</span>, up
control.keyHoldBindCharNamed <span class="hljs-string">'Down'</span>, <span class="hljs-string">'down'</span>, down
control.keyHoldBindCharNamed <span class="hljs-string">'Left'</span>, <span class="hljs-string">'left'</span>, left
control.keyHoldBindCharNamed <span class="hljs-string">'Right'</span>, <span class="hljs-string">'right'</span>, right

control.keyHoldBindCharNamed <span class="hljs-string">'Space'</span>, <span class="hljs-string">'jump'</span>, jump
<span class="hljs-function">
<span class="hljs-title">save</span> = -&gt;</span>
  <span class="hljs-built_in">console</span>.log ladybug
  tmpladybug = $.extend {}, ladybug
  tmpladybug._pixisprite = <span class="hljs-literal">undefined</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"saving"</span>
  localStorage[<span class="hljs-string">"bug"</span>] = JSON.stringify tmpladybug
  <span class="hljs-built_in">console</span>.log localStorage[<span class="hljs-string">"bug"</span>]
  localStorage[<span class="hljs-string">"settings"</span>] = JSON.stringify settings
<span class="hljs-function">
<span class="hljs-title">load</span> = -&gt;</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"loading"</span>
  $.extend ladybug, JSON.parse localStorage[<span class="hljs-string">"bug"</span>]
  ladybug.pos = $.extend V(), ladybug.pos
  ladybug.vel = V ladybug.vel.x, ladybug.vel.y
  $.extend settings, JSON.parse localStorage[<span class="hljs-string">"settings"</span>]

control.keytapbindname <span class="hljs-string">'6'</span>, <span class="hljs-string">'save'</span>, save
control.keytapbindname <span class="hljs-string">'7'</span>, <span class="hljs-string">'load'</span>, load</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>wee woo here is where we store level list</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>level_files = [<span class="hljs-string">"1.json"</span>, <span class="hljs-string">"2.json"</span>]
CURRENT_LEVEL = <span class="hljs-number">0</span>
<span class="hljs-function">
<span class="hljs-title">nextlevel</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> settings.grid <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  WORLD.clear()
  WORLDINIT()</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>ROBOWORLD_INIT()
COLLTEST_INIT()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  CURRENT_LEVEL++
  <span class="hljs-keyword">if</span> CURRENT_LEVEL &gt;= level_files.length
    alert <span class="hljs-string">'u win'</span>
    achieve <span class="hljs-string">"win"</span>
    CURRENT_LEVEL = <span class="hljs-number">0</span>
  loadlevelfile <span class="hljs-string">"levels/"</span>+level_files[CURRENT_LEVEL]
  ladybug.respawn()
<span class="hljs-function">
<span class="hljs-title">restartlevel</span> = -&gt;</span>
  WORLD.clear()
  CURRENT_LEVEL=<span class="hljs-number">0</span>
  loadlevelfile <span class="hljs-string">"levels/"</span>+level_files[CURRENT_LEVEL]
  WORLDINIT()
  ladybug.respawn()

control.keytapbindname <span class="hljs-string">'r'</span>, <span class="hljs-string">'restart level'</span>, restartlevel
control.keytapbindname <span class="hljs-string">'n'</span>, <span class="hljs-string">'change level'</span>, nextlevel

<span class="hljs-property">@CONTROL</span> = control

eventelement = $ <span class="hljs-built_in">document</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>renderer.view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
keypushcache = []
<span class="hljs-function"><span class="hljs-title">cheatcodecheck</span> = -&gt;</span>
  code=[<span class="hljs-string">"Up"</span>,<span class="hljs-string">"Up"</span>,<span class="hljs-string">"Down"</span>,<span class="hljs-string">"Down"</span>,<span class="hljs-string">"Left"</span>,<span class="hljs-string">"Right"</span>,<span class="hljs-string">"Left"</span>,<span class="hljs-string">"Right"</span>,<span class="hljs-string">"B"</span>,<span class="hljs-string">"A"</span>,<span class="hljs-string">"Enter"</span>]
  input=_.last keypushcache, code.length
  <span class="hljs-keyword">if</span> _.isEqual input, code
    alert <span class="hljs-string">"conglaturation"</span>
    keypushcache=[]
  code=[<span class="hljs-string">"Right"</span>,<span class="hljs-string">"Up"</span>,<span class="hljs-string">"Right"</span>,<span class="hljs-string">"A"</span>,<span class="hljs-string">"Down"</span>,<span class="hljs-string">"Down"</span>,<span class="hljs-string">"Enter"</span>]
  input=_.last keypushcache, code.length
  <span class="hljs-keyword">if</span> _.isEqual input, code
    alert <span class="hljs-string">"you'r a radical kid!! you have prooved the justice of our culture. god bless a merica. bean mode unlock!"</span>
    settings.beanmode = <span class="hljs-keyword">not</span> settings.beanmode
    keypushcache=[]

reservedkeys = [] <span class="hljs-comment">#blank</span>
<span class="hljs-function"><span class="hljs-title">reserveKeyNamed</span> = <span class="hljs-params">(key)</span> -&gt;</span> reservedkeys.push keyCharToCode[key]

reserveKeyNamed(key) <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> [ <span class="hljs-string">"Space"</span>, <span class="hljs-string">"Up"</span>, <span class="hljs-string">"Down"</span>, <span class="hljs-string">"Backspace"</span> ]

eventelement.bind <span class="hljs-string">'keydown'</span>, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  key = e.which
  control.bindings[key]?()
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> (key <span class="hljs-keyword">in</span> control.heldkeys)
    control.heldkeys.push key
    keypushcache.push keyCodeToChar[key]
    cheatcodecheck()
  <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> reservedkeys <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
eventelement.bind <span class="hljs-string">'keyup'</span>, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  key = e.which
  control.heldkeys = _.without control.heldkeys, key
  <span class="hljs-keyword">if</span> key <span class="hljs-keyword">in</span> reservedkeys <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>

tmpcanvasjq = $ <span class="hljs-string">"&lt;canvas&gt;"</span>
tmpcanvas = tmpcanvasjq[<span class="hljs-number">0</span>]

tickno = <span class="hljs-number">0</span>

<span class="hljs-attribute">Block</span>::gethitbox = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span> @

<span class="hljs-attribute">Block</span>::initsprite = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  src = <span class="hljs-property">@src</span> <span class="hljs-keyword">or</span> <span class="hljs-string">"genbrick.png"</span>
  tex = PIXI.Texture.fromImage sourcebaseurl+src
  sprit = <span class="hljs-keyword">new</span> PIXI.extras.TilingSprite tex, <span class="hljs-property">@w</span>, <span class="hljs-property">@h</span>
  <span class="hljs-property">@_pixisprite</span>=sprit
  stage.addChild sprit

<span class="hljs-attribute">Block</span>::render = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@hassprite</span>() <span class="hljs-keyword">then</span> <span class="hljs-property">@initsprite</span>()
  sprit = <span class="hljs-property">@_pixisprite</span>
  sprit.tilePosition.x = -<span class="hljs-property">@x</span>
  sprit.tilePosition.y = -<span class="hljs-property">@y</span>
  sprit.position.x = <span class="hljs-property">@x</span>
  sprit.position.y = <span class="hljs-property">@y</span>
  <span class="hljs-keyword">if</span> settings.whoaoa
    sprit.tilePosition.y = -<span class="hljs-property">@y</span> + tickno
    sprit.height = <span class="hljs-keyword">this</span>.h * Math.cos tickno/<span class="hljs-number">100</span>
  <span class="hljs-keyword">if</span> settings.threedee
    threshold = <span class="hljs-number">64</span>*<span class="hljs-number">16</span>
    refpoint = ladybug.pos
    difx = <span class="hljs-property">@x</span>-refpoint.x
    leftwise = difx&lt;<span class="hljs-number">0</span>
    sprit.position.x = refpoint.x+difx*Math.cos difx/threshold
    <span class="hljs-keyword">if</span> Math.abs(difx) &gt; threshold <span class="hljs-keyword">then</span> sprit.position.x = -<span class="hljs-number">9000</span> <span class="hljs-comment">#"hide" it</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Water</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>,<span class="hljs-property">@w</span>,<span class="hljs-property">@h</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, <span class="hljs-property">@w</span>, <span class="hljs-property">@h</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">"snow.png"</span>
<span class="hljs-attribute">Water</span>::render = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">super</span>()
  <span class="hljs-property">@_pixisprite</span>.tilePosition.y = -tickno/<span class="hljs-number">2</span>
  <span class="hljs-property">@_pixisprite</span>.tilePosition.x = <span class="hljs-number">16</span> * Math.cos tickno/<span class="hljs-number">100</span>
  <span class="hljs-property">@_pixisprite</span>.alpha=<span class="hljs-number">0.5</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OnewayBlock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Block</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@x</span>,<span class="hljs-property">@y</span>,<span class="hljs-property">@w</span>,<span class="hljs-property">@h</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@x</span>, <span class="hljs-property">@y</span>, <span class="hljs-property">@w</span>, <span class="hljs-property">@h</span>
    <span class="hljs-property">@src</span> = <span class="hljs-string">"groundstone.png"</span>

ladybug = <span class="hljs-keyword">new</span> BugLady

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Cloud</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'cloud.png'</span>
    <span class="hljs-keyword">if</span> settings.decemberween <span class="hljs-keyword">then</span> <span class="hljs-property">@src</span>=<span class="hljs-string">'snow.png'</span>

<span class="hljs-attribute">Cloud</span>::spriteinit = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-property">@src</span>
  sprit = <span class="hljs-keyword">new</span> PIXI.extras.TilingSprite tex, screensize.x, screensize.y
  <span class="hljs-property">@_pixisprite</span>=sprit
  parentstage.addChildAt sprit, <span class="hljs-number">0</span>
  <span class="hljs-keyword">return</span> sprit

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Grid</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Renderable</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'square.png'</span>
<span class="hljs-function">
<span class="hljs-title">adjustedscreensize</span> = -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-attribute">x</span>: screensize.x*<span class="hljs-number">10</span>, <span class="hljs-attribute">y</span>: screensize.y*<span class="hljs-number">10</span>

<span class="hljs-attribute">Grid</span>::PIXINIT = <span class="hljs-attribute">Cloud</span>::PIXINIT = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-property">@_pixisprite</span>
    tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-property">@src</span>
    {x,y}=adjustedscreensize()
    sprit = <span class="hljs-keyword">new</span> PIXI.extras.TilingSprite tex, x,y
    <span class="hljs-property">@_pixisprite</span>=sprit
    parentstage.addChildAt sprit, <span class="hljs-number">0</span>

<span class="hljs-attribute">Grid</span>::PIXREMOVE = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.grid <span class="hljs-keyword">and</span> <span class="hljs-property">@_pixisprite</span>
    parentstage.removeChild <span class="hljs-property">@_pixisprite</span>
    <span class="hljs-property">@_pixisprite</span>=<span class="hljs-literal">undefined</span>

<span class="hljs-attribute">Cloud</span>::render = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  pos = cameraoffset()
  flip = <span class="hljs-literal">false</span>
  <span class="hljs-property">@PIXINIT</span>()
  sprit = <span class="hljs-property">@_pixisprite</span>
  offset=V tickno*-<span class="hljs-number">0.2</span>, Math.sin(tickno/<span class="hljs-number">200</span>)*<span class="hljs-number">64</span></pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>sprit.position = VTOPP pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sprit.tilePosition = VTOPP offset
  <span class="hljs-keyword">if</span> settings.grid <span class="hljs-keyword">and</span> <span class="hljs-property">@_pixisprite</span>
    parentstage.removeChild <span class="hljs-property">@_pixisprite</span>
    <span class="hljs-property">@_pixisprite</span>=<span class="hljs-literal">undefined</span>

<span class="hljs-attribute">Grid</span>::render = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  pos = cameraoffset()
  flip = <span class="hljs-literal">false</span>
  <span class="hljs-property">@PIXINIT</span>()
  sprit = <span class="hljs-property">@_pixisprite</span></pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>sprit.position = VTOPP pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  offset = pos.nmul -<span class="hljs-number">1</span>
  sprit.tilePosition = <span class="hljs-keyword">new</span> PIXI.Point offset.x, offset.y
  <span class="hljs-property">@PIXREMOVE</span>()




<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">World</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-property">@entities</span>=[]
    <span class="hljs-property">@bglayer</span>=[]
    <span class="hljs-property">@fglayer</span>=[]
    <span class="hljs-property">@spritelayer</span>=[]

WORLD=<span class="hljs-keyword">new</span> World
<span class="hljs-function">
<span class="hljs-title">randpos</span> = -&gt;</span> V(<span class="hljs-number">640</span>*<span class="hljs-number">1.5</span>,<span class="hljs-number">64</span>*<span class="hljs-number">2</span>).vadd mafs.randvec().vmul V <span class="hljs-number">640</span>, <span class="hljs-number">480</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Shrub</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@pos</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>, <span class="hljs-string">'shrub.png'</span>
    <span class="hljs-property">@anchor</span>=V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>,<span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">placeshrub</span> = <span class="hljs-params">(pos)</span> -&gt;</span>
  WORLD.fglayer.push <span class="hljs-keyword">new</span> Shrub pos

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DoubleJumper</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PlaceholderSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@pos</span>)</span> -&gt;</span>
    <span class="hljs-keyword">super</span> <span class="hljs-property">@pos</span>
    <span class="hljs-property">@label</span> = <span class="hljs-string">"airjump"</span>
  <span class="hljs-attribute">anchor</span>: V <span class="hljs-number">1</span>/<span class="hljs-number">2</span>, <span class="hljs-number">1</span>
  <span class="hljs-attribute">collide</span>: <span class="hljs-function"><span class="hljs-params">( otherent )</span> -&gt;</span>
    <span class="hljs-keyword">if</span> otherent <span class="hljs-keyword">instanceof</span> BugLady
      <span class="hljs-property">@KILLME</span>=<span class="hljs-literal">true</span>
      otherent.timers.powerup = <span class="hljs-number">45</span>
      settings.airjump=<span class="hljs-literal">true</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BugMeter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericSprite</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
    <span class="hljs-keyword">super</span>()
    <span class="hljs-property">@src</span>=<span class="hljs-string">'bughealth.png'</span>
    <span class="hljs-property">@value</span>=<span class="hljs-number">3</span>
    <span class="hljs-property">@abspos</span> = V <span class="hljs-number">0</span>, <span class="hljs-number">0</span>
    <span class="hljs-property">@spritesize</span> = V <span class="hljs-number">32</span>, <span class="hljs-number">32</span>

<span class="hljs-attribute">BugMeter</span>::spriteinit = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  tex = PIXI.Texture.fromImage sourcebaseurl+<span class="hljs-property">@src</span>
  sprit = <span class="hljs-keyword">new</span> PIXI.extras.TilingSprite tex, <span class="hljs-property">@spritesize</span>.x*<span class="hljs-property">@value</span>, <span class="hljs-property">@spritesize</span>.y
  <span class="hljs-property">@_pixisprite</span>=sprit
  HUDLAYER.addChild sprit</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>stage.addChild sprit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> sprit

<span class="hljs-attribute">BugMeter</span>::render = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>pos = cameraoffset()
pos = pos.vadd @abspos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pos = @abspos
  flip = false
  if not @_pixisprite then @spriteinit()
  sprit = @_pixisprite
  sprit.zIndex = 100
  sprit.width = @spritesize.x*@value
  sprit.position = VTOPP pos
BugMeter::tick = () -&gt;
  @update ladybug.health
BugMeter::update = (value) -&gt;
  stageremovesprite HUDLAYER, @
  @value = value

class EnergyMeter extends BugMeter
  constructor: () -&gt;
    super()
    @src='energy1.png'
    @abspos = V 0, 16
EnergyMeter::tick = () -&gt; @update ladybug.energy
class MoneyMeter extends BugMeter
  constructor: () -&gt;
    super()
    @src='crown.png'
    @spritesize = V 16,16
    @abspos = V 8, 64-16
  tick: () -&gt; @update ladybug.score

Block::toJSON = -&gt;
  [ @x, @y, @w, @h, @src ]

loadblocks = (blockdata) -&gt;
  blockdata.forEach (blockdatum) -&gt;
    [x,y,w,h,src]=blockdatum
    WORLD.bglayer.push bl= new Block x, y, w, h
    bl.src = src

loadspawners = (entdata) -&gt;
  entdata.forEach (entdatum) -&gt;
    WORLD.spritelayer.push spawner=new Spawner entdatum.pos
    spawner.entdata = entdatum

scatterents_old = ( classproto, num ) -&gt;
  WORLD.spritelayer=WORLD.spritelayer.concat [0...num].map -&gt;
    new classproto randpos()

scatterents = ( classproto, num ) -&gt;
  classname = classproto.name
  [0...num].forEach -&gt;
    entdatum = class: classname, pos: randpos()
    loadent entdatum

class Goal extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @label="GOAL"
Goal::collide = ( otherent ) -&gt;
  if otherent instanceof Hero
    nextlevel()

class Platform extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @size = V 64,32
    @label="platform"
    @anchor = V 0, 1
    @t=0
  tick: () -&gt;
    if !@origpos
      @origpos = @pos.nadd 0
    @t++
    @pos.y = @origpos.y + Math.sin( @t/100 ) * 64</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Platform::collide = ( otherent ) -&gt;
 if otherent instanceof Hero
   otherent.vel.y = 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>

class HurtWire extends GenericSprite
HurtWire::size = V 8, 32
HurtWire::anchor = V 1/2, 0
HurtWire::getsprite = -&gt;
  framewait = 1
  framelist = [ "wire.png" ]
  if @state=="sparking"
    framelist = [1..4].map (n) -&gt; "wirespark#{n}.png"
  return selectframe framelist, framewait
HurtWire::tick = -&gt;
  @age = @age or 0
  @age = (@age+1)%100
  if @age &lt; 30
    @state="sparking"
  else
    @state="inert"
HurtWire::collide = ( otherent ) -&gt;
  if @state=="sparking" and otherent instanceof Hero
    otherent.takedamage()
HurtWire::render = -&gt;
  @src=@getsprite()
  super()


spawnables = burd: Burd, target: Target, jelly: Jelly,
powersuit: PowerSuit, doublejumper: DoubleJumper,
gold: Gold, energy:Energy, lila: Lila, claire: Claire, platform: Platform,
robot: Robo, robo: Robo, bee: Bee, turret: Turret, #enemies
"HurtWire": HurtWire, "Target": Target, "Jelly": Jelly, "Energy": Energy, "Gold": Gold, "Thug": Thug,
"Shrub": Shrub, goal: Goal,
noisemaker: Noisemaker

class Spawner extends PlaceholderSprite
  constructor: (@pos) -&gt;
    super @pos
    @label="Entity spawner"
    @entdata=class: Jelly, pos: @pos
Spawner::render = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>want these to be invisible except in grid view</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.grid
    removesprite @
  <span class="hljs-keyword">else</span>
    <span class="hljs-keyword">super</span>()
<span class="hljs-attribute">Spawner</span>::tick = <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>update the data so if this is moved it’ll get saved</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@entdata</span>.pos = <span class="hljs-property">@pos</span></pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>console.log @entdata.pos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@label</span> = <span class="hljs-property">@entdata</span>.class
<span class="hljs-attribute">Spawner</span>::spawn = <span class="hljs-function">-&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>ent=jame.spawn @classname
ent.load @entdata</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  loadents [<span class="hljs-property">@entdata</span>]
<span class="hljs-attribute">Spawner</span>::toJSON = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@entdata</span>


jame={}
jame.spawn = <span class="hljs-function"><span class="hljs-params">(classname)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> spawnables[classname]
    <span class="hljs-keyword">return</span>
  ent=<span class="hljs-keyword">new</span> spawnables[classname]?()
  WORLD.spritelayer.push ent
  <span class="hljs-keyword">return</span> ent
<span class="hljs-function">
<span class="hljs-title">loadent</span> = <span class="hljs-params">(entdatum)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>oh god why</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  spawner = <span class="hljs-keyword">new</span> Spawner()
  spawner.pos.x = entdatum.pos.x
  spawner.pos.y = entdatum.pos.y
  <span class="hljs-built_in">console</span>.log entdatum
  spawner.entdata = entdatum
  WORLD.spritelayer.push spawner
  ent=jame.spawn entdatum.class
  ent.load entdatum
<span class="hljs-function">
<span class="hljs-title">loadents</span> = <span class="hljs-params">(entdata)</span> -&gt;</span>
  entdata.forEach (entdatum) -&gt; loadent entdatum</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>WORLD.spritelayer.push new Goal V 64<em>24, 64</em>4
WORLD.spritelayer.push royaljel = new Jelly randpos()
WORLD.spritelayer.push hat= new Hat()
hat.src = ‘crown.png’
hat.parent=royaljel</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">WORLDINIT</span> = <span class="hljs-params">()</span> -&gt;</span>
  WORLD.entities.push <span class="hljs-keyword">new</span> Cloud()
  WORLD.entities.push <span class="hljs-keyword">new</span> Grid()
  bugmeter= <span class="hljs-keyword">new</span> BugMeter
  WORLD.entities.push bugmeter
  energymeter= <span class="hljs-keyword">new</span> EnergyMeter
  WORLD.entities.push energymeter
  WORLD.entities.push <span class="hljs-keyword">new</span> MoneyMeter
  <span class="hljs-property">@bugmeter</span> = bugmeter
  <span class="hljs-keyword">if</span> settings.hat
    WORLD.entities.push <span class="hljs-keyword">new</span> Hat()
  WORLD.bglayer.forEach (block) -&gt;
    fence=<span class="hljs-keyword">new</span> Fence
    fence.pos = relativetobox block, V(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)
    WORLD.spritelayer.push fence
    fence=<span class="hljs-keyword">new</span> Fence
    fence.pos = relativetobox block, V(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>)
    WORLD.spritelayer.push fence
  WORLD.spritelayer.push ladybug
<span class="hljs-function">
<span class="hljs-title">randtri</span> = -&gt;</span>
  <span class="hljs-keyword">new</span> Poly [ randpos(), randpos(), randpos() ]

WORLD.getallents = <span class="hljs-function">-&gt;</span>
  <span class="hljs-keyword">return</span> [].concat WORLD.entities, WORLD.spritelayer, WORLD.bglayer, WORLD.fglayer

WORLD.clear = <span class="hljs-function">-&gt;</span>
  ALLENTS = WORLD.getallents()
  renderables = ALLENTS.filter (ent) -&gt; ent <span class="hljs-keyword">instanceof</span> Renderable
  renderables.forEach (ent) -&gt; ent._pixisprite = <span class="hljs-literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>renderables.forEach (ent) -&gt; ent.removesprite()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  WORLD.entities=[]
  WORLD.spritelayer=[]
  WORLD.bglayer=[]
  WORLD.fglayer=[]
  resetstage()

roboblockdata=[]
roboblockdata.push [ -<span class="hljs-number">64</span>, <span class="hljs-number">64</span>*<span class="hljs-number">4</span>, <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">100</span> ]
roboblockdata.push [ <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">64</span>*<span class="hljs-number">5</span>, <span class="hljs-number">64</span>*<span class="hljs-number">12</span>, <span class="hljs-number">100</span> ]
<span class="hljs-function">
<span class="hljs-title">ROBOWORLD_INIT</span> = -&gt;</span>
  scatterents Burd, <span class="hljs-number">8</span>
  loadblocks roboblockdata
  WORLD.spritelayer=WORLD.spritelayer.concat [<span class="hljs-number">0.</span><span class="hljs-number">.3</span>].map -&gt;
    <span class="hljs-keyword">new</span> Robo randpos()
  WORLD.spritelayer.push randtri()
<span class="hljs-function">
<span class="hljs-title">COLLTEST_INIT</span> = -&gt;</span>
  scatterents Jelly, <span class="hljs-number">8</span>
  loadblocks roboblockdata
  WORLD.spritelayer.push randtri()</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>levelfilename = <span class="hljs-string">"levels/1.json"</span>
$.ajax levelfilename, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,status,xhr)</span> -&gt;</span>
  jsondata=JSON.parse data
  loadlevel jsondata</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">loadlevelfile</span> = <span class="hljs-params">(levelfilename)</span> -&gt;</span>
  WORLD.doneloading=<span class="hljs-literal">false</span>
  $.ajax levelfilename, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,status,xhr)</span> -&gt;</span>
    jsondata=JSON.parse data
    loadlevel jsondata
    WORLD.doneloading=<span class="hljs-literal">true</span>
    settings.paused = <span class="hljs-literal">false</span>

loadlevelfile <span class="hljs-string">"levels/"</span>+level_files[CURRENT_LEVEL]


WORLDINIT()

camera={}
jame.camera=camera
camera.offset=V()
camera.pos=V()
camera.trackingent = ladybug
camera.zoomout = <span class="hljs-function">-&gt;</span>
  scale-=<span class="hljs-number">0.1</span>
  scale = mafs.clamp scale, <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>
camera.zoomin = <span class="hljs-function">-&gt;</span>
  scale+=<span class="hljs-number">0.1</span>
  scale = mafs.clamp scale, <span class="hljs-number">0.1</span>, <span class="hljs-number">1</span>
<span class="hljs-function">
<span class="hljs-title">cameraoffset</span> = -&gt;</span>
  tmppos = camera.trackingent.pos.nadd <span class="hljs-number">0</span>
  offs = camera.trackingent.vel.vmul V <span class="hljs-number">5</span>, <span class="hljs-number">0</span>
  tmppos = tmppos.vadd offs
  tmppos.y -= <span class="hljs-number">64</span>
  tmppos = tmppos.vsub camera.offset.ndiv scale
  tmppos = tmppos.vsub screensize.ndiv <span class="hljs-number">2</span>*scale</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>return tmppos</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">return</span> camera.pos.vadd(tmppos).ndiv <span class="hljs-number">2</span>

camera.tick = <span class="hljs-function">-&gt;</span>
  camera.pos = cameraoffset()</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre>stage.updateLayersOrder = <span class="hljs-function">-&gt;</span>
  stage.children.sort (a,b) -&gt;
    a.zIndex ?= <span class="hljs-number">0</span>
    b.zIndex ?= <span class="hljs-number">0</span>
    <span class="hljs-keyword">return</span> b.zIndex-a.zIndex</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <h1 id="-">#</h1>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">render</span> = -&gt;</span>
  camera.tick()
  renderables = [].concat WORLD.bglayer, WORLD.spritelayer, [ladybug], WORLD.fglayer, WORLD.entities
  renderables.forEach (ent) -&gt; ent.render?()
  highlighted = renderables.filter (ent) -&gt; ent.HIGHLIGHT?
  <span class="hljs-keyword">if</span> settings.grid <span class="hljs-keyword">then</span> highlighted = renderables
  drawhitboxes highlighted</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>stage.updateLayersOrder()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function">
<span class="hljs-title">drawhitboxes</span> = <span class="hljs-params">( ents )</span> -&gt;</span>
  stage.removeChild hitboxlayer
  hitboxlayer = <span class="hljs-keyword">new</span> PIXI.Container
  stage.addChild hitboxlayer
  graf = <span class="hljs-keyword">new</span> PIXI.Graphics()
  graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x00ff00</span>, <span class="hljs-number">1</span>
  graf.beginFill <span class="hljs-number">0xff0000</span>, <span class="hljs-number">1</span>/<span class="hljs-number">8</span>
  ents.forEach (ent) -&gt;
    graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x00ff00</span>, <span class="hljs-number">1</span>
    graf.drawCircle ent.pos.x, ent.pos.y, <span class="hljs-number">4</span>
    box = ent.gethitbox?()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> box <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    graf.drawRect box.x, box.y, box.w, box.h
    velbox = ent.fallbox?()
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> velbox <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    graf.lineStyle <span class="hljs-number">1</span>, <span class="hljs-number">0x0000ff</span>, <span class="hljs-number">1</span>
    graf.drawRect velbox.x, velbox.y, velbox.w, velbox.h
  hitboxlayer.addChild graf</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>returns elapsed time in ms.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">timecall</span> = <span class="hljs-params">(func)</span> -&gt;</span>
  starttime = Date.now()
  func()
  Date.now()-starttime

tickwaitms = <span class="hljs-number">20</span>
skipframes = <span class="hljs-number">0</span>
ticktimes = []

WORLD.gethitbox = <span class="hljs-function"><span class="hljs-params">(sprite)</span> -&gt;</span> sprite.gethitbox()
<span class="hljs-function">
<span class="hljs-title">checkcolls</span> = <span class="hljs-params">( ent, otherents )</span> -&gt;</span>
  <span class="hljs-keyword">if</span> settings.NOCOLLS <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span></pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>bawks = ent.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  bawks = WORLD.gethitbox ent
  otherents.forEach (target) -&gt;
    <span class="hljs-keyword">if</span> target <span class="hljs-keyword">is</span> ent <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span></pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>targethitbox = target.gethitbox()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    targethitbox = WORLD.gethitbox target
    <span class="hljs-keyword">if</span> bawks.overlaps targethitbox
      target.collide?(ent)</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>remove entities that requested death</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>WORLD.euthanasia = <span class="hljs-function">-&gt;</span>
  doomedsprites = WORLD.spritelayer.filter (sprite) -&gt; sprite.KILLME?
  doomedsprites.forEach (sprite) -&gt; sprite.cleanup?()
  WORLD.spritelayer = _.difference WORLD.spritelayer, doomedsprites
<span class="hljs-function">
<span class="hljs-title">reset_tick_stats</span> = <span class="hljs-params">()</span> -&gt;</span>
  stats.collisionchecks=<span class="hljs-number">0</span>

WORLD.updateboxes = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  WORLD.BOXCACHE = []</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>JELS = ACTIVEENTS.filter (ent) -&gt; ent instanceof Jelly</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  JELS = get_sprites_of_class Jelly
  JELS = JELS.concat get_sprites_of_class Platform
  JELS.forEach (ent) =&gt;
    box = ent.gethitbox?()
    <span class="hljs-keyword">if</span> box <span class="hljs-keyword">then</span> WORLD.BOXCACHE.push box
  

WORLD.tick = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  reset_tick_stats()
  <span class="hljs-keyword">for</span> key <span class="hljs-keyword">in</span> control.heldkeys
    control.holdbindings[key]?()
  checkcolls ladybug, WORLD.spritelayer
  WORLD.spritelayer.forEach (sprite) -&gt;
    checkcolls sprite, _.without WORLD.spritelayer, sprite
  WORLD.euthanasia()
  ACTIVEENTS = [].concat WORLD.spritelayer, WORLD.entities</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>ACTIVEENTS.forEach (ent) -&gt; ent.updatehitbox?()</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
  ACTIVEENTS.forEach (ent) -&gt; ent.tick?()
  render()
  tickno++

fpscounter=$ xmltag()
tt=<span class="hljs-number">0</span>
<span class="hljs-function">
<span class="hljs-title">updateinfobox</span> = -&gt;</span>
  text= control.heldkeys.map (key) -&gt; <span class="hljs-string">"&lt;span&gt;<span class="hljs-subst">#{keyCodeToChar[key]}</span>&lt;/span&gt;"</span>
  $(infobox).html text.join <span class="hljs-string">" "</span>
<span class="hljs-function">
<span class="hljs-title">mainloop</span> = -&gt;</span>
  <span class="hljs-keyword">if</span> tickno % <span class="hljs-number">30</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
    updatesettingstable()
  updateinfobox()
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> WORLD.doneloading <span class="hljs-keyword">then</span> settings.paused = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> settings.paused
    ticktime = timecall WORLD.tick
    tt=ticktime
    fps=Math.round <span class="hljs-number">1000</span>/Math.max(tickwaitms,ticktime)
    idealfps=Math.round <span class="hljs-number">1000</span>/tickwaitms
    fpscounter.html <span class="hljs-string">"~<span class="hljs-subst">#{fps}</span>/<span class="hljs-subst">#{idealfps}</span> fps ; per tick: <span class="hljs-subst">#{tt}</span>ms"</span>
  fpsgoal = <span class="hljs-keyword">if</span> settings.slowmo <span class="hljs-keyword">then</span> <span class="hljs-number">4</span> <span class="hljs-keyword">else</span> settings.fps
  tickwaitms = <span class="hljs-number">1000</span>/fpsgoal
  setTimeout mainloop, Math.max tickwaitms-ticktime, <span class="hljs-number">1</span>
  requestAnimationFrame animate
<span class="hljs-function">
<span class="hljs-title">xmlwrap</span> = <span class="hljs-params">(tagname,body)</span> -&gt;</span>
  xmltag tagname, <span class="hljs-literal">undefined</span>, body
<span class="hljs-function">
<span class="hljs-title">maketablerow</span> = <span class="hljs-params">( values )</span> -&gt;</span>
  tds = values.map (v) -&gt; xmlwrap <span class="hljs-string">"td"</span>, v
  <span class="hljs-keyword">return</span> xmlwrap <span class="hljs-string">"tr"</span>, tds
jame.maketable = <span class="hljs-function"><span class="hljs-params">(arrofarr)</span> -&gt;</span>
  domelm = $ <span class="hljs-string">'&lt;table&gt;'</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> arrofarr
    domelm.append maketablerow v
  <span class="hljs-keyword">return</span> domelm
<span class="hljs-function">
<span class="hljs-title">selectall</span> = <span class="hljs-params">(classname)</span> -&gt;</span>
  jame.WORLD.spritelayer.filter (obj) -&gt; obj.constructor.name == classname

jame.listents = <span class="hljs-function"><span class="hljs-params">()</span> -&gt;</span>
  ents=_.pairs _.countBy jame.WORLD.spritelayer, <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span> obj.constructor.name
  body.append jame.maketable ents

infobox = $ <span class="hljs-string">"&lt;div&gt;"</span>
infobox.css <span class="hljs-attribute">float</span>: <span class="hljs-string">"right"</span>, <span class="hljs-attribute">border</span>: <span class="hljs-string">"1px solid black"</span>

body.append infobox



bindingsDOM = $ <span class="hljs-string">"&lt;table&gt;"</span>
bindingsDOMcontainer = $ <span class="hljs-string">"&lt;details&gt;"</span>
bindingsDOMcontainer.append bindingsDOM</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>for k,v of control.bindings
 bindingsDOM.append maketablerow [keyCodeToChar[k],control.bindingnames[k] or “??”]</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> control.bindingnames
  bindingsDOM.append maketablerow [keyCodeToChar[k],v <span class="hljs-keyword">or</span> <span class="hljs-string">"??"</span>]</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>tmp, fix this shit</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>_CHARbindingnames = {}
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> control.bindingnames
  _CHARbindingnames[keyCodeToChar[k]]=v

settingsDOM = $ <span class="hljs-string">"&lt;table&gt;"</span>
settingsDOMcontainer = $ <span class="hljs-string">"&lt;details&gt;"</span>
settingsDOMcontainer.append settingsDOM
<span class="hljs-function"><span class="hljs-title">updatesettingstable</span> = <span class="hljs-params">()</span> -&gt;</span>
  settingsDOM.html <span class="hljs-string">""</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> settings
    <span class="hljs-keyword">if</span> ( v <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">or</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">false</span> )
      tempv = <span class="hljs-string">"&lt;button onclick=\"jame.settings.<span class="hljs-subst">#{k}</span>=!jame.settings.<span class="hljs-subst">#{k}</span>\"&gt;<span class="hljs-subst">#{v}</span>&lt;/button&gt;"</span>
    <span class="hljs-keyword">else</span> tempv = v
    settingsDOM.append maketablerow [k,tempv]
<span class="hljs-function">
<span class="hljs-title">INIT</span> = -&gt;</span>
  body.append fpscounter
  bindingsDOMcontainer.append <span class="hljs-string">"&lt;summary&gt;bindings:&lt;/summary&gt;"</span></pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>DEPENDS ON  keyboarddisplay.js</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  body.append keyboardlayout.visualize _CHARbindingnames
  body.append bindingsDOMcontainer
  settingsDOMcontainer.append <span class="hljs-string">"&lt;summary&gt;settings:&lt;/summary&gt;"</span>
  body.append settingsDOMcontainer
  mainloop()</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>requestAnimFrame animate</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
INIT()
<span class="hljs-function">
<span class="hljs-title">adjustmouseevent</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  coffs=$(renderer.view).offset()
  adjusted = V e.pageX-coffs.left, e.pageY-coffs.top
  adjusted = adjusted.ndiv scale
  adjusted = adjusted.vadd camera.pos
  adjusted = adjusted.op Math.round
  <span class="hljs-keyword">return</span> adjusted

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Tool</span></span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>

NOOPTOOL = <span class="hljs-attribute">name</span>: <span class="hljs-string">'noop'</span>, <span class="hljs-attribute">mousedown</span>: (<span class="hljs-function">-&gt;</span>), <span class="hljs-attribute">mouseup</span>: (<span class="hljs-function">-&gt;</span>), <span class="hljs-attribute">mousemove</span>: (<span class="hljs-function">-&gt;</span>)

BLOCKCREATIONTOOL = _.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'create block'</span>
  <span class="hljs-attribute">creatingblock</span>: <span class="hljs-literal">false</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>ADD BLOCK, LEFT MBUTTON
HOLD Z TO SNAP TO GRID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    BLOCKCREATIONTOOL.creatingblock=<span class="hljs-keyword">new</span> Block adjusted.x, adjusted.y, <span class="hljs-number">32</span>, <span class="hljs-number">32</span>
    WORLD.bglayer.push BLOCKCREATIONTOOL.creatingblock
    BLOCKCREATIONTOOL.creatingblock.src = selectedtexture
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    BLOCKCREATIONTOOL.creatingblock.fixnegative()
    BLOCKCREATIONTOOL.creatingblock = <span class="hljs-literal">false</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    mpos = snapmouseadjust adjustmouseevent e
    creatingblock = BLOCKCREATIONTOOL.creatingblock
    <span class="hljs-keyword">if</span> creatingblock
      creatingblock.w = mpos.x-creatingblock.x
      creatingblock.h = mpos.y-creatingblock.y
      creatingblock.removesprite()
    <span class="hljs-keyword">if</span> ORIGCLICKPOS
      currclickpos=V e.pageX, e.pageY
      offset=currclickpos.vsub ORIGCLICKPOS
      camera.offset = offset
<span class="hljs-function">
<span class="hljs-title">snapmouseadjust_always</span> = <span class="hljs-params">(mpos)</span> -&gt;</span>
  gridsize = settings.gridsize
  mpos = mpos.ndiv(gridsize).op(Math.round).nmul(gridsize)
  <span class="hljs-keyword">return</span> mpos
<span class="hljs-function"><span class="hljs-title">snapmouseadjust_down</span> = <span class="hljs-params">(mpos)</span> -&gt;</span>
  gridsize = settings.gridsize
  mpos = mpos.ndiv(gridsize).op(Math.floor).nmul(gridsize)
  <span class="hljs-keyword">return</span> mpos
<span class="hljs-function">
<span class="hljs-title">snapmouseadjust</span> = <span class="hljs-params">(mpos)</span> -&gt;</span>
  snaptogrid = isholdingkey <span class="hljs-string">'z'</span>
  <span class="hljs-keyword">if</span> snaptogrid
    <span class="hljs-keyword">return</span> snapmouseadjust_always mpos
  <span class="hljs-keyword">return</span> mpos

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoveTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span></span>
<span class="hljs-attribute">MoveTool</span>::name = <span class="hljs-string">'move entities'</span>
<span class="hljs-attribute">MoveTool</span>::constructor = <span class="hljs-function">-&gt;</span>
  <span class="hljs-property">@selected</span> = []

<span class="hljs-attribute">MoveTool</span>::mouseup = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>p = adjustmouseevent e
@selected.forEach (ent) -&gt;
 ent.pos = p</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-property">@selected</span> = []
  setcursor <span class="hljs-string">'auto'</span>
<span class="hljs-attribute">MoveTool</span>::mousemove = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-property">@selected</span> = <span class="hljs-property">@selected</span> <span class="hljs-keyword">or</span> [] <span class="hljs-comment">#jesus christ how horrifying</span>
  isSelecting = <span class="hljs-property">@selected</span>.length &gt; <span class="hljs-number">0</span>
  p = adjustmouseevent e
  entsundercursor = getentsunderpoint p
  <span class="hljs-keyword">if</span> isSelecting
    setcursor browserprefix+<span class="hljs-string">"grabbing"</span>
  <span class="hljs-keyword">else</span>
    setcursor <span class="hljs-string">'auto'</span>
  <span class="hljs-keyword">if</span> entsundercursor.length &gt; <span class="hljs-number">0</span>
    setcursor browserprefix+<span class="hljs-string">"grab"</span>
  p = snapmouseadjust p
  <span class="hljs-property">@selected</span>.forEach (ent) -&gt;
    ent.pos = p
    ent.vel = V()
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MoveBlockTool</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Tool</span></span>
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'move blocks'</span>
  <span class="hljs-attribute">constructor</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@selected</span> = []
    <span class="hljs-property">@relpos</span> = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span>
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-property">@selected</span> = []
    setcursor <span class="hljs-string">'auto'</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    <span class="hljs-property">@selected</span> = <span class="hljs-property">@selected</span> <span class="hljs-keyword">or</span> [] <span class="hljs-comment">#jesus christ how horrifying</span>
    isSelecting = <span class="hljs-property">@selected</span>.length &gt; <span class="hljs-number">0</span>
    p = adjustmouseevent e
    p = p.vsub <span class="hljs-property">@relpos</span>
    p = snapmouseadjust p
    <span class="hljs-property">@selected</span>.forEach (ent) =&gt;
      ent.pos = p
      ent.x = p.x
      ent.y = p.y
      ent.removesprite()
<span class="hljs-attribute">MoveBlockTool</span>::mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  blocksundercursor = blocksatpoint WORLD.bglayer, p
  <span class="hljs-property">@selected</span>=blocksundercursor
  <span class="hljs-property">@relpos</span> = p.vsub <span class="hljs-property">@selected</span>[<span class="hljs-number">0</span>].pos
<span class="hljs-function">
<span class="hljs-title">getentsunderpoint</span> = <span class="hljs-params">(p)</span> -&gt;</span>
  WORLD.spritelayer.filter (ent) -&gt;
    box = ent.gethitbox?()
    <span class="hljs-keyword">return</span> box <span class="hljs-keyword">and</span> box.containspoint p

<span class="hljs-attribute">MoveTool</span>::mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  entsundercursor = getentsunderpoint p
  <span class="hljs-property">@selected</span>=entsundercursor
<span class="hljs-function">
<span class="hljs-title">setcursor</span> = <span class="hljs-params">(cursorname)</span> -&gt;</span>
  $(renderer.view).css <span class="hljs-string">'cursor'</span>, cursorname

MOVETOOL=<span class="hljs-keyword">new</span> MoveTool()
MOVETOOL.selected = []
MOVEBLOCKTOOL=<span class="hljs-keyword">new</span> MoveBlockTool()
  
tool = MOVETOOL

$(renderer.view).mousedown (e) -&gt; tool.mousedown? e
$(renderer.view).mouseup (e) -&gt; tool.mouseup? e
$(renderer.view).mousemove (e) -&gt; tool.mousemove? e
<span class="hljs-function">
<span class="hljs-title">randposrel</span> = <span class="hljs-params">(p=V())</span> -&gt;</span> p.vadd mafs.randvec().vmul V <span class="hljs-number">32</span>,<span class="hljs-number">32</span>
TRIANGLETOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"add triangle"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    triangle=<span class="hljs-keyword">new</span> Poly [ randposrel(p), randposrel(p), randposrel(p) ]
    WORLD.spritelayer.push triangle
  <span class="hljs-attribute">mouseup</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-attribute">mousemove</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>

SPAWNTOOL= <span class="hljs-attribute">name</span>: <span class="hljs-string">'Spawn entity'</span>
SPAWNTOOL.classname = <span class="hljs-string">'burd'</span>
SPAWNTOOL.mousedown = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  p = adjustmouseevent e
  ent=jame.spawn SPAWNTOOL.classname
  ent.pos = p

SPAWNTOOL.mouseup = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
SPAWNTOOL.mousemove = <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>

SPAWNERTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">'Spawn entity'</span>
  <span class="hljs-attribute">classname</span>: <span class="hljs-string">'burd'</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    WORLD.spritelayer.push ent=<span class="hljs-keyword">new</span> Spawner p
    ent.pos = p
    ent.entdata.class = SPAWNTOOL.classname
    ent.spawn()

TELEPORTTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"teleport"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    ladybug.pos = p
    ladybug.vel = V <span class="hljs-number">0</span>,<span class="hljs-number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>take a list of Block objects
return a bounding block</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">boxesbounding</span> = <span class="hljs-params">(boxlist)</span> -&gt;</span>
  ls=boxlist.map (b) -&gt; b.left()
  rs=boxlist.map (b) -&gt; b.right()
  ts=boxlist.map (b) -&gt; b.top()
  bs=boxlist.map (b) -&gt; b.bottom()
  l=ls.reduce (n,m) -&gt; Math.min n,m
  r=rs.reduce (n,m) -&gt; Math.max n,m
  t=ts.reduce (n,m) -&gt; Math.min n,m
  b=bs.reduce (n,m) -&gt; Math.max n,m
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Block l,t,r-l,b-t</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>ughhhh</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-title">blockcarve</span> = <span class="hljs-params">( aa, bb )</span> -&gt;</span>
  b = boxesbounding [ aa, bb ]
  a = aa.intersection(bb)
  x1= b.left()
  x2= a.left()
  x3= a.right()
  x4= b.right()
  y1= b.top()
  y2= a.top()
  y3= a.bottom()
  y4= b.bottom()
  blokx=[ [ x1, y1, x2-x1, y2-y1 ]
  [ x2, y1, x3-x2, y2-y1 ]
  [ x3, y1, x4-x3, y2-y1 ]
  [ x1, y2, x2-x1, y3-y2 ]
  [ x2, y2, x3-x2, y3-y2 ]
  [ x3, y2, x4-x3, y3-y2 ]
  [ x1, y3, x2-x1, y4-y3 ]
  [ x2, y3, x3-x2, y4-y3 ]
  [ x3, y3, x4-x3, y4-y3 ]
  ]
  blokx=blokx.map (blok) -&gt;
    newthing=<span class="hljs-keyword">new</span> Block blok[<span class="hljs-number">0</span>], blok[<span class="hljs-number">1</span>], blok[<span class="hljs-number">2</span>], blok[<span class="hljs-number">3</span>]
    newthing.fixnegative()
    <span class="hljs-keyword">return</span> newthing
  blokx=blokx.filter (blok) -&gt;
    blok.strictoverlaps(aa) <span class="hljs-keyword">or</span> blok.strictoverlaps(bb)</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>_.extend WORLD.bglayer, blokx</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">for</span> blok <span class="hljs-keyword">in</span> blokx
    WORLD.bglayer.push blok
<span class="hljs-function">
<span class="hljs-title">unfuck</span> = <span class="hljs-params">(p)</span> -&gt;</span>
  blocks = blocksatpoint WORLD.bglayer, p
  <span class="hljs-keyword">if</span> blocks.length == <span class="hljs-number">2</span>
    a=blocks[<span class="hljs-number">0</span>]
    b=blocks[<span class="hljs-number">1</span>]
    blockcarve a,b
    WORLD.bglayer = _.without WORLD.bglayer, a
    WORLD.bglayer = _.without WORLD.bglayer, b
    stage.removeChild a._pixisprite
    stage.removeChild b._pixisprite

UNIONTOOL=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"unfuck block overlaps"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
    p = adjustmouseevent e
    unfuck(p)
<span class="hljs-function">
<span class="hljs-title">carveoutblock</span> = <span class="hljs-params">(b)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>copy because reasons</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  block = <span class="hljs-keyword">new</span> Block b.x, b.y, b.w, b.h
  tocarve=block.allstrictoverlaps()
  <span class="hljs-keyword">for</span> bloke <span class="hljs-keyword">in</span> tocarve
    blockcarve bloke,block
  todelete=block.allstrictoverlaps()
  <span class="hljs-keyword">for</span> bloke <span class="hljs-keyword">in</span> todelete
    WORLD.bglayer = _.without WORLD.bglayer, bloke
    <span class="hljs-keyword">if</span> bloke._pixisprite?
      stage.removeChild bloke._pixisprite


CARVER=_.extend {}, NOOPTOOL,
  <span class="hljs-attribute">name</span>: <span class="hljs-string">"block carver"</span>
  <span class="hljs-attribute">mousedown</span>: <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span></pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>ADD BLOCK, LEFT MBUTTON
HOLD Z TO SNAP TO GRID</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    CARVER.creatingblock=new Block adjusted.x, adjusted.y, 32, 32
    WORLD.bglayer.push CARVER.creatingblock
  mouseup: (e) -&gt;
    if e.button != 0 then return
    CARVER.creatingblock.fixnegative()
    carveoutblock CARVER.creatingblock
    CARVER.creatingblock = false
  mousemove: (e) -&gt;
    mpos = snapmouseadjust adjustmouseevent e
    creatingblock = CARVER.creatingblock
    if creatingblock
      creatingblock.w = mpos.x-creatingblock.x
      creatingblock.h = mpos.y-creatingblock.y
      creatingblock.src="lila.png"
      creatingblock.removesprite()
    if ORIGCLICKPOS
      currclickpos=V e.pageX, e.pageY
      offset=currclickpos.vsub ORIGCLICKPOS
      camera.offset = offset

WATERTOOL=_.extend {}, NOOPTOOL,
  name: "turn block into water"
  mousedown: (e) -&gt;
    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    blocksundercursor = blocksatpoint WORLD.bglayer, adjusted
    for bl in blocksundercursor
      WORLD.spritelayer.unshift new Water bl.x, bl.y, bl.w, bl.h
      bglayer_remove_block bl

BASETOOL = _.extend {}, NOOPTOOL,
  held: {}
  mousedown: (e) -&gt;
    @held[e.button]=true
    if e.button is 0 then @leftclick adjustmouseevent e
  mouseup: (e) -&gt;
    @held[e.button]=false
  mousemove: (e) -&gt;
    if @held[0] then @lefthold adjustmouseevent e
  leftclick: (pos) -&gt;
  lefthold: (pos) -&gt;

BLOCKPAINT=_.extend {}, BASETOOL,
  name: "paint blocks"
  action: (p) -&gt;
    snapped=snapmouseadjust_down p
    blocksundercursor = blocksatpoint WORLD.bglayer, p
    if blocksundercursor.length == 0
      newblock=new Block snapped.x, snapped.y, 32, 32
      WORLD.bglayer.push newblock
      newblock.src = selectedtexture
  leftclick: (p) -&gt; @action p
  lefthold: (p) -&gt; @action p

alltools = [ MOVETOOL, TRIANGLETOOL, SPAWNERTOOL, TELEPORTTOOL ]
blocktools = [ BLOCKCREATIONTOOL, MOVEBLOCKTOOL, UNIONTOOL, CARVER, WATERTOOL, BLOCKPAINT ]

alltools.push _.extend {}, NOOPTOOL,
  name: "select entity"
  mousedown: (e) -&gt;
    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    selected=getentsunderpoint adjusted
    console.log selected[0]

alltools.push _.extend {}, NOOPTOOL,
  name: "turn block into oneway"
  mousedown: (e) -&gt;
    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    blocksundercursor = blocksatpoint WORLD.bglayer, adjusted
    for bl in blocksundercursor
      WORLD.bglayer.unshift new OnewayBlock bl.x, bl.y, bl.w, bl.h
      bglayer_remove_block bl

alltools.push _.extend {}, NOOPTOOL,
  name: "turn block into background"
  mousedown: (e) -&gt;
    if e.button != 0 then return
    adjusted = adjustmouseevent e
    adjusted=snapmouseadjust adjusted
    blocksundercursor = blocksatpoint WORLD.bglayer, adjusted
    for bl in blocksundercursor
      WORLD.entities.unshift bl
      bglayer_remove_block bl



toolbar = $ xmltag 'details', class: 'toolbar'
toolbar.append $ xmltag 'summary', undefined, 'tools'
toolbar.insertAfter $(renderer.view)
blocktools.forEach (t) -&gt;
  but=$ xmltag 'button', undefined, t.name
  but.click -&gt; tool = t
  toolbar.append but
alltools.forEach (t) -&gt;
  but=$ xmltag 'button', undefined, t.name
  but.click -&gt; tool = t
  toolbar.append but

allactions={}
@allactions = allactions

bindaction = ( key, actionname ) -&gt;
  control.keytapbindname key, actionname, allactions[actionname]
@bindaction = bindaction

readablebindings = -&gt;
  ks=_.keys control.bindingnames
  vs=_.values control.bindingnames
  ks=ks.map (k) -&gt; keyCodeToChar[Number(k)]
  return _.zip ks,vs

allactions['spawn block under hero'] = -&gt;
  p = ladybug.pos.vadd V -32, 0
  creatingblock=new Block p.x, p.y, 64, 64
  WORLD.bglayer.push creatingblock

getotherhero = -&gt;
  heroes = jame.WORLD.spritelayer.filter (ent) -&gt; ent instanceof Hero
  i = heroes.indexOf ladybug
  i = (i+1)%heroes.length
  return heroes[i]

allactions['swap character'] = -&gt;
  ladybug = getotherhero()
  camera.trackingent = ladybug

bindaction 'u', "swap character"

unzip = (data) -&gt;
  _.zip.apply _, data

allactions['export keybindings'] = -&gt;
  data=JSON.stringify readablebindings()
  window.open().document.write data
allactions['import keybindings'] = -&gt;
  rawdata=prompt 'paste data here'
  newbinds=[]
  newholdbinds=[]
  if rawdata?
    data=JSON.parse rawdata
    for k,v of data
      k = keyCharToCode[v[0]]
      v = v[1]
      console.log k,v
      func=control.bindings[k]
      if func?
        newbinds.push k: k, name: v, f:func
      func=control.holdbindings[k]
      if func?
        newholdbinds.push k: k, name: v, f:func
    
    console.log newbinds
    console.log newholdbinds
    control.bindings={}
    control.holdbindings={}
    control.bindingnames={}
    newbinds.forEach (binding) -&gt;
      control.bindings[binding.k]=binding.f
    newholdbinds.forEach (binding) -&gt;
      control.holdbindings[binding.k]=binding.f


allactions['export level'] = -&gt;
  ents=WORLD.getallents()
  spawners = ents.filter (ent) -&gt; ent instanceof Spawner
  data=ents: spawners, blockdata: WORLD.bglayer
  window.open().document.write JSON.stringify data

loadlevel = (data) -&gt;
  loadblocks data.blockdata
  loadents data.ents
  
allactions['import level'] = -&gt;
  rawdata=prompt 'paste data here'
  if rawdata?
    data=JSON.parse rawdata
    WORLD.clear()
    loadlevel data
    WORLDINIT()
    ladybug.respawn()

allactions['load .json test level'] = -&gt;
  levelfilename = "levels/2.json"
  $.ajax levelfilename, success: (data,status,xhr) -&gt;
    jsondata=JSON.parse data
    WORLD.clear()
    loadlevel jsondata
    WORLDINIT()
    ladybug.respawn()

actioncategories={silly:{}}
actioncategories.silly['evolve babb'] = -&gt;
  settings.skathi=true
actioncategories.silly['become queen of the slimes'] = -&gt;
  WORLD.spritelayer.push hat= new Hat()
  hat.src = 'crown.png'
actioncategories.silly['become queen of the cats'] = -&gt;
  WORLD.spritelayer.push hat= new Hat()
  hat.anchor = V 1/2,1/4
  hat.src = 'cheshface.png'
actioncategories.silly["toggle moonjump"] = -&gt;
  settings.moonjump = not settings.moonjump
actioncategories.silly["tiny horse"] = -&gt;
  settings.pone = not settings.pone
actioncategories["level editing"]=
  "align all blocks to grid": -&gt;
    gridsize = settings.gridsize
    for block in WORLD.bglayer
      block.x = Math.round(block.x/gridsize)*gridsize
      block.y = Math.round(block.y/gridsize)*gridsize
      block.w = Math.round(block.w/gridsize)*gridsize
      block.h = Math.round(block.h/gridsize)*gridsize
      block.removesprite()
  "spawn some dudes": -&gt;
    scatterents Jelly, 8
    scatterents Thug, 8
    scatterents Robo, 4
actioncategories["debug"]=
  "jelly stress test": -&gt;
    return if not confirm("r u sure")
    scatterents Jelly, 32

highlightoverlaps = -&gt;
  blox=WORLD.bglayer</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>alloverlaps = blox.map (b) -&gt; blox.filter (b2) -&gt; b2.overlaps b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  alloverlaps = blox.map (b) -&gt; b.alloverlaps()
  alloverlaps = alloverlaps.filter (i) -&gt; i.length &gt; <span class="hljs-number">1</span>
  flatlaps = _.flatten alloverlaps
  blox.forEach (b) -&gt; b.HIGHLIGHT = <span class="hljs-literal">undefined</span>
  flatlaps.forEach (b) -&gt; b.HIGHLIGHT = <span class="hljs-literal">true</span>

allactions[<span class="hljs-string">'highlight overlapping blocks'</span>] = highlightoverlaps
<span class="hljs-function">

<span class="hljs-title">objnames</span> = <span class="hljs-params">(objs)</span> -&gt;</span>
  objs.map (obj) -&gt; obj.constructor.name
allactions[<span class="hljs-string">'generate entity list'</span>] = <span class="hljs-function">-&gt;</span>
  entlist = $ <span class="hljs-string">"&lt;div&gt;"</span>
  body.append entlist
  entlist.html objnames(WORLD.spritelayer).join()


toolbar.append $ xmltag <span class="hljs-string">'em'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">'actions: '</span>
<span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> allactions
  but=$ xmltag <span class="hljs-string">'button'</span>, <span class="hljs-literal">undefined</span>, k
  but.click v
  toolbar.append but
<span class="hljs-keyword">for</span> ck,cv <span class="hljs-keyword">of</span> actioncategories
  toolbar.append $ xmltag <span class="hljs-string">'em'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"<span class="hljs-subst">#{ck}</span> actions: "</span>
  <span class="hljs-keyword">for</span> k,v <span class="hljs-keyword">of</span> cv
    but=$ xmltag <span class="hljs-string">'button'</span>, <span class="hljs-literal">undefined</span>, k
    but.click v
    toolbar.append but


ORIGCLICKPOS = <span class="hljs-literal">false</span>
<span class="hljs-function">
<span class="hljs-title">mousemiddledownhandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  ORIGCLICKPOS = V e.pageX, e.pageY
<span class="hljs-function"><span class="hljs-title">mousemiddleuphandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  ORIGCLICKPOS = <span class="hljs-literal">false</span>
  camera.offset = V()


$(renderer.view).mousedown mousemiddledownhandler
$(renderer.view).mouseup mousemiddleuphandler

edithistory =
  <span class="hljs-attribute">data</span>: []
  <span class="hljs-attribute">add</span>: <span class="hljs-function"><span class="hljs-params">(entry)</span> -&gt;</span>
    <span class="hljs-property">@data</span>.push entry
    <span class="hljs-built_in">console</span>.log <span class="hljs-property">@data</span>
  <span class="hljs-attribute">undo</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@data</span>.length <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
    lastevent = <span class="hljs-property">@data</span>.pop()
    [type,ent]=lastevent
    <span class="hljs-keyword">if</span> type <span class="hljs-keyword">is</span> <span class="hljs-string">"remove"</span>
      <span class="hljs-built_in">console</span>.log ent
      WORLD.bglayer.push ent
    

control.keyBindRawNamed keyCharToCode[<span class="hljs-string">'Backspace'</span>], <span class="hljs-string">'undo'</span>, <span class="hljs-function">-&gt;</span> edithistory.undo()
<span class="hljs-function">
<span class="hljs-title">bglayer_remove_block</span> = <span class="hljs-params">(ent)</span> -&gt;</span>
  edithistory.add [ <span class="hljs-string">"remove"</span>, ent ]
  WORLD.bglayer = _.without WORLD.bglayer, ent</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <p>stage.removeChild ent._pixisprite</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  removesprite ent
<span class="hljs-function">

<span class="hljs-title">tool_clickdelete</span> = <span class="hljs-params">(p)</span> -&gt;</span>
  blox=blocksatpoint WORLD.bglayer, p
  <span class="hljs-keyword">if</span> blox.length &gt; <span class="hljs-number">0</span>
    ent=blox[<span class="hljs-number">0</span>]
    bglayer_remove_block ent
<span class="hljs-function">
<span class="hljs-title">mouserightdownhandler</span> = <span class="hljs-params">(e)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> e.button != <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span>
  e.preventDefault()
  adjusted = adjustmouseevent e
  tool_clickdelete adjusted

$(renderer.view).mousedown mouserightdownhandler

$(renderer.view).contextmenu -&gt; <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-comment">#NOOP</span>

$(renderer.view).bind <span class="hljs-string">'wheel'</span>, <span class="hljs-function"><span class="hljs-params">(e)</span> -&gt;</span>
  e.preventDefault()
  delta=e.originalEvent.deltaY
  up=delta&gt;<span class="hljs-number">0</span>
  <span class="hljs-keyword">if</span> up <span class="hljs-keyword">then</span> camera.zoomout()
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> up <span class="hljs-keyword">then</span> camera.zoomin()
<span class="hljs-function">
<span class="hljs-title">lastmodified</span> = <span class="hljs-params">(date)</span> -&gt;</span>
  body.prepend <span class="hljs-string">"&lt;p&gt;last modified <span class="hljs-subst">#{jQuery.timeago(<span class="hljs-keyword">new</span> Date(date))}</span>, <span class="hljs-subst">#{date}</span>&lt;/p&gt;"</span>

$.ajax THISFILE, <span class="hljs-attribute">type</span>: <span class="hljs-string">"HEAD"</span>, <span class="hljs-attribute">success</span>: <span class="hljs-function"><span class="hljs-params">(data,satus,xhr)</span> -&gt;</span>
  lastmodified xhr.getResponseHeader <span class="hljs-string">"Last-Modified"</span>

root = exports ? <span class="hljs-keyword">this</span>


spawnselection = $ xmltag <span class="hljs-string">'select'</span>
<span class="hljs-keyword">for</span> classname <span class="hljs-keyword">of</span> spawnables
  spawnselection.append $ xmltag <span class="hljs-string">'option'</span>, <span class="hljs-attribute">value</span>: classname, classname
toolbar.append $ xmltag <span class="hljs-string">'em'</span>, <span class="hljs-literal">undefined</span>, <span class="hljs-string">"entity class:"</span>
toolbar.append spawnselection
spawnselection.change (e) -&gt;
  SPAWNTOOL.classname = $(@).val()
  
jame.WORLD = WORLD

jame.control = control
jame.stats = stats
jame.settings = settings

root.jame = jame
root.stage = stage


<span class="hljs-attribute">Block</span>::allstrictoverlaps = <span class="hljs-function">-&gt;</span>
  blox=WORLD.bglayer
  <span class="hljs-keyword">return</span> blox.filter (otherblock) =&gt; <span class="hljs-property">@strictoverlaps</span> otherblock
<span class="hljs-attribute">Block</span>::alloverlaps = <span class="hljs-function">-&gt;</span>
  blox=WORLD.bglayer
  <span class="hljs-keyword">return</span> blox.filter (otherblock) =&gt; <span class="hljs-property">@overlaps</span> otherblock
<span class="hljs-attribute">Block</span>::equals = <span class="hljs-function"><span class="hljs-params">(b)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> <span class="hljs-property">@x</span>=b.x <span class="hljs-keyword">and</span> <span class="hljs-property">@y</span>=b.y <span class="hljs-keyword">and</span> <span class="hljs-property">@w</span>=b.w <span class="hljs-keyword">and</span> <span class="hljs-property">@h</span>=b.h

jame.cleanobj = <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
  arr= ( [key,val] <span class="hljs-keyword">for</span> own key,val <span class="hljs-keyword">of</span> obj)
  <span class="hljs-keyword">return</span> _.object arr

selectedtexture = <span class="hljs-comment">#</span>

blockpalette = [ <span class="hljs-string">"genbrick"</span>, <span class="hljs-string">"genblackrocks"</span>, <span class="hljs-string">"groundtile"</span>, <span class="hljs-string">"redtile"</span>, <span class="hljs-string">"genice"</span> ]
<span class="hljs-function"><span class="hljs-title">urlify</span> = <span class="hljs-params">(str)</span> -&gt;</span> <span class="hljs-string">"url(<span class="hljs-subst">#{sourcebaseurl}</span><span class="hljs-subst">#{str}</span>.png)"</span>
$blockpal = $ <span class="hljs-string">"&lt;div&gt;"</span>
blockpalette.forEach (tex) -&gt;
  buton = $ <span class="hljs-string">"&lt;button&gt;"</span>
  buton.css <span class="hljs-attribute">width</span>: <span class="hljs-number">64</span>, <span class="hljs-attribute">height</span>: <span class="hljs-number">64</span>
  buton.css <span class="hljs-string">"background-image"</span>, urlify tex
  buton.click -&gt;
    selectedtexture = tex+<span class="hljs-string">".png"</span>
  $blockpal.append buton
$blockpal.insertBefore renderer.view
$blockpal.css <span class="hljs-attribute">width</span>: <span class="hljs-number">90</span>, <span class="hljs-attribute">display</span>: <span class="hljs-string">"inline-block"</span>, <span class="hljs-attribute">height</span>: screensize.y, <span class="hljs-string">"overflow-y"</span>: <span class="hljs-string">"scroll"</span>, <span class="hljs-attribute">background</span>: <span class="hljs-string">"beige"</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
